{"filter":false,"title":"claimed-orders.php","tooltip":"/adminPages/claimed_orders/claimed-orders.php","undoManager":{"mark":100,"position":100,"stack":[[{"start":{"row":236,"column":11},"end":{"row":236,"column":12},"action":"insert","lines":["("],"id":578}],[{"start":{"row":236,"column":12},"end":{"row":236,"column":13},"action":"insert","lines":["i"],"id":579}],[{"start":{"row":236,"column":13},"end":{"row":236,"column":14},"action":"insert","lines":["n"],"id":580}],[{"start":{"row":236,"column":14},"end":{"row":236,"column":15},"action":"insert","lines":["t"],"id":581}],[{"start":{"row":236,"column":15},"end":{"row":236,"column":16},"action":"insert","lines":[")"],"id":582}],[{"start":{"row":236,"column":32},"end":{"row":236,"column":33},"action":"insert","lines":[" "],"id":583}],[{"start":{"row":236,"column":33},"end":{"row":236,"column":34},"action":"insert","lines":["!"],"id":584}],[{"start":{"row":236,"column":34},"end":{"row":236,"column":35},"action":"insert","lines":["="],"id":585}],[{"start":{"row":236,"column":35},"end":{"row":236,"column":36},"action":"insert","lines":[" "],"id":586}],[{"start":{"row":236,"column":36},"end":{"row":236,"column":37},"action":"insert","lines":["0"],"id":587}],[{"start":{"row":236,"column":37},"end":{"row":236,"column":38},"action":"insert","lines":[" "],"id":588}],[{"start":{"row":236,"column":37},"end":{"row":236,"column":38},"action":"remove","lines":[" "],"id":589}],[{"start":{"row":236,"column":37},"end":{"row":236,"column":38},"action":"insert","lines":[")"],"id":590}],[{"start":{"row":236,"column":38},"end":{"row":236,"column":39},"action":"insert","lines":[" "],"id":591}],[{"start":{"row":236,"column":39},"end":{"row":236,"column":40},"action":"insert","lines":["{"],"id":592}],[{"start":{"row":236,"column":39},"end":{"row":236,"column":40},"action":"remove","lines":["{"],"id":593}],[{"start":{"row":236,"column":38},"end":{"row":236,"column":39},"action":"remove","lines":[" "],"id":594}],[{"start":{"row":236,"column":38},"end":{"row":236,"column":39},"action":"insert","lines":["{"],"id":595}],[{"start":{"row":236,"column":39},"end":{"row":238,"column":8},"action":"insert","lines":["","\t\t\t\t\t\t\t\t","\t\t\t\t\t\t\t}"],"id":596}],[{"start":{"row":239,"column":7},"end":{"row":239,"column":97},"action":"remove","lines":["echo \"此单已超量<span style='color: red; font-size:20px'>\". $qtyLeftExceeded . \"</span>单！<br>\";"],"id":597}],[{"start":{"row":237,"column":8},"end":{"row":237,"column":98},"action":"insert","lines":["echo \"此单已超量<span style='color: red; font-size:20px'>\". $qtyLeftExceeded . \"</span>单！<br>\";"],"id":598}],[{"start":{"row":238,"column":8},"end":{"row":238,"column":9},"action":"insert","lines":[" "],"id":599}],[{"start":{"row":238,"column":9},"end":{"row":238,"column":10},"action":"insert","lines":["e"],"id":600}],[{"start":{"row":238,"column":10},"end":{"row":238,"column":11},"action":"insert","lines":["l"],"id":601}],[{"start":{"row":238,"column":11},"end":{"row":238,"column":12},"action":"insert","lines":["s"],"id":602}],[{"start":{"row":238,"column":12},"end":{"row":238,"column":13},"action":"insert","lines":["e"],"id":603}],[{"start":{"row":238,"column":13},"end":{"row":238,"column":14},"action":"insert","lines":[" "],"id":604}],[{"start":{"row":238,"column":14},"end":{"row":238,"column":15},"action":"insert","lines":["{"],"id":605}],[{"start":{"row":238,"column":15},"end":{"row":240,"column":8},"action":"insert","lines":["","\t\t\t\t\t\t\t\t","\t\t\t\t\t\t\t}"],"id":606}],[{"start":{"row":241,"column":6},"end":{"row":241,"column":7},"action":"remove","lines":["\t"],"id":607}],[{"start":{"row":241,"column":5},"end":{"row":241,"column":6},"action":"remove","lines":["\t"],"id":608}],[{"start":{"row":241,"column":4},"end":{"row":241,"column":5},"action":"remove","lines":["\t"],"id":609}],[{"start":{"row":241,"column":3},"end":{"row":241,"column":4},"action":"remove","lines":["\t"],"id":610}],[{"start":{"row":241,"column":2},"end":{"row":241,"column":3},"action":"remove","lines":["\t"],"id":611}],[{"start":{"row":241,"column":1},"end":{"row":241,"column":2},"action":"remove","lines":["\t"],"id":612}],[{"start":{"row":241,"column":0},"end":{"row":241,"column":1},"action":"remove","lines":["\t"],"id":613}],[{"start":{"row":240,"column":8},"end":{"row":241,"column":0},"action":"remove","lines":["",""],"id":614}],[{"start":{"row":239,"column":8},"end":{"row":239,"column":98},"action":"insert","lines":["echo \"此单已超量<span style='color: red; font-size:20px'>\". $qtyLeftExceeded . \"</span>单！<br>\";"],"id":615}],[{"start":{"row":239,"column":14},"end":{"row":239,"column":19},"action":"remove","lines":["此单已超量"],"id":616},{"start":{"row":239,"column":14},"end":{"row":239,"column":15},"action":"insert","lines":["c"]}],[{"start":{"row":239,"column":14},"end":{"row":239,"column":15},"action":"remove","lines":["c"],"id":617}],[{"start":{"row":239,"column":14},"end":{"row":239,"column":16},"action":"insert","lines":["此单"],"id":623}],[{"start":{"row":239,"column":15},"end":{"row":239,"column":16},"action":"remove","lines":["单"],"id":624}],[{"start":{"row":239,"column":14},"end":{"row":239,"column":15},"action":"remove","lines":["此"],"id":625}],[{"start":{"row":239,"column":14},"end":{"row":239,"column":16},"action":"insert","lines":["注意"],"id":631}],[{"start":{"row":239,"column":16},"end":{"row":239,"column":17},"action":"insert","lines":["！"],"id":632}],[{"start":{"row":239,"column":17},"end":{"row":239,"column":19},"action":"insert","lines":["此单"],"id":638}],[{"start":{"row":239,"column":19},"end":{"row":239,"column":20},"action":"insert","lines":["在"],"id":642}],[{"start":{"row":239,"column":20},"end":{"row":239,"column":22},"action":"insert","lines":["还未"],"id":648}],[{"start":{"row":239,"column":21},"end":{"row":239,"column":22},"action":"remove","lines":["未"],"id":649}],[{"start":{"row":239,"column":20},"end":{"row":239,"column":21},"action":"remove","lines":["还"],"id":650}],[{"start":{"row":239,"column":20},"end":{"row":239,"column":22},"action":"insert","lines":["此时"],"id":656}],[{"start":{"row":239,"column":22},"end":{"row":239,"column":23},"action":"insert","lines":["（"],"id":657}],[{"start":{"row":239,"column":23},"end":{"row":239,"column":24},"action":"insert","lines":["未"],"id":661}],[{"start":{"row":239,"column":24},"end":{"row":239,"column":26},"action":"insert","lines":["批准"],"id":668}],[{"start":{"row":239,"column":26},"end":{"row":239,"column":28},"action":"insert","lines":["任何"],"id":674}],[{"start":{"row":239,"column":28},"end":{"row":239,"column":30},"action":"insert","lines":["底单"],"id":680}],[{"start":{"row":239,"column":29},"end":{"row":239,"column":30},"action":"remove","lines":["单"],"id":681}],[{"start":{"row":239,"column":28},"end":{"row":239,"column":29},"action":"remove","lines":["底"],"id":682}],[{"start":{"row":239,"column":27},"end":{"row":239,"column":28},"action":"remove","lines":["何"],"id":683}],[{"start":{"row":239,"column":26},"end":{"row":239,"column":27},"action":"remove","lines":["任"],"id":684}],[{"start":{"row":239,"column":25},"end":{"row":239,"column":26},"action":"remove","lines":["准"],"id":685}],[{"start":{"row":239,"column":24},"end":{"row":239,"column":25},"action":"remove","lines":["批"],"id":686}],[{"start":{"row":239,"column":23},"end":{"row":239,"column":24},"action":"remove","lines":["未"],"id":687}],[{"start":{"row":239,"column":22},"end":{"row":239,"column":23},"action":"remove","lines":["（"],"id":688}],[{"start":{"row":239,"column":22},"end":{"row":239,"column":24},"action":"insert","lines":["此刻"],"id":693}],[{"start":{"row":239,"column":23},"end":{"row":239,"column":24},"action":"remove","lines":["刻"],"id":694}],[{"start":{"row":239,"column":22},"end":{"row":239,"column":23},"action":"remove","lines":["此"],"id":695}],[{"start":{"row":239,"column":21},"end":{"row":239,"column":22},"action":"remove","lines":["时"],"id":696}],[{"start":{"row":239,"column":20},"end":{"row":239,"column":21},"action":"remove","lines":["此"],"id":697}],[{"start":{"row":239,"column":19},"end":{"row":239,"column":20},"action":"remove","lines":["在"],"id":698}],[{"start":{"row":239,"column":19},"end":{"row":239,"column":20},"action":"insert","lines":["已"],"id":701}],[{"start":{"row":239,"column":20},"end":{"row":239,"column":22},"action":"insert","lines":["正好"],"id":710}],[{"start":{"row":239,"column":22},"end":{"row":239,"column":25},"action":"insert","lines":["手慢了"],"id":720}],[{"start":{"row":239,"column":24},"end":{"row":239,"column":25},"action":"remove","lines":["了"],"id":721}],[{"start":{"row":239,"column":23},"end":{"row":239,"column":24},"action":"remove","lines":["慢"],"id":722}],[{"start":{"row":239,"column":22},"end":{"row":239,"column":23},"action":"remove","lines":["手"],"id":723}],[{"start":{"row":239,"column":22},"end":{"row":239,"column":26},"action":"insert","lines":["收满淡了"],"id":735}],[{"start":{"row":239,"column":25},"end":{"row":239,"column":26},"action":"remove","lines":["了"],"id":736}],[{"start":{"row":239,"column":24},"end":{"row":239,"column":25},"action":"remove","lines":["淡"],"id":737}],[{"start":{"row":239,"column":24},"end":{"row":239,"column":25},"action":"insert","lines":["了"],"id":740}],[{"start":{"row":239,"column":25},"end":{"row":239,"column":26},"action":"insert","lines":["！"],"id":741}],[{"start":{"row":239,"column":26},"end":{"row":239,"column":67},"action":"remove","lines":["<span style='color: red; font-size:20px'>"],"id":742}],[{"start":{"row":239,"column":20},"end":{"row":239,"column":61},"action":"insert","lines":["<span style='color: red; font-size:20px'>"],"id":743}],[{"start":{"row":239,"column":67},"end":{"row":239,"column":90},"action":"remove","lines":["\". $qtyLeftExceeded . \""],"id":744}],[{"start":{"row":239,"column":75},"end":{"row":239,"column":76},"action":"remove","lines":["！"],"id":745}],[{"start":{"row":239,"column":74},"end":{"row":239,"column":75},"action":"remove","lines":["单"],"id":746}],[{"start":{"row":56,"column":0},"end":{"row":57,"column":0},"action":"remove","lines":["\t\t\t\t\t\t\t\techo \"此单已超量<span style='color: red; font-size:20px'>\". $qtyLeftExceeded . \"</span>单！<br>\";",""],"id":747},{"start":{"row":56,"column":0},"end":{"row":60,"column":8},"action":"insert","lines":["if ((int)$qtyLeftExceeded != 0){","\t\t\t\t\t\t\t\techo \"此单已超量<span style='color: red; font-size:20px'>\". $qtyLeftExceeded . \"</span>单！<br>\";","\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\techo \"注意！此单已<span style='color: red; font-size:20px'>正好收满了！</span><br>\";","\t\t\t\t\t\t\t}"]}],[{"start":{"row":57,"column":0},"end":{"row":57,"column":1},"action":"insert","lines":["\t"],"id":748},{"start":{"row":58,"column":0},"end":{"row":58,"column":1},"action":"insert","lines":["\t"]},{"start":{"row":59,"column":0},"end":{"row":59,"column":1},"action":"insert","lines":["\t"]},{"start":{"row":60,"column":0},"end":{"row":60,"column":1},"action":"insert","lines":["\t"]}],[{"start":{"row":56,"column":0},"end":{"row":56,"column":1},"action":"insert","lines":["\t"],"id":749}],[{"start":{"row":56,"column":1},"end":{"row":56,"column":2},"action":"insert","lines":["\t"],"id":750}],[{"start":{"row":56,"column":2},"end":{"row":56,"column":3},"action":"insert","lines":["\t"],"id":751}],[{"start":{"row":56,"column":3},"end":{"row":56,"column":4},"action":"insert","lines":["\t"],"id":752}],[{"start":{"row":56,"column":4},"end":{"row":56,"column":5},"action":"insert","lines":["\t"],"id":753}],[{"start":{"row":56,"column":5},"end":{"row":56,"column":6},"action":"insert","lines":["\t"],"id":754}],[{"start":{"row":56,"column":6},"end":{"row":56,"column":7},"action":"insert","lines":["\t"],"id":755}],[{"start":{"row":56,"column":7},"end":{"row":56,"column":8},"action":"insert","lines":["\t"],"id":756}],[{"start":{"row":60,"column":17},"end":{"row":61,"column":0},"action":"insert","lines":["",""],"id":757},{"start":{"row":61,"column":0},"end":{"row":61,"column":8},"action":"insert","lines":["\t\t\t\t\t\t\t\t"]}],[{"start":{"row":436,"column":52},"end":{"row":436,"column":56},"action":"remove","lines":["请求数量"],"id":758},{"start":{"row":436,"column":52},"end":{"row":436,"column":58},"action":"insert","lines":["等待下单数量"]}],[{"start":{"row":0,"column":0},"end":{"row":482,"column":2},"action":"remove","lines":["<?php","","\tsession_start();","","\tfunction makeLink($url)","\t{","\t\treturn (\"<a href=\" . $url . \" target='_blank'>\" . $url . \"</a>\");","\t}","","\t$pdo = new PDO('mysql:host=localhost;dbname=chenh057_realPro', 'chenh057_hang01', 'bhgoszPg7iBcYD8WLAjeWrjEcH3LUcE96vHqCdGKnpNWZetxe', array(","\t    PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,","\t    PDO::ATTR_EMULATE_PREPARES => false","\t));","","\t$pdo->beginTransaction();","\t","\ttry{","\t\t","\t\t//http://stackoverflow.com/questions/43478069/best-way-to-identify-a-mysql-changed-group-by-field-value-in-a-statement-fetch","\t\t// My question","\t\t$sql = \"SELECT * FROM orderTaken WHERE orderStatus='10' ORDER BY orderId DESC, orderTakenTime DESC\";","\t\t$stmt = $pdo->prepare($sql);","\t    $stmt->execute();","\t    $count = $stmt->rowCount();","\t    if ($count > 0){","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='nurse-requested' class='nav-link'>以下为护士报数的单子，请依情况执行操作。</a></h3>\";","\t    \tfor ($i = 0; $i < $count + 1; $i++){","\t\t\t\tif ($row = $stmt->fetch()){","\t\t\t\t\t$orderId = $row[\"orderId\"];","\t\t\t\t\t$qtyRequested = $row[\"qtyTaken\"];","\t\t\t\t\t$requestedTime = $row[\"lastModifiedTime\"];","\t\t\t\t\t$orderTakenId = $row[\"orderTakenId\"];","\t\t\t\t\t//$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\tif (isset($oldOrderId)){","\t\t\t\t\t\tif ($oldOrderId != $orderId){","\t\t\t\t\t\t\t/*","\t\t\t\t\t\t\techo \"看看\" . $oldOrderId;","\t\t\t\t\t\t\techo \"NEWNEW\";*/","\t\t\t\t\t\t\techo \"</table><br>\";","\t\t\t\t\t\t\t//echo \"NEWNEW2\";","\t\t\t\t\t\t\techo \"共���求数量：\" . $totalQtyRequested . \"<br>\";","\t\t\t\t\t\t\tif ($isFull == false){","\t\t\t\t\t\t\t\t//$qtyLeftNeededNew = (int)($totalQty) - ((int)($totalQtyRequested) + (int)($totalQtyTaken));","\t\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)$qtyLeft - (int)($totalQtyRequested);","\t\t\t\t\t\t\t\tif ($qtyLeftNeededNew > 0){","\t\t\t\t\t\t\t\t\techo \"若全部批准，此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeededNew . \"</span>单。<br></div>\";","\t\t\t\t\t\t\t\t} else if ($qtyLeftNeededNew == 0){","\t\t\t\t\t\t\t\t\techo \"若全部批准，此单正好收全。<br></div>\";","\t\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)$qtyLeftNeededNew * (-1);","\t\t\t\t\t\t\t\t\techo \"注意！若全部批准，此单将<span style='color: red; font-size:20px'>超量\" . $qtyLeftNeededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t\t\t}","\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\t//$qtyLeftExceeded = (int)($totalQtyTaken) - (int)($totalQty);","\t\t\t\t\t\t\t\t$qtyLeftExceeded = (int)$qtyLeft * (-1);","\t\t\t\t\t\t\t\t$qtyLeftExceededNew = (int)($totalQtyRequested) + (int)($qtyLeftExceeded);","\t\t\t\t\t\t\t\tif ((int)$qtyLeftExceeded != 0){","\t\t\t\t\t\t\t\t\techo \"此单已超量<span style='color: red; font-size:20px'>\". $qtyLeftExceeded . \"</span>单！<br>\";","\t\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\t\techo \"注意！此单已<span style='color: red; font-size:20px'>正好收满了！</span><br>\";","\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t","\t\t\t\t\t\t\t\techo \"若全部批准，此单将<span style='color: red; font-size:20px'>总超量\" . $qtyLeftExceededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t\t}","\t\t\t\t\t\t\t$totalQtyRequested = 0;","\t\t\t\t\t\t\t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t\t\t//echo \"前Sequence\" . $orderIdChangeSequence;","\t\t\t\t\t\t\t$orderIdChangeSequence++;","\t\t\t\t\t\t\t//echo \"后Sequence\" . $orderIdChangeSequence;","\t\t\t\t\t\t\techo \"<div orderSequenceNum='$orderIdChangeSequence'>单子：\" . $orderIdChangeSequence . \"<br>\";","\t\t\t\t\t\t\t$sql2 = \"SELECT * FROM orders WHERE orderId='$orderId'\";","\t\t\t\t\t\t\t$stmt2 = $pdo->prepare($sql2);","\t\t\t\t\t    \t$stmt2->execute();","\t\t\t\t\t    \tif($row2 = $stmt2->fetch()){","\t\t\t\t\t    \t\t$itemName = $row2[\"itemName\"];","\t\t\t\t\t    \t\t$itemLink = makeLink($row2[\"itemLink\"]);","\t\t\t\t\t    \t\t$itemCost = $row2[\"itemCost\"];","\t\t\t\t\t    \t\t$itemReceivingPrice = $row2[\"itemReceivingPrice\"];","\t\t\t\t\t    \t\t$totalQty = $row2[\"totalQty\"];","\t\t\t\t\t    \t\t$totalQtyTaken = $row2[\"totalQtyTaken\"];","\t\t\t\t\t    \t\t$qtyLeft = $row2[\"qtyLeft\"];","\t\t\t\t\t    \t\t$creationTime = $row2[\"creationTime\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \t$orderInfoGeneral = \"货名: \" . $itemName . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"链接: \" . $itemLink . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"单价: \" . $itemCost . \"<br>\" .","\t\t\t\t\t\t    \t\t\t\t\t\"收价: \" . $itemReceivingPrice . \"<br>\" . ","\t\t\t\t\t\t\t\t\t\t\t\t\"订单建立时间\" . $creationTime . \"<br>\" .","\t\t\t\t\t\t\t\t\t\t\t\t\"目标收货数量\" . $totalQty . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"护士已下数量\" . $totalQtyTaken . \"<br>\";","\t\t\t\t\t    \t//if ((int)($totalQtyTaken) >= (int)($totalQty)) {","\t\t\t\t\t    \tif ($qtyLeft <= 0) {","\t\t\t\t\t    \t\t$isFull = true;","\t\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>注意，此单已收满！</span><br>\";","\t\t\t\t\t    \t} else {","\t\t\t\t\t    \t\t$isFull = false;","\t\t\t\t\t    \t\t//$qtyLeftNeeded = (int)($totalQty) - (int)($totalQtyTaken);","\t\t\t\t\t    \t\t//echo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeeded . \"</span>单。<br>\";","\t\t\t\t\t    \t\techo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeft . \"</span>单。<br>\";","\t\t\t\t\t    \t}","\t\t\t\t\t    \t//echo \"DEBUG 1\";","\t\t\t\t\t    \techo \"<table><tr><th>护士</th><th>QQ</th><th>请求数量</th><th>请求时间</th><th>批准</th><th>修改并批数量</th><th>拒绝</th></tr>\";","\t\t\t\t\t    \t//echo \"FUCK\";","\t\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t\t    \t$stmt3->execute();","\t\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td><td>\" .","\t\t\t\t\t    \t\"<button class='accept-qty-btn' data-accept-orderTakenId='$orderTakenId' data-accept-qtyRequested='$qtyRequested' data-accept-qty-orderId='$orderId'>批</button>\" . \"</td><td>\" .","\t\t\t\t\t    \t\"<button class='accept-change-qty-btn' data-accept-change-qty-orderTakenId='$orderTakenId' data-accept-change-qty-userName='$userName' data-accept-change-qty-orderId='$orderId' data-accept-change-qty-qtyLeft='$qtyLeft'>改并批</button>\" . \"</td><td>\" .","\t\t\t\t\t    \t\"<button class='reject-qty-btn' data-reject-orderTakenId='$orderTakenId' data-reject-userName='$userName'>拒</button>\" . \"</td></tr>\";","\t\t\t\t\t    \t//echo \"不一样前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    \t$oldOrderId = $orderId;","\t\t\t\t\t    \t//echo \"不一样后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    //$oldOrderId == $orderId","\t\t\t\t\t    } else {","\t\t\t\t\t    \t//echo \"SAME\";","\t\t\t\t\t    \t//若一样则继续print","\t\t\t\t\t    \t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t\t    \t$stmt3->execute();","\t\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \t//echo \"SAME YEA\";","\t\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td><td>\" .","\t\t\t\t\t    \t\"<button class='accept-qty-btn' data-accept-orderTakenId='$orderTakenId' data-accept-qtyRequested='$qtyRequested' data-accept-qty-orderId='$orderId'>批</button>\" . \"</td><td>\" .","\t\t\t\t\t    \t\"<button class='accept-change-qty-btn' data-accept-change-qty-orderTakenId='$orderTakenId' data-accept-change-qty-userName='$userName' data-accept-change-qty-orderId='$orderId' data-accept-change-qty-qtyLeft='$qtyLeft'>改并批</button>\" . \"</td><td>\" .","\t\t\t\t\t    \t\"<button class='reject-qty-btn' data-reject-orderTakenId='$orderTakenId' data-reject-userName='$userName'>拒</button>\" . \"</td></tr>\";","\t\t\t\t\t    \t//echo \"一样前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    \t$oldOrderId = $orderId;","\t\t\t\t\t    \t//echo \"一样后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    }","\t\t\t\t\t} else {","\t\t\t\t\t\t//echo \"XIN\";","\t\t\t\t\t\t//全新","\t\t\t\t\t\t// 检查应该是无误了 041917 101920am 3E","\t\t\t\t\t\t$orderIdChangeSequence = 0;","\t\t\t\t\t\t$totalQtyRequested = 0;","\t\t\t\t\t\t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t\t$orderIdChangeSequence++;","\t\t\t\t\t\techo \"<div orderSequenceNum='$orderIdChangeSequence'>单子：\" . $orderIdChangeSequence . \"<br>\";","\t\t\t\t\t\t$sql2 = \"SELECT * FROM orders WHERE orderId='$orderId'\";","\t\t\t\t\t\t$stmt2 = $pdo->prepare($sql2);","\t\t\t\t    \t$stmt2->execute();","\t\t\t\t    \tif($row2 = $stmt2->fetch()){","\t\t\t\t    \t\t$itemName = $row2[\"itemName\"];","\t\t\t\t    \t\t$itemLink = makeLink($row2[\"itemLink\"]);","\t\t\t\t    \t\t$itemCost = $row2[\"itemCost\"];","\t\t\t\t    \t\t$itemReceivingPrice = $row2[\"itemReceivingPrice\"];","\t\t\t\t    \t\t$totalQty = $row2[\"totalQty\"];","\t\t\t\t    \t\t$totalQtyTaken = $row2[\"totalQtyTaken\"];","\t\t\t\t    \t\t$qtyLeft = $row2[\"qtyLeft\"];","\t\t\t\t    \t\t$creationTime = $row2[\"creationTime\"];","\t\t\t\t    \t}","\t\t\t\t    \t$orderInfoGeneral = \"货名: \" . $itemName . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"链接: \" . $itemLink . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"单价: \" . $itemCost . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\"收价: \" . $itemReceivingPrice . \"<br>\" . ","\t\t\t\t\t\t\t\t\t\t\t\"订单建立时间\" . $creationTime . \"<br>\" .","\t\t\t\t\t\t\t\t\t\t\t\"目标收货数量\" . $totalQty . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"护士已下数量\" . $totalQtyTaken . \"<br>\";","\t\t\t\t    \t//if ((int)($totalQtyTaken) >= (int)($totalQty)) {","\t\t\t\t    \tif ($qtyLeft <= 0) {","\t\t\t\t    \t\t$isFull = true;","\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>注意，此单已收满！</span><br>\";","\t\t\t\t    \t} else {","\t\t\t\t    \t\t$isFull = false;","\t\t\t\t    \t\t//$qtyLeftNeeded = (int)($totalQty) - (int)($totalQtyTaken);","\t\t\t\t    \t\techo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeft . \"</span>单。<br>\";","\t\t\t\t    \t}","\t\t\t\t    \t/*echo \"DEBUG2\";","\t\t\t\t    \techo \"oldOrderId第一次：\";","\t\t\t\t    \techo $oldOrderId;","\t\t\t\t    \techo \"CAONIMA0\";*/","\t\t\t\t    \techo \"<table><tr><th>护士</th><th>QQ</th><th>请求数量</th><th>请求时间</th><th>批准</th><th>修改并批数量</th><th>拒绝</th></tr>\";","\t\t\t\t    \t//echo \"CAONIMA\";","\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t    \t$stmt3->execute();","\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t    \t}","\t\t\t\t    \t//echo \"CAONIMA2\";","\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td><td>\" .","\t\t\t\t    \t\"<button class='accept-qty-btn' data-accept-orderTakenId='$orderTakenId' data-accept-qtyRequested='$qtyRequested' data-accept-qty-orderId='$orderId'>批</button>\" . \"</td><td>\" .","\t\t\t\t    \t\"<button class='accept-change-qty-btn' data-accept-change-qty-orderTakenId='$orderTakenId' data-accept-change-qty-userName='$userName' data-accept-change-qty-orderId='$orderId' data-accept-change-qty-qtyLeft='$qtyLeft'>改并批</button>\" . \"</td><td>\" .","\t\t\t\t    \t\"<button class='reject-qty-btn' data-reject-orderTakenId='$orderTakenId' data-reject-userName='$userName'>拒</button>\" . \"</td></tr>\";","\t\t\t\t    \t//echo \"CAONIMA3\";","\t\t\t\t    \t//echo \"前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t    \t$oldOrderId = $orderId;","\t\t\t\t    \t//echo \"后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t}","\t\t\t\t}","\t\t\t\t//echo \"i是\" . $i . \"count是\" . $count . \"<br>\";","\t\t\t\t// 没显示","\t\t\t\tif ($i == $count){","\t\t\t\t\t//echo \"进来哦？？\";","\t\t\t\t\tif (isset($totalQtyRequested)){","\t\t\t\t\t\t//echo \"进来呀？\";","\t\t\t\t\t\techo \"</table><br>\";","\t\t\t\t\t\t//echo \"LAST共请求数量：\" . $totalQtyRequested . \"<br>\";","\t\t\t\t\t\techo \"共请求数量：\" . $totalQtyRequested . \"<br>\";","\t\t\t\t\t\tif ($isFull == false){","\t\t\t\t\t\t\t/*","\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)($totalQty) - ((int)($totalQtyRequested) + (int)($totalQtyTaken));","\t\t\t\t\t\t\tif ($qtyLeftNeededNew > 0){","\t\t\t\t\t\t\t\techo \"若全部批准，此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeededNew . \"</span>单。<br></div>\";","\t\t\t\t\t\t\t} else if ($qtyLeftNeededNew == 0){","\t\t\t\t\t\t\t\techo \"若全部批准，此单正好收全。<br></div>\";","\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)$qtyLeftNeededNew * (-1);","\t\t\t\t\t\t\t\techo \"注意！若全部批准，此单将<span style='color: red; font-size:20px'>超量\" . $qtyLeftNeededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t\t}*/","\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)$qtyLeft - (int)($totalQtyRequested);","\t\t\t\t\t\t\tif ($qtyLeftNeededNew > 0){","\t\t\t\t\t\t\t\techo \"若全部批准，此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeededNew . \"</span>单。<br></div>\";","\t\t\t\t\t\t\t} else if ($qtyLeftNeededNew == 0){","\t\t\t\t\t\t\t\techo \"若全部批准，此单正好收全。<br></div>\";","\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)$qtyLeftNeededNew * (-1);","\t\t\t\t\t\t\t\techo \"注意！若全部批准，此单将<span style='color: red; font-size:20px'>超量\" . $qtyLeftNeededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t\t}","","\t\t\t\t\t\t} else {/*","\t\t\t\t\t\t\t$qtyLeftExceeded = (int)($totalQtyTaken) - (int)($totalQty);","\t\t\t\t\t\t\t$qtyLeftExceededNew = (int)($totalQtyRequested) + (int)($qtyLeftExceeded);","\t\t\t\t\t\t\techo \"此单已超量<span style='color: red; font-size:20px'>\". $qtyLeftExceeded . \"</span>单！<br>\";","\t\t\t\t\t\t\techo \"若全部批准，此单将<span style='color: red; font-size:20px'>总超量\" . $qtyLeftExceededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t\t*/","\t\t\t\t\t\t\t$qtyLeftExceeded = (int)$qtyLeft * (-1);","\t\t\t\t\t\t\t$qtyLeftExceededNew = (int)($totalQtyRequested) + (int)($qtyLeftExceeded);","\t\t\t\t\t\t\tif ((int)$qtyLeftExceeded != 0){","\t\t\t\t\t\t\t\techo \"此单已超量<span style='color: red; font-size:20px'>\". $qtyLeftExceeded . \"</span>单！<br>\";","\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\techo \"注意！此单已<span style='color: red; font-size:20px'>正好收满了！</span><br>\";","\t\t\t\t\t\t\t}","\t\t\t\t\t\t\techo \"若全部批准，此单将<span style='color: red; font-size:20px'>总超量\" . $qtyLeftExceededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t}","\t\t\t\t\t} else {","\t\t\t\t\t\t","\t\t\t\t\t}","\t\t\t\t}","\t\t\t}","\t    } else {","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='nurse-requested' class='nav-link'>目前没有被护士报数的单子</a></h3>\";","\t    }","\t\t","\t\t","\t\t/* PART II */","\t\t","\t\t$sql = \"SELECT * FROM orderTaken WHERE orderStatus='1' ORDER BY orderId DESC, orderTakenTime DESC\";","\t\t$stmt = $pdo->prepare($sql);","\t    $stmt->execute();","\t    $count = $stmt->rowCount();","\t    if ($count > 0){","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='nurse-taken' class='nav-link'>以下为护士已确认申领的单子</a></h3>\";","\t    \techo \"<table><tr><th>护士</th><th>QQ</th><th>数量</th><th>货名</th><th>链接</th><th>单价</th><th>收价</th><th>领单时间</th></tr>\";","\t\t    while ($row = $stmt->fetch()){","\t\t    \t$userId = $row[\"userId\"];","\t\t    \t$sql2 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t    \t$stmt2 = $pdo->prepare($sql2);","\t\t    \t$stmt2->execute();","\t\t    \tif($row2 = $stmt2->fetch()){","\t\t    \t\t$userName = $row2[\"userName\"];","\t\t    \t\t$userQQ = $row2[\"userQQ\"];","\t\t    \t}","","\t\t    \t$orderId = $row[\"orderId\"];","\t\t    \t$sql3 = \"SELECT * FROM orders WHERE orderId='$orderId'\";","\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t    \t$stmt3->execute();","\t\t    \tif($row3 = $stmt3->fetch()){","\t\t    \t\t$itemName = $row3[\"itemName\"];","\t\t    \t\t$itemLink = makeLink($row3[\"itemLink\"]);","\t\t    \t\t$itemCost = $row3[\"itemCost\"];","\t\t    \t\t$itemReceivingPrice = $row3[\"itemReceivingPrice\"];","\t\t    \t}","","\t\t    \t$qtyTaken = $row[\"qtyTaken\"];","\t\t    \t$orderTakenTime = $row[\"orderTakenTime\"];","\t\t    \t","\t\t    \t$tableRow = \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyTaken . \"</td><td>\" . $itemName . \"</td><td>\" . $itemLink . \"</td><td>\" . $itemCost . \"</td><td>\" . $itemReceivingPrice . \"</td><td>\" . $orderTakenTime .  \"</td></tr>\";","\t\t    \techo $tableRow;","\t\t    }","\t\t    echo \"</table><br>\";","\t    } else {","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='nurse-taken' class='nav-link'>目前没有护士申领新单子</a></h3>\";","\t    }","\t    ","\t    ","\t    ","\t    /* Part III */\t    ","\t\t//http://stackoverflow.com/questions/43478069/best-way-to-identify-a-mysql-changed-group-by-field-value-in-a-statement-fetch","\t\t// My question","\t\t$sql = \"SELECT * FROM orderTaken WHERE orderStatus='11' ORDER BY orderId DESC, orderTakenTime DESC\";","\t\t$stmt = $pdo->prepare($sql);","\t    $stmt->execute();","\t    $count = $stmt->rowCount();","\t    if ($count > 0){","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='already-accepted' class='nav-link'>以下为已批准的单子，正等待护士确认。</a></h3>\";","\t    \tfor ($i = 0; $i < $count + 1; $i++){","\t\t\t\tif ($row = $stmt->fetch()){","\t\t\t\t\t$orderId = $row[\"orderId\"];","\t\t\t\t\t$qtyRequested = $row[\"qtyTaken\"];","\t\t\t\t\t$requestedTime = $row[\"lastModifiedTime\"];","\t\t\t\t\t$orderTakenId = $row[\"orderTakenId\"];","\t\t\t\t\t//$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\tif (isset($newOldOrderId)){","\t\t\t\t\t\tif ($newOldOrderId != $orderId){","\t\t\t\t\t\t\t/*","\t\t\t\t\t\t\techo \"看看\" . $oldOrderId;","\t\t\t\t\t\t\techo \"NEWNEW\";*/","\t\t\t\t\t\t\techo \"</table><br>\";","\t\t\t\t\t\t\t//echo \"NEWNEW2\";","\t\t\t\t\t\t\techo \"等待下单总数：\" . $totalQtyRequested . \"<br></div>\";","\t\t\t\t\t\t\t$totalQtyRequested = 0;","\t\t\t\t\t\t\t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t\t\t//echo \"前Sequence\" . $orderIdChangeSequence;","\t\t\t\t\t\t\t$orderIdChangeSequence++;","\t\t\t\t\t\t\t//echo \"后Sequence\" . $orderIdChangeSequence;","\t\t\t\t\t\t\techo \"<div orderSequenceNum='$orderIdChangeSequence'>单子：\" . $orderIdChangeSequence . \"<br>\";","\t\t\t\t\t\t\t$sql2 = \"SELECT * FROM orders WHERE orderId='$orderId'\";","\t\t\t\t\t\t\t$stmt2 = $pdo->prepare($sql2);","\t\t\t\t\t    \t$stmt2->execute();","\t\t\t\t\t    \tif($row2 = $stmt2->fetch()){","\t\t\t\t\t    \t\t$itemName = $row2[\"itemName\"];","\t\t\t\t\t    \t\t$itemLink = makeLink($row2[\"itemLink\"]);","\t\t\t\t\t    \t\t$itemCost = $row2[\"itemCost\"];","\t\t\t\t\t    \t\t$itemReceivingPrice = $row2[\"itemReceivingPrice\"];","\t\t\t\t\t    \t\t$totalQty = $row2[\"totalQty\"];","\t\t\t\t\t    \t\t$totalQtyTaken = $row2[\"totalQtyTaken\"];","\t\t\t\t\t    \t\t$qtyLeft = $row2[\"qtyLeft\"];","\t\t\t\t\t    \t\t$creationTime = $row2[\"creationTime\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \t$orderInfoGeneral = \"货名: \" . $itemName . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"链接: \" . $itemLink . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"单价: \" . $itemCost . \"<br>\" .","\t\t\t\t\t\t    \t\t\t\t\t\"收价: \" . $itemReceivingPrice . \"<br>\" . ","\t\t\t\t\t\t\t\t\t\t\t\t\"订单建立时间\" . $creationTime . \"<br>\" .","\t\t\t\t\t\t\t\t\t\t\t\t\"目标收货数量\" . $totalQty . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"护士已下数量\" . $totalQtyTaken . \"<br>\";","\t\t\t\t\t    \t//if ((int)($totalQtyTaken) >= (int)($totalQty)) {","\t\t\t\t\t    \tif ($qtyLeft == 0) {","\t\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>此单已收满！</span><br>\";","\t\t\t\t\t    \t} else if ($qtyLeft < 0){","\t\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>此单已超收\" . (int)$qtyLeft * (-1) . \"单！</span><br>\";","\t\t\t\t\t    \t} else {","\t\t\t\t\t    \t\t//$qtyLeftNeeded = (int)($totalQty) - (int)($totalQtyTaken);","\t\t\t\t\t    \t\t//echo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeeded . \"</span>单。<br>\";","\t\t\t\t\t    \t\techo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeft . \"</span>单。<br>\";","\t\t\t\t\t    \t}","\t\t\t\t\t    \t//echo \"DEBUG 1\";","\t\t\t\t\t    \techo \"<table><tr><th>护士</th><th>QQ</th><th>等待下单数量</th><th>请求时间</th></tr>\";","\t\t\t\t\t    \t//echo \"FUCK\";","\t\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t\t    \t$stmt3->execute();","\t\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td><tr>\" .","\t\t\t\t\t    \t//echo \"不一样前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    \t$newOldOrderId = $orderId;","\t\t\t\t\t    \t//echo \"不一样后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    //$oldOrderId == $orderId","\t\t\t\t\t    } else {","\t\t\t\t\t    \t//echo \"SAME\";","\t\t\t\t\t    \t//若一样则继续print","\t\t\t\t\t    \t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t\t    \t$stmt3->execute();","\t\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \t//echo \"SAME YEA\";","\t\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td></tr>\";","\t\t\t\t\t    \t//echo \"一样前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    \t$newOldOrderId = $orderId;","\t\t\t\t\t    \t//echo \"一样后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    }","\t\t\t\t\t} else {","\t\t\t\t\t\t//echo \"XIN\";","\t\t\t\t\t\t//全新","\t\t\t\t\t\t$orderIdChangeSequence = 0;","\t\t\t\t\t\t$totalQtyRequested = 0;","\t\t\t\t\t\t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t\t$orderIdChangeSequence++;","\t\t\t\t\t\techo \"<div orderSequenceNum='$orderIdChangeSequence'>单子：\" . $orderIdChangeSequence . \"<br>\";","\t\t\t\t\t\t$sql2 = \"SELECT * FROM orders WHERE orderId='$orderId'\";","\t\t\t\t\t\t$stmt2 = $pdo->prepare($sql2);","\t\t\t\t    \t$stmt2->execute();","\t\t\t\t    \tif($row2 = $stmt2->fetch()){","\t\t\t\t    \t\t$itemName = $row2[\"itemName\"];","\t\t\t\t    \t\t$itemLink = makeLink($row2[\"itemLink\"]);","\t\t\t\t    \t\t$itemCost = $row2[\"itemCost\"];","\t\t\t\t    \t\t$itemReceivingPrice = $row2[\"itemReceivingPrice\"];","\t\t\t\t    \t\t$totalQty = $row2[\"totalQty\"];","\t\t\t\t    \t\t$totalQtyTaken = $row2[\"totalQtyTaken\"];","\t\t\t\t    \t\t$qtyLeft = $row2[\"qtyLeft\"];","\t\t\t\t    \t\t$creationTime = $row2[\"creationTime\"];","\t\t\t\t    \t}","\t\t\t\t    \t$orderInfoGeneral = \"货名: \" . $itemName . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"链接: \" . $itemLink . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"单价: \" . $itemCost . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\"收价: \" . $itemReceivingPrice . \"<br>\" . ","\t\t\t\t\t\t\t\t\t\t\t\"订单建立时间\" . $creationTime . \"<br>\" .","\t\t\t\t\t\t\t\t\t\t\t\"目标收货数量\" . $totalQty . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"护士已下数量\" . $totalQtyTaken . \"<br>\";","\t\t\t\t    \t//if ((int)($totalQtyTaken) >= (int)($totalQty)) {","\t\t\t    \t\tif ($qtyLeft == 0) {","\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>此单已收满！</span><br>\";","\t\t\t\t    \t} else if ($qtyLeft < 0){","\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>此单已超收\" . (int)$qtyLeft * (-1) . \"单！</span><br>\";","\t\t\t\t    \t} else {","\t\t\t\t    \t\t//$qtyLeftNeeded = (int)($totalQty) - (int)($totalQtyTaken);","\t\t\t\t    \t\t//echo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeeded . \"</span>单。<br>\";","\t\t\t\t    \t\techo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeft . \"</span>单。<br>\";","\t\t\t\t    \t}","\t\t\t\t    \t/*echo \"DEBUG2\";","\t\t\t\t    \techo \"oldOrderId第一次：\";","\t\t\t\t    \techo $oldOrderId;","\t\t\t\t    \techo \"CAONIMA0\";*/","\t\t\t\t    \techo \"<table><tr><th>护士</th><th>QQ</th><th>等待下单数量</th><th>请求时间</th></tr>\";","\t\t\t\t    \t//echo \"CAONIMA\";","\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t    \t$stmt3->execute();","\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t    \t}","\t\t\t\t    \t//echo \"CAONIMA2\";","\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td></tr>\";","\t\t\t\t    \t//echo \"CAONIMA3\";","\t\t\t\t    \t//echo \"前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t    \t$newOldOrderId = $orderId;","\t\t\t\t    \t//echo \"后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t}","\t\t\t\t}","\t\t\t\t//echo \"i是\" . $i . \"count是\" . $count . \"<br>\";","\t\t\t\t// 没显示","\t\t\t\tif ($i == $count){","\t\t\t\t\t//echo \"进来哦？？\";","\t\t\t\t\tif (isset($totalQtyRequested)){","\t\t\t\t\t\t//echo \"进来呀？\";","\t\t\t\t\t\techo \"</table><br>\";","\t\t\t\t\t\t//echo \"LAST共请求数量：\" . $totalQtyRequested . \"<br>\";","\t\t\t\t\t\techo \"等待下单总数：\" . $totalQtyRequested . \"<br></div>\";","\t\t\t\t\t} else {","\t\t\t\t\t\t","\t\t\t\t\t}","\t\t\t\t}","\t\t\t}","\t\t    echo \"</table>\";","\t    } else {","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='already-accepted' class='nav-link'>没有新批准的单子</a></h3>\";","\t    }","\t\t","\t    $pdo->commit();","","\t} ","\tcatch(Exception $e){","\t    echo $e->getMessage();","\t    $pdo->rollBack();","\t}","","","?>"],"id":759},{"start":{"row":0,"column":0},"end":{"row":482,"column":2},"action":"insert","lines":["<?php","","\tsession_start();","","\tfunction makeLink($url)","\t{","\t\treturn (\"<a href=\" . $url . \" target='_blank'>\" . $url . \"</a>\");","\t}","","\t$pdo = new PDO('mysql:host=localhost;dbname=chenh057_realPro', 'chenh057_hang01', 'bhgoszPg7iBcYD8WLAjeWrjEcH3LUcE96vHqCdGKnpNWZetxe', array(","\t    PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,","\t    PDO::ATTR_EMULATE_PREPARES => false","\t));","","\t$pdo->beginTransaction();","\t","\ttry{","\t\t","\t\t//http://stackoverflow.com/questions/43478069/best-way-to-identify-a-mysql-changed-group-by-field-value-in-a-statement-fetch","\t\t// My question","\t\t$sql = \"SELECT * FROM orderTaken WHERE orderStatus='10' ORDER BY orderId DESC, orderTakenTime DESC\";","\t\t$stmt = $pdo->prepare($sql);","\t    $stmt->execute();","\t    $count = $stmt->rowCount();","\t    if ($count > 0){","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='nurse-requested' class='nav-link'>以下为护士报数的单子，请依情况执行操作。</a></h3>\";","\t    \tfor ($i = 0; $i < $count + 1; $i++){","\t\t\t\tif ($row = $stmt->fetch()){","\t\t\t\t\t$orderId = $row[\"orderId\"];","\t\t\t\t\t$qtyRequested = $row[\"qtyTaken\"];","\t\t\t\t\t$requestedTime = $row[\"lastModifiedTime\"];","\t\t\t\t\t$orderTakenId = $row[\"orderTakenId\"];","\t\t\t\t\t//$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\tif (isset($oldOrderId)){","\t\t\t\t\t\tif ($oldOrderId != $orderId){","\t\t\t\t\t\t\t/*","\t\t\t\t\t\t\techo \"看看\" . $oldOrderId;","\t\t\t\t\t\t\techo \"NEWNEW\";*/","\t\t\t\t\t\t\techo \"</table><br>\";","\t\t\t\t\t\t\t//echo \"NEWNEW2\";","\t\t\t\t\t\t\techo \"共请求数量：\" . $totalQtyRequested . \"<br>\";","\t\t\t\t\t\t\tif ($isFull == false){","\t\t\t\t\t\t\t\t//$qtyLeftNeededNew = (int)($totalQty) - ((int)($totalQtyRequested) + (int)($totalQtyTaken));","\t\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)$qtyLeft - (int)($totalQtyRequested);","\t\t\t\t\t\t\t\tif ($qtyLeftNeededNew > 0){","\t\t\t\t\t\t\t\t\techo \"若全部批准，此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeededNew . \"</span>单。<br></div>\";","\t\t\t\t\t\t\t\t} else if ($qtyLeftNeededNew == 0){","\t\t\t\t\t\t\t\t\techo \"若全部批准，此单正好收全。<br></div>\";","\t\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)$qtyLeftNeededNew * (-1);","\t\t\t\t\t\t\t\t\techo \"注意！若全部批准，此单将<span style='color: red; font-size:20px'>超量\" . $qtyLeftNeededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t\t\t}","\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\t//$qtyLeftExceeded = (int)($totalQtyTaken) - (int)($totalQty);","\t\t\t\t\t\t\t\t$qtyLeftExceeded = (int)$qtyLeft * (-1);","\t\t\t\t\t\t\t\t$qtyLeftExceededNew = (int)($totalQtyRequested) + (int)($qtyLeftExceeded);","\t\t\t\t\t\t\t\tif ((int)$qtyLeftExceeded != 0){","\t\t\t\t\t\t\t\t\techo \"此单已超量<span style='color: red; font-size:20px'>\". $qtyLeftExceeded . \"</span>单！<br>\";","\t\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\t\techo \"注意！此单已<span style='color: red; font-size:20px'>正好收满了！</span><br>\";","\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t","\t\t\t\t\t\t\t\techo \"若全部批准，此单将<span style='color: red; font-size:20px'>总超量\" . $qtyLeftExceededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t\t}","\t\t\t\t\t\t\t$totalQtyRequested = 0;","\t\t\t\t\t\t\t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t\t\t//echo \"前Sequence\" . $orderIdChangeSequence;","\t\t\t\t\t\t\t$orderIdChangeSequence++;","\t\t\t\t\t\t\t//echo \"后Sequence\" . $orderIdChangeSequence;","\t\t\t\t\t\t\techo \"<div orderSequenceNum='$orderIdChangeSequence'>单子：\" . $orderIdChangeSequence . \"<br>\";","\t\t\t\t\t\t\t$sql2 = \"SELECT * FROM orders WHERE orderId='$orderId'\";","\t\t\t\t\t\t\t$stmt2 = $pdo->prepare($sql2);","\t\t\t\t\t    \t$stmt2->execute();","\t\t\t\t\t    \tif($row2 = $stmt2->fetch()){","\t\t\t\t\t    \t\t$itemName = $row2[\"itemName\"];","\t\t\t\t\t    \t\t$itemLink = makeLink($row2[\"itemLink\"]);","\t\t\t\t\t    \t\t$itemCost = $row2[\"itemCost\"];","\t\t\t\t\t    \t\t$itemReceivingPrice = $row2[\"itemReceivingPrice\"];","\t\t\t\t\t    \t\t$totalQty = $row2[\"totalQty\"];","\t\t\t\t\t    \t\t$totalQtyTaken = $row2[\"totalQtyTaken\"];","\t\t\t\t\t    \t\t$qtyLeft = $row2[\"qtyLeft\"];","\t\t\t\t\t    \t\t$creationTime = $row2[\"creationTime\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \t$orderInfoGeneral = \"货名: \" . $itemName . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"链接: \" . $itemLink . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"单价: \" . $itemCost . \"<br>\" .","\t\t\t\t\t\t    \t\t\t\t\t\"收价: \" . $itemReceivingPrice . \"<br>\" . ","\t\t\t\t\t\t\t\t\t\t\t\t\"订单建立时间\" . $creationTime . \"<br>\" .","\t\t\t\t\t\t\t\t\t\t\t\t\"目标收货数量\" . $totalQty . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"护士已下数量\" . $totalQtyTaken . \"<br>\";","\t\t\t\t\t    \t//if ((int)($totalQtyTaken) >= (int)($totalQty)) {","\t\t\t\t\t    \tif ($qtyLeft <= 0) {","\t\t\t\t\t    \t\t$isFull = true;","\t\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>注意，此单已收满！</span><br>\";","\t\t\t\t\t    \t} else {","\t\t\t\t\t    \t\t$isFull = false;","\t\t\t\t\t    \t\t//$qtyLeftNeeded = (int)($totalQty) - (int)($totalQtyTaken);","\t\t\t\t\t    \t\t//echo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeeded . \"</span>单。<br>\";","\t\t\t\t\t    \t\techo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeft . \"</span>单。<br>\";","\t\t\t\t\t    \t}","\t\t\t\t\t    \t//echo \"DEBUG 1\";","\t\t\t\t\t    \techo \"<table><tr><th>护士</th><th>QQ</th><th>请求数量</th><th>请求时间</th><th>批准</th><th>修改并批数量</th><th>拒绝</th></tr>\";","\t\t\t\t\t    \t//echo \"FUCK\";","\t\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t\t    \t$stmt3->execute();","\t\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td></tr>\" .","\t\t\t\t\t    \t\"<button class='accept-qty-btn' data-accept-orderTakenId='$orderTakenId' data-accept-qtyRequested='$qtyRequested' data-accept-qty-orderId='$orderId'>批</button>\" . \"</td><td>\" .","\t\t\t\t\t    \t\"<button class='accept-change-qty-btn' data-accept-change-qty-orderTakenId='$orderTakenId' data-accept-change-qty-userName='$userName' data-accept-change-qty-orderId='$orderId' data-accept-change-qty-qtyLeft='$qtyLeft'>改并批</button>\" . \"</td><td>\" .","\t\t\t\t\t    \t\"<button class='reject-qty-btn' data-reject-orderTakenId='$orderTakenId' data-reject-userName='$userName'>拒</button>\" . \"</td></tr>\";","\t\t\t\t\t    \t//echo \"不一样前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    \t$oldOrderId = $orderId;","\t\t\t\t\t    \t//echo \"不一样后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    //$oldOrderId == $orderId","\t\t\t\t\t    } else {","\t\t\t\t\t    \t//echo \"SAME\";","\t\t\t\t\t    \t//若一样则继续print","\t\t\t\t\t    \t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t\t    \t$stmt3->execute();","\t\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \t//echo \"SAME YEA\";","\t\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td></tr>\" .","\t\t\t\t\t    \t\"<button class='accept-qty-btn' data-accept-orderTakenId='$orderTakenId' data-accept-qtyRequested='$qtyRequested' data-accept-qty-orderId='$orderId'>批</button>\" . \"</td><td>\" .","\t\t\t\t\t    \t\"<button class='accept-change-qty-btn' data-accept-change-qty-orderTakenId='$orderTakenId' data-accept-change-qty-userName='$userName' data-accept-change-qty-orderId='$orderId' data-accept-change-qty-qtyLeft='$qtyLeft'>改并批</button>\" . \"</td><td>\" .","\t\t\t\t\t    \t\"<button class='reject-qty-btn' data-reject-orderTakenId='$orderTakenId' data-reject-userName='$userName'>拒</button>\" . \"</td></tr>\";","\t\t\t\t\t    \t//echo \"一样前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    \t$oldOrderId = $orderId;","\t\t\t\t\t    \t//echo \"一样后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    }","\t\t\t\t\t} else {","\t\t\t\t\t\t//echo \"XIN\";","\t\t\t\t\t\t//全新","\t\t\t\t\t\t// 检查应该是无误了 041917 101920am 3E","\t\t\t\t\t\t$orderIdChangeSequence = 0;","\t\t\t\t\t\t$totalQtyRequested = 0;","\t\t\t\t\t\t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t\t$orderIdChangeSequence++;","\t\t\t\t\t\techo \"<div orderSequenceNum='$orderIdChangeSequence'>单子：\" . $orderIdChangeSequence . \"<br>\";","\t\t\t\t\t\t$sql2 = \"SELECT * FROM orders WHERE orderId='$orderId'\";","\t\t\t\t\t\t$stmt2 = $pdo->prepare($sql2);","\t\t\t\t    \t$stmt2->execute();","\t\t\t\t    \tif($row2 = $stmt2->fetch()){","\t\t\t\t    \t\t$itemName = $row2[\"itemName\"];","\t\t\t\t    \t\t$itemLink = makeLink($row2[\"itemLink\"]);","\t\t\t\t    \t\t$itemCost = $row2[\"itemCost\"];","\t\t\t\t    \t\t$itemReceivingPrice = $row2[\"itemReceivingPrice\"];","\t\t\t\t    \t\t$totalQty = $row2[\"totalQty\"];","\t\t\t\t    \t\t$totalQtyTaken = $row2[\"totalQtyTaken\"];","\t\t\t\t    \t\t$qtyLeft = $row2[\"qtyLeft\"];","\t\t\t\t    \t\t$creationTime = $row2[\"creationTime\"];","\t\t\t\t    \t}","\t\t\t\t    \t$orderInfoGeneral = \"货名: \" . $itemName . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"链接: \" . $itemLink . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"单价: \" . $itemCost . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\"收价: \" . $itemReceivingPrice . \"<br>\" . ","\t\t\t\t\t\t\t\t\t\t\t\"订单建立时间\" . $creationTime . \"<br>\" .","\t\t\t\t\t\t\t\t\t\t\t\"目标收货数量\" . $totalQty . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"护士已下数量\" . $totalQtyTaken . \"<br>\";","\t\t\t\t    \t//if ((int)($totalQtyTaken) >= (int)($totalQty)) {","\t\t\t\t    \tif ($qtyLeft <= 0) {","\t\t\t\t    \t\t$isFull = true;","\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>注意，此单已收满！</span><br>\";","\t\t\t\t    \t} else {","\t\t\t\t    \t\t$isFull = false;","\t\t\t\t    \t\t//$qtyLeftNeeded = (int)($totalQty) - (int)($totalQtyTaken);","\t\t\t\t    \t\techo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeft . \"</span>单。<br>\";","\t\t\t\t    \t}","\t\t\t\t    \t/*echo \"DEBUG2\";","\t\t\t\t    \techo \"oldOrderId第一次：\";","\t\t\t\t    \techo $oldOrderId;","\t\t\t\t    \techo \"CAONIMA0\";*/","\t\t\t\t    \techo \"<table><tr><th>护士</th><th>QQ</th><th>请求数量</th><th>请求时间</th><th>批准</th><th>修改并批数量</th><th>拒绝</th></tr>\";","\t\t\t\t    \t//echo \"CAONIMA\";","\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t    \t$stmt3->execute();","\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t    \t}","\t\t\t\t    \t//echo \"CAONIMA2\";","\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td></tr>\" .","\t\t\t\t    \t\"<button class='accept-qty-btn' data-accept-orderTakenId='$orderTakenId' data-accept-qtyRequested='$qtyRequested' data-accept-qty-orderId='$orderId'>批</button>\" . \"</td><td>\" .","\t\t\t\t    \t\"<button class='accept-change-qty-btn' data-accept-change-qty-orderTakenId='$orderTakenId' data-accept-change-qty-userName='$userName' data-accept-change-qty-orderId='$orderId' data-accept-change-qty-qtyLeft='$qtyLeft'>改并批</button>\" . \"</td><td>\" .","\t\t\t\t    \t\"<button class='reject-qty-btn' data-reject-orderTakenId='$orderTakenId' data-reject-userName='$userName'>拒</button>\" . \"</td></tr>\";","\t\t\t\t    \t//echo \"CAONIMA3\";","\t\t\t\t    \t//echo \"前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t    \t$oldOrderId = $orderId;","\t\t\t\t    \t//echo \"后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t}","\t\t\t\t}","\t\t\t\t//echo \"i是\" . $i . \"count是\" . $count . \"<br>\";","\t\t\t\t// 没显示","\t\t\t\tif ($i == $count){","\t\t\t\t\t//echo \"进来哦？？\";","\t\t\t\t\tif (isset($totalQtyRequested)){","\t\t\t\t\t\t//echo \"进来呀？\";","\t\t\t\t\t\techo \"</table><br>\";","\t\t\t\t\t\t//echo \"LAST共请求数量：\" . $totalQtyRequested . \"<br>\";","\t\t\t\t\t\techo \"共请求数量：\" . $totalQtyRequested . \"<br>\";","\t\t\t\t\t\tif ($isFull == false){","\t\t\t\t\t\t\t/*","\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)($totalQty) - ((int)($totalQtyRequested) + (int)($totalQtyTaken));","\t\t\t\t\t\t\tif ($qtyLeftNeededNew > 0){","\t\t\t\t\t\t\t\techo \"若全部批准，此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeededNew . \"</span>单。<br></div>\";","\t\t\t\t\t\t\t} else if ($qtyLeftNeededNew == 0){","\t\t\t\t\t\t\t\techo \"若全部批准，此单正好收全。<br></div>\";","\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)$qtyLeftNeededNew * (-1);","\t\t\t\t\t\t\t\techo \"注意！若全部批准，此单将<span style='color: red; font-size:20px'>超量\" . $qtyLeftNeededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t\t}*/","\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)$qtyLeft - (int)($totalQtyRequested);","\t\t\t\t\t\t\tif ($qtyLeftNeededNew > 0){","\t\t\t\t\t\t\t\techo \"若全部批准，此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeededNew . \"</span>单。<br></div>\";","\t\t\t\t\t\t\t} else if ($qtyLeftNeededNew == 0){","\t\t\t\t\t\t\t\techo \"若全部批准，此单正好收全。<br></div>\";","\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)$qtyLeftNeededNew * (-1);","\t\t\t\t\t\t\t\techo \"注意！若全部批准，此单将<span style='color: red; font-size:20px'>超量\" . $qtyLeftNeededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t\t}","","\t\t\t\t\t\t} else {/*","\t\t\t\t\t\t\t$qtyLeftExceeded = (int)($totalQtyTaken) - (int)($totalQty);","\t\t\t\t\t\t\t$qtyLeftExceededNew = (int)($totalQtyRequested) + (int)($qtyLeftExceeded);","\t\t\t\t\t\t\techo \"此单已超量<span style='color: red; font-size:20px'>\". $qtyLeftExceeded . \"</span>单！<br>\";","\t\t\t\t\t\t\techo \"若全部批准，此单将<span style='color: red; font-size:20px'>总超量\" . $qtyLeftExceededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t\t*/","\t\t\t\t\t\t\t$qtyLeftExceeded = (int)$qtyLeft * (-1);","\t\t\t\t\t\t\t$qtyLeftExceededNew = (int)($totalQtyRequested) + (int)($qtyLeftExceeded);","\t\t\t\t\t\t\tif ((int)$qtyLeftExceeded != 0){","\t\t\t\t\t\t\t\techo \"此单已超量<span style='color: red; font-size:20px'>\". $qtyLeftExceeded . \"</span>单！<br>\";","\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\techo \"注意！此单已<span style='color: red; font-size:20px'>正好收满了！</span><br>\";","\t\t\t\t\t\t\t}","\t\t\t\t\t\t\techo \"若全部批准，此单将<span style='color: red; font-size:20px'>总超量\" . $qtyLeftExceededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t}","\t\t\t\t\t} else {","\t\t\t\t\t\t","\t\t\t\t\t}","\t\t\t\t}","\t\t\t}","\t    } else {","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='nurse-requested' class='nav-link'>目前没有被护士报数的单子</a></h3>\";","\t    }","\t\t","\t\t","\t\t/* PART II */","\t\t","\t\t$sql = \"SELECT * FROM orderTaken WHERE orderStatus='1' ORDER BY orderId DESC, orderTakenTime DESC\";","\t\t$stmt = $pdo->prepare($sql);","\t    $stmt->execute();","\t    $count = $stmt->rowCount();","\t    if ($count > 0){","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='nurse-taken' class='nav-link'>以下为护士已确认申领的单子</a></h3>\";","\t    \techo \"<table><tr><th>护士</th><th>QQ</th><th>数量</th><th>货名</th><th>链接</th><th>单价</th><th>收价</th><th>领单时间</th></tr>\";","\t\t    while ($row = $stmt->fetch()){","\t\t    \t$userId = $row[\"userId\"];","\t\t    \t$sql2 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t    \t$stmt2 = $pdo->prepare($sql2);","\t\t    \t$stmt2->execute();","\t\t    \tif($row2 = $stmt2->fetch()){","\t\t    \t\t$userName = $row2[\"userName\"];","\t\t    \t\t$userQQ = $row2[\"userQQ\"];","\t\t    \t}","","\t\t    \t$orderId = $row[\"orderId\"];","\t\t    \t$sql3 = \"SELECT * FROM orders WHERE orderId='$orderId'\";","\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t    \t$stmt3->execute();","\t\t    \tif($row3 = $stmt3->fetch()){","\t\t    \t\t$itemName = $row3[\"itemName\"];","\t\t    \t\t$itemLink = makeLink($row3[\"itemLink\"]);","\t\t    \t\t$itemCost = $row3[\"itemCost\"];","\t\t    \t\t$itemReceivingPrice = $row3[\"itemReceivingPrice\"];","\t\t    \t}","","\t\t    \t$qtyTaken = $row[\"qtyTaken\"];","\t\t    \t$orderTakenTime = $row[\"orderTakenTime\"];","\t\t    \t","\t\t    \t$tableRow = \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyTaken . \"</td><td>\" . $itemName . \"</td><td>\" . $itemLink . \"</td><td>\" . $itemCost . \"</td><td>\" . $itemReceivingPrice . \"</td><td>\" . $orderTakenTime .  \"</td></tr>\";","\t\t    \techo $tableRow;","\t\t    }","\t\t    echo \"</table><br>\";","\t    } else {","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='nurse-taken' class='nav-link'>目前没有护士申领新单子</a></h3>\";","\t    }","\t    ","\t    ","\t    ","\t    /* Part III */\t    ","\t\t//http://stackoverflow.com/questions/43478069/best-way-to-identify-a-mysql-changed-group-by-field-value-in-a-statement-fetch","\t\t// My question","\t\t$sql = \"SELECT * FROM orderTaken WHERE orderStatus='11' ORDER BY orderId DESC, orderTakenTime DESC\";","\t\t$stmt = $pdo->prepare($sql);","\t    $stmt->execute();","\t    $count = $stmt->rowCount();","\t    if ($count > 0){","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='already-accepted' class='nav-link'>以下为已批准的单子，正等待护士确认。</a></h3>\";","\t    \tfor ($i = 0; $i < $count + 1; $i++){","\t\t\t\tif ($row = $stmt->fetch()){","\t\t\t\t\t$orderId = $row[\"orderId\"];","\t\t\t\t\t$qtyRequested = $row[\"qtyTaken\"];","\t\t\t\t\t$requestedTime = $row[\"lastModifiedTime\"];","\t\t\t\t\t$orderTakenId = $row[\"orderTakenId\"];","\t\t\t\t\t//$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\tif (isset($newOldOrderId)){","\t\t\t\t\t\tif ($newOldOrderId != $orderId){","\t\t\t\t\t\t\t/*","\t\t\t\t\t\t\techo \"看看\" . $oldOrderId;","\t\t\t\t\t\t\techo \"NEWNEW\";*/","\t\t\t\t\t\t\techo \"</table><br>\";","\t\t\t\t\t\t\t//echo \"NEWNEW2\";","\t\t\t\t\t\t\techo \"等待下单总数：\" . $totalQtyRequested . \"<br></div>\";","\t\t\t\t\t\t\t$totalQtyRequested = 0;","\t\t\t\t\t\t\t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t\t\t//echo \"前Sequence\" . $orderIdChangeSequence;","\t\t\t\t\t\t\t$orderIdChangeSequence++;","\t\t\t\t\t\t\t//echo \"后Sequence\" . $orderIdChangeSequence;","\t\t\t\t\t\t\techo \"<div orderSequenceNum='$orderIdChangeSequence'>单子：\" . $orderIdChangeSequence . \"<br>\";","\t\t\t\t\t\t\t$sql2 = \"SELECT * FROM orders WHERE orderId='$orderId'\";","\t\t\t\t\t\t\t$stmt2 = $pdo->prepare($sql2);","\t\t\t\t\t    \t$stmt2->execute();","\t\t\t\t\t    \tif($row2 = $stmt2->fetch()){","\t\t\t\t\t    \t\t$itemName = $row2[\"itemName\"];","\t\t\t\t\t    \t\t$itemLink = makeLink($row2[\"itemLink\"]);","\t\t\t\t\t    \t\t$itemCost = $row2[\"itemCost\"];","\t\t\t\t\t    \t\t$itemReceivingPrice = $row2[\"itemReceivingPrice\"];","\t\t\t\t\t    \t\t$totalQty = $row2[\"totalQty\"];","\t\t\t\t\t    \t\t$totalQtyTaken = $row2[\"totalQtyTaken\"];","\t\t\t\t\t    \t\t$qtyLeft = $row2[\"qtyLeft\"];","\t\t\t\t\t    \t\t$creationTime = $row2[\"creationTime\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \t$orderInfoGeneral = \"货名: \" . $itemName . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"链接: \" . $itemLink . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"单价: \" . $itemCost . \"<br>\" .","\t\t\t\t\t\t    \t\t\t\t\t\"收价: \" . $itemReceivingPrice . \"<br>\" . ","\t\t\t\t\t\t\t\t\t\t\t\t\"订单建立时间\" . $creationTime . \"<br>\" .","\t\t\t\t\t\t\t\t\t\t\t\t\"目标收货数量\" . $totalQty . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"护士已下数量\" . $totalQtyTaken . \"<br>\";","\t\t\t\t\t    \t//if ((int)($totalQtyTaken) >= (int)($totalQty)) {","\t\t\t\t\t    \tif ($qtyLeft == 0) {","\t\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>此单已收满！</span><br>\";","\t\t\t\t\t    \t} else if ($qtyLeft < 0){","\t\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>此单已超收\" . (int)$qtyLeft * (-1) . \"单！</span><br>\";","\t\t\t\t\t    \t} else {","\t\t\t\t\t    \t\t//$qtyLeftNeeded = (int)($totalQty) - (int)($totalQtyTaken);","\t\t\t\t\t    \t\t//echo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeeded . \"</span>单。<br>\";","\t\t\t\t\t    \t\techo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeft . \"</span>单。<br>\";","\t\t\t\t\t    \t}","\t\t\t\t\t    \t//echo \"DEBUG 1\";","\t\t\t\t\t    \techo \"<table><tr><th>护士</th><th>QQ</th><th>等待下单数量</th><th>请求时间</th></tr>\";","\t\t\t\t\t    \t//echo \"FUCK\";","\t\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t\t    \t$stmt3->execute();","\t\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td></tr>\" .","\t\t\t\t\t    \t//echo \"不一样前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    \t$newOldOrderId = $orderId;","\t\t\t\t\t    \t//echo \"不一样后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    //$oldOrderId == $orderId","\t\t\t\t\t    } else {","\t\t\t\t\t    \t//echo \"SAME\";","\t\t\t\t\t    \t//若一样则继续print","\t\t\t\t\t    \t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t\t    \t$stmt3->execute();","\t\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \t//echo \"SAME YEA\";","\t\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td></tr>\";","\t\t\t\t\t    \t//echo \"一样前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    \t$newOldOrderId = $orderId;","\t\t\t\t\t    \t//echo \"一样后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    }","\t\t\t\t\t} else {","\t\t\t\t\t\t//echo \"XIN\";","\t\t\t\t\t\t//全新","\t\t\t\t\t\t$orderIdChangeSequence = 0;","\t\t\t\t\t\t$totalQtyRequested = 0;","\t\t\t\t\t\t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t\t$orderIdChangeSequence++;","\t\t\t\t\t\techo \"<div orderSequenceNum='$orderIdChangeSequence'>单子：\" . $orderIdChangeSequence . \"<br>\";","\t\t\t\t\t\t$sql2 = \"SELECT * FROM orders WHERE orderId='$orderId'\";","\t\t\t\t\t\t$stmt2 = $pdo->prepare($sql2);","\t\t\t\t    \t$stmt2->execute();","\t\t\t\t    \tif($row2 = $stmt2->fetch()){","\t\t\t\t    \t\t$itemName = $row2[\"itemName\"];","\t\t\t\t    \t\t$itemLink = makeLink($row2[\"itemLink\"]);","\t\t\t\t    \t\t$itemCost = $row2[\"itemCost\"];","\t\t\t\t    \t\t$itemReceivingPrice = $row2[\"itemReceivingPrice\"];","\t\t\t\t    \t\t$totalQty = $row2[\"totalQty\"];","\t\t\t\t    \t\t$totalQtyTaken = $row2[\"totalQtyTaken\"];","\t\t\t\t    \t\t$qtyLeft = $row2[\"qtyLeft\"];","\t\t\t\t    \t\t$creationTime = $row2[\"creationTime\"];","\t\t\t\t    \t}","\t\t\t\t    \t$orderInfoGeneral = \"货名: \" . $itemName . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"链接: \" . $itemLink . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"单价: \" . $itemCost . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\"收价: \" . $itemReceivingPrice . \"<br>\" . ","\t\t\t\t\t\t\t\t\t\t\t\"订单建立时间\" . $creationTime . \"<br>\" .","\t\t\t\t\t\t\t\t\t\t\t\"目标收货数量\" . $totalQty . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"护士已下数量\" . $totalQtyTaken . \"<br>\";","\t\t\t\t    \t//if ((int)($totalQtyTaken) >= (int)($totalQty)) {","\t\t\t    \t\tif ($qtyLeft == 0) {","\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>此单已收满！</span><br>\";","\t\t\t\t    \t} else if ($qtyLeft < 0){","\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>此单已超收\" . (int)$qtyLeft * (-1) . \"单！</span><br>\";","\t\t\t\t    \t} else {","\t\t\t\t    \t\t//$qtyLeftNeeded = (int)($totalQty) - (int)($totalQtyTaken);","\t\t\t\t    \t\t//echo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeeded . \"</span>单。<br>\";","\t\t\t\t    \t\techo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeft . \"</span>单。<br>\";","\t\t\t\t    \t}","\t\t\t\t    \t/*echo \"DEBUG2\";","\t\t\t\t    \techo \"oldOrderId第一次：\";","\t\t\t\t    \techo $oldOrderId;","\t\t\t\t    \techo \"CAONIMA0\";*/","\t\t\t\t    \techo \"<table><tr><th>护士</th><th>QQ</th><th>等待下单数量</th><th>请求时间</th></tr>\";","\t\t\t\t    \t//echo \"CAONIMA\";","\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t    \t$stmt3->execute();","\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t    \t}","\t\t\t\t    \t//echo \"CAONIMA2\";","\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td></tr>\";","\t\t\t\t    \t//echo \"CAONIMA3\";","\t\t\t\t    \t//echo \"前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t    \t$newOldOrderId = $orderId;","\t\t\t\t    \t//echo \"后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t}","\t\t\t\t}","\t\t\t\t//echo \"i是\" . $i . \"count是\" . $count . \"<br>\";","\t\t\t\t// 没显示","\t\t\t\tif ($i == $count){","\t\t\t\t\t//echo \"进来哦？？\";","\t\t\t\t\tif (isset($totalQtyRequested)){","\t\t\t\t\t\t//echo \"进来呀？\";","\t\t\t\t\t\techo \"</table><br>\";","\t\t\t\t\t\t//echo \"LAST共请求数量：\" . $totalQtyRequested . \"<br>\";","\t\t\t\t\t\techo \"等待下单总数：\" . $totalQtyRequested . \"<br></div>\";","\t\t\t\t\t} else {","\t\t\t\t\t\t","\t\t\t\t\t}","\t\t\t\t}","\t\t\t}","\t\t    echo \"</table>\";","\t    } else {","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='already-accepted' class='nav-link'>没有新批准的单子</a></h3>\";","\t    }","\t\t","\t    $pdo->commit();","","\t} ","\tcatch(Exception $e){","\t    echo $e->getMessage();","\t    $pdo->rollBack();","\t}","","","?>"]}],[{"start":{"row":0,"column":0},"end":{"row":482,"column":2},"action":"remove","lines":["<?php","","\tsession_start();","","\tfunction makeLink($url)","\t{","\t\treturn (\"<a href=\" . $url . \" target='_blank'>\" . $url . \"</a>\");","\t}","","\t$pdo = new PDO('mysql:host=localhost;dbname=chenh057_realPro', 'chenh057_hang01', 'bhgoszPg7iBcYD8WLAjeWrjEcH3LUcE96vHqCdGKnpNWZetxe', array(","\t    PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,","\t    PDO::ATTR_EMULATE_PREPARES => false","\t));","","\t$pdo->beginTransaction();","\t","\ttry{","\t\t","\t\t//http://stackoverflow.com/questions/43478069/best-way-to-identify-a-mysql-changed-group-by-field-value-in-a-statement-fetch","\t\t// My question","\t\t$sql = \"SELECT * FROM orderTaken WHERE orderStatus='10' ORDER BY orderId DESC, orderTakenTime DESC\";","\t\t$stmt = $pdo->prepare($sql);","\t    $stmt->execute();","\t    $count = $stmt->rowCount();","\t    if ($count > 0){","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='nurse-requested' class='nav-link'>以下为护士报数的单子，请依情况执行操作。</a></h3>\";","\t    \tfor ($i = 0; $i < $count + 1; $i++){","\t\t\t\tif ($row = $stmt->fetch()){","\t\t\t\t\t$orderId = $row[\"orderId\"];","\t\t\t\t\t$qtyRequested = $row[\"qtyTaken\"];","\t\t\t\t\t$requestedTime = $row[\"lastModifiedTime\"];","\t\t\t\t\t$orderTakenId = $row[\"orderTakenId\"];","\t\t\t\t\t//$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\tif (isset($oldOrderId)){","\t\t\t\t\t\tif ($oldOrderId != $orderId){","\t\t\t\t\t\t\t/*","\t\t\t\t\t\t\techo \"看看\" . $oldOrderId;","\t\t\t\t\t\t\techo \"NEWNEW\";*/","\t\t\t\t\t\t\techo \"</table><br>\";","\t\t\t\t\t\t\t//echo \"NEWNEW2\";","\t\t\t\t\t\t\techo \"共请求数量：\" . $totalQtyRequested . \"<br>\";","\t\t\t\t\t\t\tif ($isFull == false){","\t\t\t\t\t\t\t\t//$qtyLeftNeededNew = (int)($totalQty) - ((int)($totalQtyRequested) + (int)($totalQtyTaken));","\t\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)$qtyLeft - (int)($totalQtyRequested);","\t\t\t\t\t\t\t\tif ($qtyLeftNeededNew > 0){","\t\t\t\t\t\t\t\t\techo \"若全部批准，此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeededNew . \"</span>单。<br></div>\";","\t\t\t\t\t\t\t\t} else if ($qtyLeftNeededNew == 0){","\t\t\t\t\t\t\t\t\techo \"若全部批准，此单正好收全。<br></div>\";","\t\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)$qtyLeftNeededNew * (-1);","\t\t\t\t\t\t\t\t\techo \"注意！若全部批准，此单将<span style='color: red; font-size:20px'>超量\" . $qtyLeftNeededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t\t\t}","\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\t//$qtyLeftExceeded = (int)($totalQtyTaken) - (int)($totalQty);","\t\t\t\t\t\t\t\t$qtyLeftExceeded = (int)$qtyLeft * (-1);","\t\t\t\t\t\t\t\t$qtyLeftExceededNew = (int)($totalQtyRequested) + (int)($qtyLeftExceeded);","\t\t\t\t\t\t\t\tif ((int)$qtyLeftExceeded != 0){","\t\t\t\t\t\t\t\t\techo \"此单已超量<span style='color: red; font-size:20px'>\". $qtyLeftExceeded . \"</span>单！<br>\";","\t\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\t\techo \"注意！此单已<span style='color: red; font-size:20px'>正好收满了！</span><br>\";","\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t","\t\t\t\t\t\t\t\techo \"若全部批准，此单将<span style='color: red; font-size:20px'>总超量\" . $qtyLeftExceededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t\t}","\t\t\t\t\t\t\t$totalQtyRequested = 0;","\t\t\t\t\t\t\t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t\t\t//echo \"前Sequence\" . $orderIdChangeSequence;","\t\t\t\t\t\t\t$orderIdChangeSequence++;","\t\t\t\t\t\t\t//echo \"后Sequence\" . $orderIdChangeSequence;","\t\t\t\t\t\t\techo \"<div orderSequenceNum='$orderIdChangeSequence'>单子：\" . $orderIdChangeSequence . \"<br>\";","\t\t\t\t\t\t\t$sql2 = \"SELECT * FROM orders WHERE orderId='$orderId'\";","\t\t\t\t\t\t\t$stmt2 = $pdo->prepare($sql2);","\t\t\t\t\t    \t$stmt2->execute();","\t\t\t\t\t    \tif($row2 = $stmt2->fetch()){","\t\t\t\t\t    \t\t$itemName = $row2[\"itemName\"];","\t\t\t\t\t    \t\t$itemLink = makeLink($row2[\"itemLink\"]);","\t\t\t\t\t    \t\t$itemCost = $row2[\"itemCost\"];","\t\t\t\t\t    \t\t$itemReceivingPrice = $row2[\"itemReceivingPrice\"];","\t\t\t\t\t    \t\t$totalQty = $row2[\"totalQty\"];","\t\t\t\t\t    \t\t$totalQtyTaken = $row2[\"totalQtyTaken\"];","\t\t\t\t\t    \t\t$qtyLeft = $row2[\"qtyLeft\"];","\t\t\t\t\t    \t\t$creationTime = $row2[\"creationTime\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \t$orderInfoGeneral = \"货名: \" . $itemName . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"链接: \" . $itemLink . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"单价: \" . $itemCost . \"<br>\" .","\t\t\t\t\t\t    \t\t\t\t\t\"收价: \" . $itemReceivingPrice . \"<br>\" . ","\t\t\t\t\t\t\t\t\t\t\t\t\"订单建立时间\" . $creationTime . \"<br>\" .","\t\t\t\t\t\t\t\t\t\t\t\t\"目标收货数量\" . $totalQty . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"护士已下数量\" . $totalQtyTaken . \"<br>\";","\t\t\t\t\t    \t//if ((int)($totalQtyTaken) >= (int)($totalQty)) {","\t\t\t\t\t    \tif ($qtyLeft <= 0) {","\t\t\t\t\t    \t\t$isFull = true;","\t\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>注意，此单已收满！</span><br>\";","\t\t\t\t\t    \t} else {","\t\t\t\t\t    \t\t$isFull = false;","\t\t\t\t\t    \t\t//$qtyLeftNeeded = (int)($totalQty) - (int)($totalQtyTaken);","\t\t\t\t\t    \t\t//echo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeeded . \"</span>单。<br>\";","\t\t\t\t\t    \t\techo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeft . \"</span>单。<br>\";","\t\t\t\t\t    \t}","\t\t\t\t\t    \t//echo \"DEBUG 1\";","\t\t\t\t\t    \techo \"<table><tr><th>护士</th><th>QQ</th><th>请求数量</th><th>请求时间</th><th>批准</th><th>修改并批数量</th><th>拒绝</th></tr>\";","\t\t\t\t\t    \t//echo \"FUCK\";","\t\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t\t    \t$stmt3->execute();","\t\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td></tr>\" .","\t\t\t\t\t    \t\"<button class='accept-qty-btn' data-accept-orderTakenId='$orderTakenId' data-accept-qtyRequested='$qtyRequested' data-accept-qty-orderId='$orderId'>批</button>\" . \"</td><td>\" .","\t\t\t\t\t    \t\"<button class='accept-change-qty-btn' data-accept-change-qty-orderTakenId='$orderTakenId' data-accept-change-qty-userName='$userName' data-accept-change-qty-orderId='$orderId' data-accept-change-qty-qtyLeft='$qtyLeft'>改并批</button>\" . \"</td><td>\" .","\t\t\t\t\t    \t\"<button class='reject-qty-btn' data-reject-orderTakenId='$orderTakenId' data-reject-userName='$userName'>拒</button>\" . \"</td></tr>\";","\t\t\t\t\t    \t//echo \"不一样前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    \t$oldOrderId = $orderId;","\t\t\t\t\t    \t//echo \"不一样后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    //$oldOrderId == $orderId","\t\t\t\t\t    } else {","\t\t\t\t\t    \t//echo \"SAME\";","\t\t\t\t\t    \t//若一样则继续print","\t\t\t\t\t    \t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t\t    \t$stmt3->execute();","\t\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \t//echo \"SAME YEA\";","\t\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td></tr>\" .","\t\t\t\t\t    \t\"<button class='accept-qty-btn' data-accept-orderTakenId='$orderTakenId' data-accept-qtyRequested='$qtyRequested' data-accept-qty-orderId='$orderId'>批</button>\" . \"</td><td>\" .","\t\t\t\t\t    \t\"<button class='accept-change-qty-btn' data-accept-change-qty-orderTakenId='$orderTakenId' data-accept-change-qty-userName='$userName' data-accept-change-qty-orderId='$orderId' data-accept-change-qty-qtyLeft='$qtyLeft'>改并批</button>\" . \"</td><td>\" .","\t\t\t\t\t    \t\"<button class='reject-qty-btn' data-reject-orderTakenId='$orderTakenId' data-reject-userName='$userName'>拒</button>\" . \"</td></tr>\";","\t\t\t\t\t    \t//echo \"一样前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    \t$oldOrderId = $orderId;","\t\t\t\t\t    \t//echo \"一样后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    }","\t\t\t\t\t} else {","\t\t\t\t\t\t//echo \"XIN\";","\t\t\t\t\t\t//全新","\t\t\t\t\t\t// 检查应该是无误了 041917 101920am 3E","\t\t\t\t\t\t$orderIdChangeSequence = 0;","\t\t\t\t\t\t$totalQtyRequested = 0;","\t\t\t\t\t\t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t\t$orderIdChangeSequence++;","\t\t\t\t\t\techo \"<div orderSequenceNum='$orderIdChangeSequence'>单子：\" . $orderIdChangeSequence . \"<br>\";","\t\t\t\t\t\t$sql2 = \"SELECT * FROM orders WHERE orderId='$orderId'\";","\t\t\t\t\t\t$stmt2 = $pdo->prepare($sql2);","\t\t\t\t    \t$stmt2->execute();","\t\t\t\t    \tif($row2 = $stmt2->fetch()){","\t\t\t\t    \t\t$itemName = $row2[\"itemName\"];","\t\t\t\t    \t\t$itemLink = makeLink($row2[\"itemLink\"]);","\t\t\t\t    \t\t$itemCost = $row2[\"itemCost\"];","\t\t\t\t    \t\t$itemReceivingPrice = $row2[\"itemReceivingPrice\"];","\t\t\t\t    \t\t$totalQty = $row2[\"totalQty\"];","\t\t\t\t    \t\t$totalQtyTaken = $row2[\"totalQtyTaken\"];","\t\t\t\t    \t\t$qtyLeft = $row2[\"qtyLeft\"];","\t\t\t\t    \t\t$creationTime = $row2[\"creationTime\"];","\t\t\t\t    \t}","\t\t\t\t    \t$orderInfoGeneral = \"货名: \" . $itemName . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"链接: \" . $itemLink . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"单价: \" . $itemCost . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\"收价: \" . $itemReceivingPrice . \"<br>\" . ","\t\t\t\t\t\t\t\t\t\t\t\"订单建立时间\" . $creationTime . \"<br>\" .","\t\t\t\t\t\t\t\t\t\t\t\"目标收货数量\" . $totalQty . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"护士已下数量\" . $totalQtyTaken . \"<br>\";","\t\t\t\t    \t//if ((int)($totalQtyTaken) >= (int)($totalQty)) {","\t\t\t\t    \tif ($qtyLeft <= 0) {","\t\t\t\t    \t\t$isFull = true;","\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>注意，此单已收满！</span><br>\";","\t\t\t\t    \t} else {","\t\t\t\t    \t\t$isFull = false;","\t\t\t\t    \t\t//$qtyLeftNeeded = (int)($totalQty) - (int)($totalQtyTaken);","\t\t\t\t    \t\techo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeft . \"</span>单。<br>\";","\t\t\t\t    \t}","\t\t\t\t    \t/*echo \"DEBUG2\";","\t\t\t\t    \techo \"oldOrderId第一次：\";","\t\t\t\t    \techo $oldOrderId;","\t\t\t\t    \techo \"CAONIMA0\";*/","\t\t\t\t    \techo \"<table><tr><th>护士</th><th>QQ</th><th>请求数量</th><th>请求时间</th><th>批准</th><th>修改并批数量</th><th>拒绝</th></tr>\";","\t\t\t\t    \t//echo \"CAONIMA\";","\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t    \t$stmt3->execute();","\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t    \t}","\t\t\t\t    \t//echo \"CAONIMA2\";","\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td></tr>\" .","\t\t\t\t    \t\"<button class='accept-qty-btn' data-accept-orderTakenId='$orderTakenId' data-accept-qtyRequested='$qtyRequested' data-accept-qty-orderId='$orderId'>批</button>\" . \"</td><td>\" .","\t\t\t\t    \t\"<button class='accept-change-qty-btn' data-accept-change-qty-orderTakenId='$orderTakenId' data-accept-change-qty-userName='$userName' data-accept-change-qty-orderId='$orderId' data-accept-change-qty-qtyLeft='$qtyLeft'>改并批</button>\" . \"</td><td>\" .","\t\t\t\t    \t\"<button class='reject-qty-btn' data-reject-orderTakenId='$orderTakenId' data-reject-userName='$userName'>拒</button>\" . \"</td></tr>\";","\t\t\t\t    \t//echo \"CAONIMA3\";","\t\t\t\t    \t//echo \"前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t    \t$oldOrderId = $orderId;","\t\t\t\t    \t//echo \"后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t}","\t\t\t\t}","\t\t\t\t//echo \"i是\" . $i . \"count是\" . $count . \"<br>\";","\t\t\t\t// 没显示","\t\t\t\tif ($i == $count){","\t\t\t\t\t//echo \"进来哦？？\";","\t\t\t\t\tif (isset($totalQtyRequested)){","\t\t\t\t\t\t//echo \"进来呀？\";","\t\t\t\t\t\techo \"</table><br>\";","\t\t\t\t\t\t//echo \"LAST共请求数量：\" . $totalQtyRequested . \"<br>\";","\t\t\t\t\t\techo \"共请求数量：\" . $totalQtyRequested . \"<br>\";","\t\t\t\t\t\tif ($isFull == false){","\t\t\t\t\t\t\t/*","\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)($totalQty) - ((int)($totalQtyRequested) + (int)($totalQtyTaken));","\t\t\t\t\t\t\tif ($qtyLeftNeededNew > 0){","\t\t\t\t\t\t\t\techo \"若全部批准，此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeededNew . \"</span>单。<br></div>\";","\t\t\t\t\t\t\t} else if ($qtyLeftNeededNew == 0){","\t\t\t\t\t\t\t\techo \"若全部批准，此单正好收全。<br></div>\";","\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)$qtyLeftNeededNew * (-1);","\t\t\t\t\t\t\t\techo \"注意！若全部批准，此单将<span style='color: red; font-size:20px'>超量\" . $qtyLeftNeededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t\t}*/","\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)$qtyLeft - (int)($totalQtyRequested);","\t\t\t\t\t\t\tif ($qtyLeftNeededNew > 0){","\t\t\t\t\t\t\t\techo \"若全部批准，此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeededNew . \"</span>单。<br></div>\";","\t\t\t\t\t\t\t} else if ($qtyLeftNeededNew == 0){","\t\t\t\t\t\t\t\techo \"若全部批准，此单正好收全。<br></div>\";","\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)$qtyLeftNeededNew * (-1);","\t\t\t\t\t\t\t\techo \"注意！若全部批准，此单将<span style='color: red; font-size:20px'>超量\" . $qtyLeftNeededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t\t}","","\t\t\t\t\t\t} else {/*","\t\t\t\t\t\t\t$qtyLeftExceeded = (int)($totalQtyTaken) - (int)($totalQty);","\t\t\t\t\t\t\t$qtyLeftExceededNew = (int)($totalQtyRequested) + (int)($qtyLeftExceeded);","\t\t\t\t\t\t\techo \"此单已超量<span style='color: red; font-size:20px'>\". $qtyLeftExceeded . \"</span>单！<br>\";","\t\t\t\t\t\t\techo \"若全部批准，此单将<span style='color: red; font-size:20px'>总超量\" . $qtyLeftExceededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t\t*/","\t\t\t\t\t\t\t$qtyLeftExceeded = (int)$qtyLeft * (-1);","\t\t\t\t\t\t\t$qtyLeftExceededNew = (int)($totalQtyRequested) + (int)($qtyLeftExceeded);","\t\t\t\t\t\t\tif ((int)$qtyLeftExceeded != 0){","\t\t\t\t\t\t\t\techo \"此单已超量<span style='color: red; font-size:20px'>\". $qtyLeftExceeded . \"</span>单！<br>\";","\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\techo \"注意！此单已<span style='color: red; font-size:20px'>正好收满了！</span><br>\";","\t\t\t\t\t\t\t}","\t\t\t\t\t\t\techo \"若全部批准，此单将<span style='color: red; font-size:20px'>总超量\" . $qtyLeftExceededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t}","\t\t\t\t\t} else {","\t\t\t\t\t\t","\t\t\t\t\t}","\t\t\t\t}","\t\t\t}","\t    } else {","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='nurse-requested' class='nav-link'>目前没有被护士报数的单子</a></h3>\";","\t    }","\t\t","\t\t","\t\t/* PART II */","\t\t","\t\t$sql = \"SELECT * FROM orderTaken WHERE orderStatus='1' ORDER BY orderId DESC, orderTakenTime DESC\";","\t\t$stmt = $pdo->prepare($sql);","\t    $stmt->execute();","\t    $count = $stmt->rowCount();","\t    if ($count > 0){","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='nurse-taken' class='nav-link'>以下为护士已确认申领的单子</a></h3>\";","\t    \techo \"<table><tr><th>护士</th><th>QQ</th><th>数量</th><th>货名</th><th>链接</th><th>单价</th><th>收价</th><th>领单时间</th></tr>\";","\t\t    while ($row = $stmt->fetch()){","\t\t    \t$userId = $row[\"userId\"];","\t\t    \t$sql2 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t    \t$stmt2 = $pdo->prepare($sql2);","\t\t    \t$stmt2->execute();","\t\t    \tif($row2 = $stmt2->fetch()){","\t\t    \t\t$userName = $row2[\"userName\"];","\t\t    \t\t$userQQ = $row2[\"userQQ\"];","\t\t    \t}","","\t\t    \t$orderId = $row[\"orderId\"];","\t\t    \t$sql3 = \"SELECT * FROM orders WHERE orderId='$orderId'\";","\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t    \t$stmt3->execute();","\t\t    \tif($row3 = $stmt3->fetch()){","\t\t    \t\t$itemName = $row3[\"itemName\"];","\t\t    \t\t$itemLink = makeLink($row3[\"itemLink\"]);","\t\t    \t\t$itemCost = $row3[\"itemCost\"];","\t\t    \t\t$itemReceivingPrice = $row3[\"itemReceivingPrice\"];","\t\t    \t}","","\t\t    \t$qtyTaken = $row[\"qtyTaken\"];","\t\t    \t$orderTakenTime = $row[\"orderTakenTime\"];","\t\t    \t","\t\t    \t$tableRow = \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyTaken . \"</td><td>\" . $itemName . \"</td><td>\" . $itemLink . \"</td><td>\" . $itemCost . \"</td><td>\" . $itemReceivingPrice . \"</td><td>\" . $orderTakenTime .  \"</td></tr>\";","\t\t    \techo $tableRow;","\t\t    }","\t\t    echo \"</table><br>\";","\t    } else {","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='nurse-taken' class='nav-link'>目前没有护士申领新单子</a></h3>\";","\t    }","\t    ","\t    ","\t    ","\t    /* Part III */\t    ","\t\t//http://stackoverflow.com/questions/43478069/best-way-to-identify-a-mysql-changed-group-by-field-value-in-a-statement-fetch","\t\t// My question","\t\t$sql = \"SELECT * FROM orderTaken WHERE orderStatus='11' ORDER BY orderId DESC, orderTakenTime DESC\";","\t\t$stmt = $pdo->prepare($sql);","\t    $stmt->execute();","\t    $count = $stmt->rowCount();","\t    if ($count > 0){","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='already-accepted' class='nav-link'>以下为已批准的单子，正等待护士确认。</a></h3>\";","\t    \tfor ($i = 0; $i < $count + 1; $i++){","\t\t\t\tif ($row = $stmt->fetch()){","\t\t\t\t\t$orderId = $row[\"orderId\"];","\t\t\t\t\t$qtyRequested = $row[\"qtyTaken\"];","\t\t\t\t\t$requestedTime = $row[\"lastModifiedTime\"];","\t\t\t\t\t$orderTakenId = $row[\"orderTakenId\"];","\t\t\t\t\t//$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\tif (isset($newOldOrderId)){","\t\t\t\t\t\tif ($newOldOrderId != $orderId){","\t\t\t\t\t\t\t/*","\t\t\t\t\t\t\techo \"看看\" . $oldOrderId;","\t\t\t\t\t\t\techo \"NEWNEW\";*/","\t\t\t\t\t\t\techo \"</table><br>\";","\t\t\t\t\t\t\t//echo \"NEWNEW2\";","\t\t\t\t\t\t\techo \"等待下单总数：\" . $totalQtyRequested . \"<br></div>\";","\t\t\t\t\t\t\t$totalQtyRequested = 0;","\t\t\t\t\t\t\t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t\t\t//echo \"前Sequence\" . $orderIdChangeSequence;","\t\t\t\t\t\t\t$orderIdChangeSequence++;","\t\t\t\t\t\t\t//echo \"后Sequence\" . $orderIdChangeSequence;","\t\t\t\t\t\t\techo \"<div orderSequenceNum='$orderIdChangeSequence'>单子：\" . $orderIdChangeSequence . \"<br>\";","\t\t\t\t\t\t\t$sql2 = \"SELECT * FROM orders WHERE orderId='$orderId'\";","\t\t\t\t\t\t\t$stmt2 = $pdo->prepare($sql2);","\t\t\t\t\t    \t$stmt2->execute();","\t\t\t\t\t    \tif($row2 = $stmt2->fetch()){","\t\t\t\t\t    \t\t$itemName = $row2[\"itemName\"];","\t\t\t\t\t    \t\t$itemLink = makeLink($row2[\"itemLink\"]);","\t\t\t\t\t    \t\t$itemCost = $row2[\"itemCost\"];","\t\t\t\t\t    \t\t$itemReceivingPrice = $row2[\"itemReceivingPrice\"];","\t\t\t\t\t    \t\t$totalQty = $row2[\"totalQty\"];","\t\t\t\t\t    \t\t$totalQtyTaken = $row2[\"totalQtyTaken\"];","\t\t\t\t\t    \t\t$qtyLeft = $row2[\"qtyLeft\"];","\t\t\t\t\t    \t\t$creationTime = $row2[\"creationTime\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \t$orderInfoGeneral = \"货名: \" . $itemName . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"链接: \" . $itemLink . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"单价: \" . $itemCost . \"<br>\" .","\t\t\t\t\t\t    \t\t\t\t\t\"收价: \" . $itemReceivingPrice . \"<br>\" . ","\t\t\t\t\t\t\t\t\t\t\t\t\"订单建立时间\" . $creationTime . \"<br>\" .","\t\t\t\t\t\t\t\t\t\t\t\t\"目标收货数量\" . $totalQty . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"护士已下数量\" . $totalQtyTaken . \"<br>\";","\t\t\t\t\t    \t//if ((int)($totalQtyTaken) >= (int)($totalQty)) {","\t\t\t\t\t    \tif ($qtyLeft == 0) {","\t\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>此单已收满！</span><br>\";","\t\t\t\t\t    \t} else if ($qtyLeft < 0){","\t\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>此单已超收\" . (int)$qtyLeft * (-1) . \"单！</span><br>\";","\t\t\t\t\t    \t} else {","\t\t\t\t\t    \t\t//$qtyLeftNeeded = (int)($totalQty) - (int)($totalQtyTaken);","\t\t\t\t\t    \t\t//echo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeeded . \"</span>单。<br>\";","\t\t\t\t\t    \t\techo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeft . \"</span>单。<br>\";","\t\t\t\t\t    \t}","\t\t\t\t\t    \t//echo \"DEBUG 1\";","\t\t\t\t\t    \techo \"<table><tr><th>护士</th><th>QQ</th><th>等待下单数量</th><th>请求时间</th></tr>\";","\t\t\t\t\t    \t//echo \"FUCK\";","\t\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t\t    \t$stmt3->execute();","\t\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td></tr>\" .","\t\t\t\t\t    \t//echo \"不一样前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    \t$newOldOrderId = $orderId;","\t\t\t\t\t    \t//echo \"不一样后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    //$oldOrderId == $orderId","\t\t\t\t\t    } else {","\t\t\t\t\t    \t//echo \"SAME\";","\t\t\t\t\t    \t//若一样则继续print","\t\t\t\t\t    \t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t\t    \t$stmt3->execute();","\t\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \t//echo \"SAME YEA\";","\t\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td></tr>\";","\t\t\t\t\t    \t//echo \"一样前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    \t$newOldOrderId = $orderId;","\t\t\t\t\t    \t//echo \"一样后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    }","\t\t\t\t\t} else {","\t\t\t\t\t\t//echo \"XIN\";","\t\t\t\t\t\t//全新","\t\t\t\t\t\t$orderIdChangeSequence = 0;","\t\t\t\t\t\t$totalQtyRequested = 0;","\t\t\t\t\t\t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t\t$orderIdChangeSequence++;","\t\t\t\t\t\techo \"<div orderSequenceNum='$orderIdChangeSequence'>单子：\" . $orderIdChangeSequence . \"<br>\";","\t\t\t\t\t\t$sql2 = \"SELECT * FROM orders WHERE orderId='$orderId'\";","\t\t\t\t\t\t$stmt2 = $pdo->prepare($sql2);","\t\t\t\t    \t$stmt2->execute();","\t\t\t\t    \tif($row2 = $stmt2->fetch()){","\t\t\t\t    \t\t$itemName = $row2[\"itemName\"];","\t\t\t\t    \t\t$itemLink = makeLink($row2[\"itemLink\"]);","\t\t\t\t    \t\t$itemCost = $row2[\"itemCost\"];","\t\t\t\t    \t\t$itemReceivingPrice = $row2[\"itemReceivingPrice\"];","\t\t\t\t    \t\t$totalQty = $row2[\"totalQty\"];","\t\t\t\t    \t\t$totalQtyTaken = $row2[\"totalQtyTaken\"];","\t\t\t\t    \t\t$qtyLeft = $row2[\"qtyLeft\"];","\t\t\t\t    \t\t$creationTime = $row2[\"creationTime\"];","\t\t\t\t    \t}","\t\t\t\t    \t$orderInfoGeneral = \"货名: \" . $itemName . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"链接: \" . $itemLink . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"单价: \" . $itemCost . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\"收价: \" . $itemReceivingPrice . \"<br>\" . ","\t\t\t\t\t\t\t\t\t\t\t\"订单建立时间\" . $creationTime . \"<br>\" .","\t\t\t\t\t\t\t\t\t\t\t\"目标收货数量\" . $totalQty . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"护士已下数量\" . $totalQtyTaken . \"<br>\";","\t\t\t\t    \t//if ((int)($totalQtyTaken) >= (int)($totalQty)) {","\t\t\t    \t\tif ($qtyLeft == 0) {","\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>此单已收满！</span><br>\";","\t\t\t\t    \t} else if ($qtyLeft < 0){","\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>此单已超收\" . (int)$qtyLeft * (-1) . \"单！</span><br>\";","\t\t\t\t    \t} else {","\t\t\t\t    \t\t//$qtyLeftNeeded = (int)($totalQty) - (int)($totalQtyTaken);","\t\t\t\t    \t\t//echo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeeded . \"</span>单。<br>\";","\t\t\t\t    \t\techo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeft . \"</span>单。<br>\";","\t\t\t\t    \t}","\t\t\t\t    \t/*echo \"DEBUG2\";","\t\t\t\t    \techo \"oldOrderId第一次：\";","\t\t\t\t    \techo $oldOrderId;","\t\t\t\t    \techo \"CAONIMA0\";*/","\t\t\t\t    \techo \"<table><tr><th>护士</th><th>QQ</th><th>等待下单数量</th><th>请求时间</th></tr>\";","\t\t\t\t    \t//echo \"CAONIMA\";","\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t    \t$stmt3->execute();","\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t    \t}","\t\t\t\t    \t//echo \"CAONIMA2\";","\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td></tr>\";","\t\t\t\t    \t//echo \"CAONIMA3\";","\t\t\t\t    \t//echo \"前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t    \t$newOldOrderId = $orderId;","\t\t\t\t    \t//echo \"后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t}","\t\t\t\t}","\t\t\t\t//echo \"i是\" . $i . \"count是\" . $count . \"<br>\";","\t\t\t\t// 没显示","\t\t\t\tif ($i == $count){","\t\t\t\t\t//echo \"进来哦？？\";","\t\t\t\t\tif (isset($totalQtyRequested)){","\t\t\t\t\t\t//echo \"进来呀？\";","\t\t\t\t\t\techo \"</table><br>\";","\t\t\t\t\t\t//echo \"LAST共请求数量：\" . $totalQtyRequested . \"<br>\";","\t\t\t\t\t\techo \"等待下单总数：\" . $totalQtyRequested . \"<br></div>\";","\t\t\t\t\t} else {","\t\t\t\t\t\t","\t\t\t\t\t}","\t\t\t\t}","\t\t\t}","\t\t    echo \"</table>\";","\t    } else {","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='already-accepted' class='nav-link'>没有新批准的单子</a></h3>\";","\t    }","\t\t","\t    $pdo->commit();","","\t} ","\tcatch(Exception $e){","\t    echo $e->getMessage();","\t    $pdo->rollBack();","\t}","","","?>"],"id":760},{"start":{"row":0,"column":0},"end":{"row":482,"column":2},"action":"insert","lines":["<?php","","\tsession_start();","","\tfunction makeLink($url)","\t{","\t\treturn (\"<a href=\" . $url . \" target='_blank'>\" . $url . \"</a>\");","\t}","","\t$pdo = new PDO('mysql:host=localhost;dbname=chenh057_realPro', 'chenh057_hang01', 'bhgoszPg7iBcYD8WLAjeWrjEcH3LUcE96vHqCdGKnpNWZetxe', array(","\t    PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,","\t    PDO::ATTR_EMULATE_PREPARES => false","\t));","","\t$pdo->beginTransaction();","\t","\ttry{","\t\t","\t\t//http://stackoverflow.com/questions/43478069/best-way-to-identify-a-mysql-changed-group-by-field-value-in-a-statement-fetch","\t\t// My question","\t\t$sql = \"SELECT * FROM orderTaken WHERE orderStatus='10' ORDER BY orderId DESC, orderTakenTime DESC\";","\t\t$stmt = $pdo->prepare($sql);","\t    $stmt->execute();","\t    $count = $stmt->rowCount();","\t    if ($count > 0){","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='nurse-requested' class='nav-link'>以下为护士报数的单子，请依情况执行操作。</a></h3>\";","\t    \tfor ($i = 0; $i < $count + 1; $i++){","\t\t\t\tif ($row = $stmt->fetch()){","\t\t\t\t\t$orderId = $row[\"orderId\"];","\t\t\t\t\t$qtyRequested = $row[\"qtyTaken\"];","\t\t\t\t\t$requestedTime = $row[\"lastModifiedTime\"];","\t\t\t\t\t$orderTakenId = $row[\"orderTakenId\"];","\t\t\t\t\t//$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\tif (isset($oldOrderId)){","\t\t\t\t\t\tif ($oldOrderId != $orderId){","\t\t\t\t\t\t\t/*","\t\t\t\t\t\t\techo \"看看\" . $oldOrderId;","\t\t\t\t\t\t\techo \"NEWNEW\";*/","\t\t\t\t\t\t\techo \"</table><br>\";","\t\t\t\t\t\t\t//echo \"NEWNEW2\";","\t\t\t\t\t\t\techo \"共请求数量：\" . $totalQtyRequested . \"<br>\";","\t\t\t\t\t\t\tif ($isFull == false){","\t\t\t\t\t\t\t\t//$qtyLeftNeededNew = (int)($totalQty) - ((int)($totalQtyRequested) + (int)($totalQtyTaken));","\t\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)$qtyLeft - (int)($totalQtyRequested);","\t\t\t\t\t\t\t\tif ($qtyLeftNeededNew > 0){","\t\t\t\t\t\t\t\t\techo \"若全部批准，此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeededNew . \"</span>单。<br></div>\";","\t\t\t\t\t\t\t\t} else if ($qtyLeftNeededNew == 0){","\t\t\t\t\t\t\t\t\techo \"若全部批准，此单正好收全。<br></div>\";","\t\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)$qtyLeftNeededNew * (-1);","\t\t\t\t\t\t\t\t\techo \"注意！若全部批准，此单将<span style='color: red; font-size:20px'>超量\" . $qtyLeftNeededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t\t\t}","\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\t//$qtyLeftExceeded = (int)($totalQtyTaken) - (int)($totalQty);","\t\t\t\t\t\t\t\t$qtyLeftExceeded = (int)$qtyLeft * (-1);","\t\t\t\t\t\t\t\t$qtyLeftExceededNew = (int)($totalQtyRequested) + (int)($qtyLeftExceeded);","\t\t\t\t\t\t\t\tif ((int)$qtyLeftExceeded != 0){","\t\t\t\t\t\t\t\t\techo \"此单已超量<span style='color: red; font-size:20px'>\". $qtyLeftExceeded . \"</span>单！<br>\";","\t\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\t\techo \"注意！此单已<span style='color: red; font-size:20px'>正好收满了！</span><br>\";","\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t","\t\t\t\t\t\t\t\techo \"若全部批准，此单将<span style='color: red; font-size:20px'>总超量\" . $qtyLeftExceededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t\t}","\t\t\t\t\t\t\t$totalQtyRequested = 0;","\t\t\t\t\t\t\t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t\t\t//echo \"前Sequence\" . $orderIdChangeSequence;","\t\t\t\t\t\t\t$orderIdChangeSequence++;","\t\t\t\t\t\t\t//echo \"后Sequence\" . $orderIdChangeSequence;","\t\t\t\t\t\t\techo \"<div orderSequenceNum='$orderIdChangeSequence'>单子：\" . $orderIdChangeSequence . \"<br>\";","\t\t\t\t\t\t\t$sql2 = \"SELECT * FROM orders WHERE orderId='$orderId'\";","\t\t\t\t\t\t\t$stmt2 = $pdo->prepare($sql2);","\t\t\t\t\t    \t$stmt2->execute();","\t\t\t\t\t    \tif($row2 = $stmt2->fetch()){","\t\t\t\t\t    \t\t$itemName = $row2[\"itemName\"];","\t\t\t\t\t    \t\t$itemLink = makeLink($row2[\"itemLink\"]);","\t\t\t\t\t    \t\t$itemCost = $row2[\"itemCost\"];","\t\t\t\t\t    \t\t$itemReceivingPrice = $row2[\"itemReceivingPrice\"];","\t\t\t\t\t    \t\t$totalQty = $row2[\"totalQty\"];","\t\t\t\t\t    \t\t$totalQtyTaken = $row2[\"totalQtyTaken\"];","\t\t\t\t\t    \t\t$qtyLeft = $row2[\"qtyLeft\"];","\t\t\t\t\t    \t\t$creationTime = $row2[\"creationTime\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \t$orderInfoGeneral = \"货名: \" . $itemName . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"链接: \" . $itemLink . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"单价: \" . $itemCost . \"<br>\" .","\t\t\t\t\t\t    \t\t\t\t\t\"收价: \" . $itemReceivingPrice . \"<br>\" . ","\t\t\t\t\t\t\t\t\t\t\t\t\"订单建立时间\" . $creationTime . \"<br>\" .","\t\t\t\t\t\t\t\t\t\t\t\t\"目标收货数量\" . $totalQty . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"护士已下数量\" . $totalQtyTaken . \"<br>\";","\t\t\t\t\t    \t//if ((int)($totalQtyTaken) >= (int)($totalQty)) {","\t\t\t\t\t    \tif ($qtyLeft <= 0) {","\t\t\t\t\t    \t\t$isFull = true;","\t\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>注意，此单已收满！</span><br>\";","\t\t\t\t\t    \t} else {","\t\t\t\t\t    \t\t$isFull = false;","\t\t\t\t\t    \t\t//$qtyLeftNeeded = (int)($totalQty) - (int)($totalQtyTaken);","\t\t\t\t\t    \t\t//echo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeeded . \"</span>单。<br>\";","\t\t\t\t\t    \t\techo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeft . \"</span>单。<br>\";","\t\t\t\t\t    \t}","\t\t\t\t\t    \t//echo \"DEBUG 1\";","\t\t\t\t\t    \techo \"<table><tr><th>护士</th><th>QQ</th><th>请求数量</th><th>请求时间</th><th>批准</th><th>修改并批数量</th><th>拒绝</th></tr>\";","\t\t\t\t\t    \t//echo \"FUCK\";","\t\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t\t    \t$stmt3->execute();","\t\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td></tr>\" .","\t\t\t\t\t    \t\"<button class='accept-qty-btn' data-accept-orderTakenId='$orderTakenId' data-accept-qtyRequested='$qtyRequested' data-accept-qty-orderId='$orderId'>批</button>\" . \"</td><td>\" .","\t\t\t\t\t    \t\"<button class='accept-change-qty-btn' data-accept-change-qty-orderTakenId='$orderTakenId' data-accept-change-qty-userName='$userName' data-accept-change-qty-orderId='$orderId' data-accept-change-qty-qtyLeft='$qtyLeft'>改并批</button>\" . \"</td><td>\" .","\t\t\t\t\t    \t\"<button class='reject-qty-btn' data-reject-orderTakenId='$orderTakenId' data-reject-userName='$userName'>拒</button>\" . \"</td></tr>\";","\t\t\t\t\t    \t//echo \"不一样前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    \t$oldOrderId = $orderId;","\t\t\t\t\t    \t//echo \"不一样后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    //$oldOrderId == $orderId","\t\t\t\t\t    } else {","\t\t\t\t\t    \t//echo \"SAME\";","\t\t\t\t\t    \t//若一样则继续print","\t\t\t\t\t    \t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t\t    \t$stmt3->execute();","\t\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \t//echo \"SAME YEA\";","\t\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td></tr>\" .","\t\t\t\t\t    \t\"<button class='accept-qty-btn' data-accept-orderTakenId='$orderTakenId' data-accept-qtyRequested='$qtyRequested' data-accept-qty-orderId='$orderId'>批</button>\" . \"</td><td>\" .","\t\t\t\t\t    \t\"<button class='accept-change-qty-btn' data-accept-change-qty-orderTakenId='$orderTakenId' data-accept-change-qty-userName='$userName' data-accept-change-qty-orderId='$orderId' data-accept-change-qty-qtyLeft='$qtyLeft'>改并批</button>\" . \"</td><td>\" .","\t\t\t\t\t    \t\"<button class='reject-qty-btn' data-reject-orderTakenId='$orderTakenId' data-reject-userName='$userName'>拒</button>\" . \"</td></tr>\";","\t\t\t\t\t    \t//echo \"一样前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    \t$oldOrderId = $orderId;","\t\t\t\t\t    \t//echo \"一样后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    }","\t\t\t\t\t} else {","\t\t\t\t\t\t//echo \"XIN\";","\t\t\t\t\t\t//全新","\t\t\t\t\t\t// 检查应该是无误了 041917 101920am 3E","\t\t\t\t\t\t$orderIdChangeSequence = 0;","\t\t\t\t\t\t$totalQtyRequested = 0;","\t\t\t\t\t\t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t\t$orderIdChangeSequence++;","\t\t\t\t\t\techo \"<div orderSequenceNum='$orderIdChangeSequence'>单子：\" . $orderIdChangeSequence . \"<br>\";","\t\t\t\t\t\t$sql2 = \"SELECT * FROM orders WHERE orderId='$orderId'\";","\t\t\t\t\t\t$stmt2 = $pdo->prepare($sql2);","\t\t\t\t    \t$stmt2->execute();","\t\t\t\t    \tif($row2 = $stmt2->fetch()){","\t\t\t\t    \t\t$itemName = $row2[\"itemName\"];","\t\t\t\t    \t\t$itemLink = makeLink($row2[\"itemLink\"]);","\t\t\t\t    \t\t$itemCost = $row2[\"itemCost\"];","\t\t\t\t    \t\t$itemReceivingPrice = $row2[\"itemReceivingPrice\"];","\t\t\t\t    \t\t$totalQty = $row2[\"totalQty\"];","\t\t\t\t    \t\t$totalQtyTaken = $row2[\"totalQtyTaken\"];","\t\t\t\t    \t\t$qtyLeft = $row2[\"qtyLeft\"];","\t\t\t\t    \t\t$creationTime = $row2[\"creationTime\"];","\t\t\t\t    \t}","\t\t\t\t    \t$orderInfoGeneral = \"货名: \" . $itemName . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"链接: \" . $itemLink . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"单价: \" . $itemCost . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\"收价: \" . $itemReceivingPrice . \"<br>\" . ","\t\t\t\t\t\t\t\t\t\t\t\"订单建立时间\" . $creationTime . \"<br>\" .","\t\t\t\t\t\t\t\t\t\t\t\"目标收货数量\" . $totalQty . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"护士已下数量\" . $totalQtyTaken . \"<br>\";","\t\t\t\t    \t//if ((int)($totalQtyTaken) >= (int)($totalQty)) {","\t\t\t\t    \tif ($qtyLeft <= 0) {","\t\t\t\t    \t\t$isFull = true;","\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>注意，此单已收满！</span><br>\";","\t\t\t\t    \t} else {","\t\t\t\t    \t\t$isFull = false;","\t\t\t\t    \t\t//$qtyLeftNeeded = (int)($totalQty) - (int)($totalQtyTaken);","\t\t\t\t    \t\techo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeft . \"</span>单。<br>\";","\t\t\t\t    \t}","\t\t\t\t    \t/*echo \"DEBUG2\";","\t\t\t\t    \techo \"oldOrderId第一次：\";","\t\t\t\t    \techo $oldOrderId;","\t\t\t\t    \techo \"CAONIMA0\";*/","\t\t\t\t    \techo \"<table><tr><th>护士</th><th>QQ</th><th>请求数量</th><th>请求时间</th><th>批准</th><th>修改并批数量</th><th>拒绝</th></tr>\";","\t\t\t\t    \t//echo \"CAONIMA\";","\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t    \t$stmt3->execute();","\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t    \t}","\t\t\t\t    \t//echo \"CAONIMA2\";","\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td></tr>\" .","\t\t\t\t    \t\"<button class='accept-qty-btn' data-accept-orderTakenId='$orderTakenId' data-accept-qtyRequested='$qtyRequested' data-accept-qty-orderId='$orderId'>批</button>\" . \"</td><td>\" .","\t\t\t\t    \t\"<button class='accept-change-qty-btn' data-accept-change-qty-orderTakenId='$orderTakenId' data-accept-change-qty-userName='$userName' data-accept-change-qty-orderId='$orderId' data-accept-change-qty-qtyLeft='$qtyLeft'>改并批</button>\" . \"</td><td>\" .","\t\t\t\t    \t\"<button class='reject-qty-btn' data-reject-orderTakenId='$orderTakenId' data-reject-userName='$userName'>拒</button>\" . \"</td></tr>\";","\t\t\t\t    \t//echo \"CAONIMA3\";","\t\t\t\t    \t//echo \"前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t    \t$oldOrderId = $orderId;","\t\t\t\t    \t//echo \"后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t}","\t\t\t\t}","\t\t\t\t//echo \"i是\" . $i . \"count是\" . $count . \"<br>\";","\t\t\t\t// 没显示","\t\t\t\tif ($i == $count){","\t\t\t\t\t//echo \"进来哦？？\";","\t\t\t\t\tif (isset($totalQtyRequested)){","\t\t\t\t\t\t//echo \"进来呀？\";","\t\t\t\t\t\techo \"</table><br>\";","\t\t\t\t\t\t//echo \"LAST共请求数量：\" . $totalQtyRequested . \"<br>\";","\t\t\t\t\t\techo \"共请求数量：\" . $totalQtyRequested . \"<br>\";","\t\t\t\t\t\tif ($isFull == false){","\t\t\t\t\t\t\t/*","\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)($totalQty) - ((int)($totalQtyRequested) + (int)($totalQtyTaken));","\t\t\t\t\t\t\tif ($qtyLeftNeededNew > 0){","\t\t\t\t\t\t\t\techo \"若全部批准，此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeededNew . \"</span>单。<br></div>\";","\t\t\t\t\t\t\t} else if ($qtyLeftNeededNew == 0){","\t\t\t\t\t\t\t\techo \"若全部批准，此单正好收全。<br></div>\";","\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)$qtyLeftNeededNew * (-1);","\t\t\t\t\t\t\t\techo \"注意！若全部批准，此单将<span style='color: red; font-size:20px'>超量\" . $qtyLeftNeededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t\t}*/","\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)$qtyLeft - (int)($totalQtyRequested);","\t\t\t\t\t\t\tif ($qtyLeftNeededNew > 0){","\t\t\t\t\t\t\t\techo \"若全部批准，此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeededNew . \"</span>单。<br></div>\";","\t\t\t\t\t\t\t} else if ($qtyLeftNeededNew == 0){","\t\t\t\t\t\t\t\techo \"若全部批准，此单正好收全。<br></div>\";","\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)$qtyLeftNeededNew * (-1);","\t\t\t\t\t\t\t\techo \"注意！若全部批准，此单将<span style='color: red; font-size:20px'>超量\" . $qtyLeftNeededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t\t}","","\t\t\t\t\t\t} else {/*","\t\t\t\t\t\t\t$qtyLeftExceeded = (int)($totalQtyTaken) - (int)($totalQty);","\t\t\t\t\t\t\t$qtyLeftExceededNew = (int)($totalQtyRequested) + (int)($qtyLeftExceeded);","\t\t\t\t\t\t\techo \"此单已超量<span style='color: red; font-size:20px'>\". $qtyLeftExceeded . \"</span>单！<br>\";","\t\t\t\t\t\t\techo \"若全部批准，此单将<span style='color: red; font-size:20px'>总超量\" . $qtyLeftExceededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t\t*/","\t\t\t\t\t\t\t$qtyLeftExceeded = (int)$qtyLeft * (-1);","\t\t\t\t\t\t\t$qtyLeftExceededNew = (int)($totalQtyRequested) + (int)($qtyLeftExceeded);","\t\t\t\t\t\t\tif ((int)$qtyLeftExceeded != 0){","\t\t\t\t\t\t\t\techo \"此单已超量<span style='color: red; font-size:20px'>\". $qtyLeftExceeded . \"</span>单！<br>\";","\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\techo \"注意！此单已<span style='color: red; font-size:20px'>正好收满了！</span><br>\";","\t\t\t\t\t\t\t}","\t\t\t\t\t\t\techo \"若全部批准，此单将<span style='color: red; font-size:20px'>总超量\" . $qtyLeftExceededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t}","\t\t\t\t\t} else {","\t\t\t\t\t\t","\t\t\t\t\t}","\t\t\t\t}","\t\t\t}","\t    } else {","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='nurse-requested' class='nav-link'>目前没有被护士报数的单子</a></h3>\";","\t    }","\t\t","\t\t","\t\t/* PART II */","\t\t","\t\t$sql = \"SELECT * FROM orderTaken WHERE orderStatus='1' ORDER BY orderId DESC, orderTakenTime DESC\";","\t\t$stmt = $pdo->prepare($sql);","\t    $stmt->execute();","\t    $count = $stmt->rowCount();","\t    if ($count > 0){","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='nurse-taken' class='nav-link'>以下为护士已确认申领的单子</a></h3>\";","\t    \techo \"<table><tr><th>护士</th><th>QQ</th><th>数量</th><th>货名</th><th>链接</th><th>单价</th><th>收价</th><th>领单时间</th></tr>\";","\t\t    while ($row = $stmt->fetch()){","\t\t    \t$userId = $row[\"userId\"];","\t\t    \t$sql2 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t    \t$stmt2 = $pdo->prepare($sql2);","\t\t    \t$stmt2->execute();","\t\t    \tif($row2 = $stmt2->fetch()){","\t\t    \t\t$userName = $row2[\"userName\"];","\t\t    \t\t$userQQ = $row2[\"userQQ\"];","\t\t    \t}","","\t\t    \t$orderId = $row[\"orderId\"];","\t\t    \t$sql3 = \"SELECT * FROM orders WHERE orderId='$orderId'\";","\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t    \t$stmt3->execute();","\t\t    \tif($row3 = $stmt3->fetch()){","\t\t    \t\t$itemName = $row3[\"itemName\"];","\t\t    \t\t$itemLink = makeLink($row3[\"itemLink\"]);","\t\t    \t\t$itemCost = $row3[\"itemCost\"];","\t\t    \t\t$itemReceivingPrice = $row3[\"itemReceivingPrice\"];","\t\t    \t}","","\t\t    \t$qtyTaken = $row[\"qtyTaken\"];","\t\t    \t$orderTakenTime = $row[\"orderTakenTime\"];","\t\t    \t","\t\t    \t$tableRow = \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyTaken . \"</td><td>\" . $itemName . \"</td><td>\" . $itemLink . \"</td><td>\" . $itemCost . \"</td><td>\" . $itemReceivingPrice . \"</td><td>\" . $orderTakenTime .  \"</td></tr>\";","\t\t    \techo $tableRow;","\t\t    }","\t\t    echo \"</table><br>\";","\t    } else {","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='nurse-taken' class='nav-link'>目前没有护士申领新单子</a></h3>\";","\t    }","\t    ","\t    ","\t    ","\t    /* Part III */\t    ","\t\t//http://stackoverflow.com/questions/43478069/best-way-to-identify-a-mysql-changed-group-by-field-value-in-a-statement-fetch","\t\t// My question","\t\t$sql = \"SELECT * FROM orderTaken WHERE orderStatus='11' ORDER BY orderId DESC, orderTakenTime DESC\";","\t\t$stmt = $pdo->prepare($sql);","\t    $stmt->execute();","\t    $count = $stmt->rowCount();","\t    if ($count > 0){","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='already-accepted' class='nav-link'>以下为已批准的单子，正等待护士确认。</a></h3>\";","\t    \tfor ($i = 0; $i < $count + 1; $i++){","\t\t\t\tif ($row = $stmt->fetch()){","\t\t\t\t\t$orderId = $row[\"orderId\"];","\t\t\t\t\t$qtyRequested = $row[\"qtyTaken\"];","\t\t\t\t\t$requestedTime = $row[\"lastModifiedTime\"];","\t\t\t\t\t$orderTakenId = $row[\"orderTakenId\"];","\t\t\t\t\t//$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\tif (isset($newOldOrderId)){","\t\t\t\t\t\tif ($newOldOrderId != $orderId){","\t\t\t\t\t\t\t/*","\t\t\t\t\t\t\techo \"看看\" . $oldOrderId;","\t\t\t\t\t\t\techo \"NEWNEW\";*/","\t\t\t\t\t\t\techo \"</table><br>\";","\t\t\t\t\t\t\t//echo \"NEWNEW2\";","\t\t\t\t\t\t\techo \"等待下单总数：\" . $totalQtyRequested . \"<br></div>\";","\t\t\t\t\t\t\t$totalQtyRequested = 0;","\t\t\t\t\t\t\t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t\t\t//echo \"前Sequence\" . $orderIdChangeSequence;","\t\t\t\t\t\t\t$orderIdChangeSequence++;","\t\t\t\t\t\t\t//echo \"后Sequence\" . $orderIdChangeSequence;","\t\t\t\t\t\t\techo \"<div orderSequenceNum='$orderIdChangeSequence'>单子：\" . $orderIdChangeSequence . \"<br>\";","\t\t\t\t\t\t\t$sql2 = \"SELECT * FROM orders WHERE orderId='$orderId'\";","\t\t\t\t\t\t\t$stmt2 = $pdo->prepare($sql2);","\t\t\t\t\t    \t$stmt2->execute();","\t\t\t\t\t    \tif($row2 = $stmt2->fetch()){","\t\t\t\t\t    \t\t$itemName = $row2[\"itemName\"];","\t\t\t\t\t    \t\t$itemLink = makeLink($row2[\"itemLink\"]);","\t\t\t\t\t    \t\t$itemCost = $row2[\"itemCost\"];","\t\t\t\t\t    \t\t$itemReceivingPrice = $row2[\"itemReceivingPrice\"];","\t\t\t\t\t    \t\t$totalQty = $row2[\"totalQty\"];","\t\t\t\t\t    \t\t$totalQtyTaken = $row2[\"totalQtyTaken\"];","\t\t\t\t\t    \t\t$qtyLeft = $row2[\"qtyLeft\"];","\t\t\t\t\t    \t\t$creationTime = $row2[\"creationTime\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \t$orderInfoGeneral = \"货名: \" . $itemName . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"链接: \" . $itemLink . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"单价: \" . $itemCost . \"<br>\" .","\t\t\t\t\t\t    \t\t\t\t\t\"收价: \" . $itemReceivingPrice . \"<br>\" . ","\t\t\t\t\t\t\t\t\t\t\t\t\"订单建立时间\" . $creationTime . \"<br>\" .","\t\t\t\t\t\t\t\t\t\t\t\t\"目标收货数量\" . $totalQty . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"护士已下数量\" . $totalQtyTaken . \"<br>\";","\t\t\t\t\t    \t//if ((int)($totalQtyTaken) >= (int)($totalQty)) {","\t\t\t\t\t    \tif ($qtyLeft == 0) {","\t\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>此单已收满！</span><br>\";","\t\t\t\t\t    \t} else if ($qtyLeft < 0){","\t\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>此单已超收\" . (int)$qtyLeft * (-1) . \"单！</span><br>\";","\t\t\t\t\t    \t} else {","\t\t\t\t\t    \t\t//$qtyLeftNeeded = (int)($totalQty) - (int)($totalQtyTaken);","\t\t\t\t\t    \t\t//echo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeeded . \"</span>单。<br>\";","\t\t\t\t\t    \t\techo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeft . \"</span>单。<br>\";","\t\t\t\t\t    \t}","\t\t\t\t\t    \t//echo \"DEBUG 1\";","\t\t\t\t\t    \techo \"<table><tr><th>护士</th><th>QQ</th><th>等待下单数量</th><th>请求时间</th></tr>\";","\t\t\t\t\t    \t//echo \"FUCK\";","\t\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t\t    \t$stmt3->execute();","\t\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td></tr>\" .","\t\t\t\t\t    \t//echo \"不一样前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    \t$newOldOrderId = $orderId;","\t\t\t\t\t    \t//echo \"不一样后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    //$oldOrderId == $orderId","\t\t\t\t\t    } else {","\t\t\t\t\t    \t//echo \"SAME\";","\t\t\t\t\t    \t//若一样则继续print","\t\t\t\t\t    \t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t\t    \t$stmt3->execute();","\t\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \t//echo \"SAME YEA\";","\t\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td></tr>\";","\t\t\t\t\t    \t//echo \"一样前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    \t$newOldOrderId = $orderId;","\t\t\t\t\t    \t//echo \"一样后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    }","\t\t\t\t\t} else {","\t\t\t\t\t\t//echo \"XIN\";","\t\t\t\t\t\t//全新","\t\t\t\t\t\t$orderIdChangeSequence = 0;","\t\t\t\t\t\t$totalQtyRequested = 0;","\t\t\t\t\t\t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t\t$orderIdChangeSequence++;","\t\t\t\t\t\techo \"<div orderSequenceNum='$orderIdChangeSequence'>单子：\" . $orderIdChangeSequence . \"<br>\";","\t\t\t\t\t\t$sql2 = \"SELECT * FROM orders WHERE orderId='$orderId'\";","\t\t\t\t\t\t$stmt2 = $pdo->prepare($sql2);","\t\t\t\t    \t$stmt2->execute();","\t\t\t\t    \tif($row2 = $stmt2->fetch()){","\t\t\t\t    \t\t$itemName = $row2[\"itemName\"];","\t\t\t\t    \t\t$itemLink = makeLink($row2[\"itemLink\"]);","\t\t\t\t    \t\t$itemCost = $row2[\"itemCost\"];","\t\t\t\t    \t\t$itemReceivingPrice = $row2[\"itemReceivingPrice\"];","\t\t\t\t    \t\t$totalQty = $row2[\"totalQty\"];","\t\t\t\t    \t\t$totalQtyTaken = $row2[\"totalQtyTaken\"];","\t\t\t\t    \t\t$qtyLeft = $row2[\"qtyLeft\"];","\t\t\t\t    \t\t$creationTime = $row2[\"creationTime\"];","\t\t\t\t    \t}","\t\t\t\t    \t$orderInfoGeneral = \"货名: \" . $itemName . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"链接: \" . $itemLink . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"单价: \" . $itemCost . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\"收价: \" . $itemReceivingPrice . \"<br>\" . ","\t\t\t\t\t\t\t\t\t\t\t\"订单建立时间\" . $creationTime . \"<br>\" .","\t\t\t\t\t\t\t\t\t\t\t\"目标收货数量\" . $totalQty . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"护士已下数量\" . $totalQtyTaken . \"<br>\";","\t\t\t\t    \t//if ((int)($totalQtyTaken) >= (int)($totalQty)) {","\t\t\t    \t\tif ($qtyLeft == 0) {","\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>此单已收满！</span><br>\";","\t\t\t\t    \t} else if ($qtyLeft < 0){","\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>此单已超收\" . (int)$qtyLeft * (-1) . \"单！</span><br>\";","\t\t\t\t    \t} else {","\t\t\t\t    \t\t//$qtyLeftNeeded = (int)($totalQty) - (int)($totalQtyTaken);","\t\t\t\t    \t\t//echo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeeded . \"</span>单。<br>\";","\t\t\t\t    \t\techo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeft . \"</span>单。<br>\";","\t\t\t\t    \t}","\t\t\t\t    \t/*echo \"DEBUG2\";","\t\t\t\t    \techo \"oldOrderId第一次：\";","\t\t\t\t    \techo $oldOrderId;","\t\t\t\t    \techo \"CAONIMA0\";*/","\t\t\t\t    \techo \"<table><tr><th>护士</th><th>QQ</th><th>等待下单数量</th><th>请求时间</th></tr>\";","\t\t\t\t    \t//echo \"CAONIMA\";","\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t    \t$stmt3->execute();","\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t    \t}","\t\t\t\t    \t//echo \"CAONIMA2\";","\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td></tr>\";","\t\t\t\t    \t//echo \"CAONIMA3\";","\t\t\t\t    \t//echo \"前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t    \t$newOldOrderId = $orderId;","\t\t\t\t    \t//echo \"后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t}","\t\t\t\t}","\t\t\t\t//echo \"i是\" . $i . \"count是\" . $count . \"<br>\";","\t\t\t\t// 没显示","\t\t\t\tif ($i == $count){","\t\t\t\t\t//echo \"进来哦？？\";","\t\t\t\t\tif (isset($totalQtyRequested)){","\t\t\t\t\t\t//echo \"进来呀？\";","\t\t\t\t\t\techo \"</table><br>\";","\t\t\t\t\t\t//echo \"LAST共请求数量：\" . $totalQtyRequested . \"<br>\";","\t\t\t\t\t\techo \"等待下单总数：\" . $totalQtyRequested . \"<br></div>\";","\t\t\t\t\t} else {","\t\t\t\t\t\t","\t\t\t\t\t}","\t\t\t\t}","\t\t\t}","\t\t    echo \"</table>\";","\t    } else {","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='already-accepted' class='nav-link'>没有新批准的单子</a></h3>\";","\t    }","\t\t","\t    $pdo->commit();","","\t} ","\tcatch(Exception $e){","\t    echo $e->getMessage();","\t    $pdo->rollBack();","\t}","","","?>"]}],[{"start":{"row":0,"column":0},"end":{"row":482,"column":2},"action":"remove","lines":["<?php","","\tsession_start();","","\tfunction makeLink($url)","\t{","\t\treturn (\"<a href=\" . $url . \" target='_blank'>\" . $url . \"</a>\");","\t}","","\t$pdo = new PDO('mysql:host=localhost;dbname=chenh057_realPro', 'chenh057_hang01', 'bhgoszPg7iBcYD8WLAjeWrjEcH3LUcE96vHqCdGKnpNWZetxe', array(","\t    PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,","\t    PDO::ATTR_EMULATE_PREPARES => false","\t));","","\t$pdo->beginTransaction();","\t","\ttry{","\t\t","\t\t//http://stackoverflow.com/questions/43478069/best-way-to-identify-a-mysql-changed-group-by-field-value-in-a-statement-fetch","\t\t// My question","\t\t$sql = \"SELECT * FROM orderTaken WHERE orderStatus='10' ORDER BY orderId DESC, orderTakenTime DESC\";","\t\t$stmt = $pdo->prepare($sql);","\t    $stmt->execute();","\t    $count = $stmt->rowCount();","\t    if ($count > 0){","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='nurse-requested' class='nav-link'>以下为护士报数的单子，请依情况执行操作。</a></h3>\";","\t    \tfor ($i = 0; $i < $count + 1; $i++){","\t\t\t\tif ($row = $stmt->fetch()){","\t\t\t\t\t$orderId = $row[\"orderId\"];","\t\t\t\t\t$qtyRequested = $row[\"qtyTaken\"];","\t\t\t\t\t$requestedTime = $row[\"lastModifiedTime\"];","\t\t\t\t\t$orderTakenId = $row[\"orderTakenId\"];","\t\t\t\t\t//$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\tif (isset($oldOrderId)){","\t\t\t\t\t\tif ($oldOrderId != $orderId){","\t\t\t\t\t\t\t/*","\t\t\t\t\t\t\techo \"看看\" . $oldOrderId;","\t\t\t\t\t\t\techo \"NEWNEW\";*/","\t\t\t\t\t\t\techo \"</table><br>\";","\t\t\t\t\t\t\t//echo \"NEWNEW2\";","\t\t\t\t\t\t\techo \"共请求数量：\" . $totalQtyRequested . \"<br>\";","\t\t\t\t\t\t\tif ($isFull == false){","\t\t\t\t\t\t\t\t//$qtyLeftNeededNew = (int)($totalQty) - ((int)($totalQtyRequested) + (int)($totalQtyTaken));","\t\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)$qtyLeft - (int)($totalQtyRequested);","\t\t\t\t\t\t\t\tif ($qtyLeftNeededNew > 0){","\t\t\t\t\t\t\t\t\techo \"若全部批准，此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeededNew . \"</span>单。<br></div>\";","\t\t\t\t\t\t\t\t} else if ($qtyLeftNeededNew == 0){","\t\t\t\t\t\t\t\t\techo \"若全部批准，此单正好收全。<br></div>\";","\t\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)$qtyLeftNeededNew * (-1);","\t\t\t\t\t\t\t\t\techo \"注意！若全部批准，此单将<span style='color: red; font-size:20px'>超量\" . $qtyLeftNeededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t\t\t}","\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\t//$qtyLeftExceeded = (int)($totalQtyTaken) - (int)($totalQty);","\t\t\t\t\t\t\t\t$qtyLeftExceeded = (int)$qtyLeft * (-1);","\t\t\t\t\t\t\t\t$qtyLeftExceededNew = (int)($totalQtyRequested) + (int)($qtyLeftExceeded);","\t\t\t\t\t\t\t\tif ((int)$qtyLeftExceeded != 0){","\t\t\t\t\t\t\t\t\techo \"此单已超量<span style='color: red; font-size:20px'>\". $qtyLeftExceeded . \"</span>单！<br>\";","\t\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\t\techo \"注意！此单已<span style='color: red; font-size:20px'>正好收满了！</span><br>\";","\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t","\t\t\t\t\t\t\t\techo \"若全部批准，此单将<span style='color: red; font-size:20px'>总超量\" . $qtyLeftExceededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t\t}","\t\t\t\t\t\t\t$totalQtyRequested = 0;","\t\t\t\t\t\t\t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t\t\t//echo \"前Sequence\" . $orderIdChangeSequence;","\t\t\t\t\t\t\t$orderIdChangeSequence++;","\t\t\t\t\t\t\t//echo \"后Sequence\" . $orderIdChangeSequence;","\t\t\t\t\t\t\techo \"<div orderSequenceNum='$orderIdChangeSequence'>单子：\" . $orderIdChangeSequence . \"<br>\";","\t\t\t\t\t\t\t$sql2 = \"SELECT * FROM orders WHERE orderId='$orderId'\";","\t\t\t\t\t\t\t$stmt2 = $pdo->prepare($sql2);","\t\t\t\t\t    \t$stmt2->execute();","\t\t\t\t\t    \tif($row2 = $stmt2->fetch()){","\t\t\t\t\t    \t\t$itemName = $row2[\"itemName\"];","\t\t\t\t\t    \t\t$itemLink = makeLink($row2[\"itemLink\"]);","\t\t\t\t\t    \t\t$itemCost = $row2[\"itemCost\"];","\t\t\t\t\t    \t\t$itemReceivingPrice = $row2[\"itemReceivingPrice\"];","\t\t\t\t\t    \t\t$totalQty = $row2[\"totalQty\"];","\t\t\t\t\t    \t\t$totalQtyTaken = $row2[\"totalQtyTaken\"];","\t\t\t\t\t    \t\t$qtyLeft = $row2[\"qtyLeft\"];","\t\t\t\t\t    \t\t$creationTime = $row2[\"creationTime\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \t$orderInfoGeneral = \"货名: \" . $itemName . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"链接: \" . $itemLink . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"单价: \" . $itemCost . \"<br>\" .","\t\t\t\t\t\t    \t\t\t\t\t\"收价: \" . $itemReceivingPrice . \"<br>\" . ","\t\t\t\t\t\t\t\t\t\t\t\t\"订单建立时间\" . $creationTime . \"<br>\" .","\t\t\t\t\t\t\t\t\t\t\t\t\"目标收货数量\" . $totalQty . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"护士已下数量\" . $totalQtyTaken . \"<br>\";","\t\t\t\t\t    \t//if ((int)($totalQtyTaken) >= (int)($totalQty)) {","\t\t\t\t\t    \tif ($qtyLeft <= 0) {","\t\t\t\t\t    \t\t$isFull = true;","\t\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>注意，此单已收满！</span><br>\";","\t\t\t\t\t    \t} else {","\t\t\t\t\t    \t\t$isFull = false;","\t\t\t\t\t    \t\t//$qtyLeftNeeded = (int)($totalQty) - (int)($totalQtyTaken);","\t\t\t\t\t    \t\t//echo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeeded . \"</span>单。<br>\";","\t\t\t\t\t    \t\techo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeft . \"</span>单。<br>\";","\t\t\t\t\t    \t}","\t\t\t\t\t    \t//echo \"DEBUG 1\";","\t\t\t\t\t    \techo \"<table><tr><th>护士</th><th>QQ</th><th>请求数量</th><th>请求时间</th><th>批准</th><th>修改并批数量</th><th>拒绝</th></tr>\";","\t\t\t\t\t    \t//echo \"FUCK\";","\t\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t\t    \t$stmt3->execute();","\t\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td></tr>\" .","\t\t\t\t\t    \t\"<button class='accept-qty-btn' data-accept-orderTakenId='$orderTakenId' data-accept-qtyRequested='$qtyRequested' data-accept-qty-orderId='$orderId'>批</button>\" . \"</td><td>\" .","\t\t\t\t\t    \t\"<button class='accept-change-qty-btn' data-accept-change-qty-orderTakenId='$orderTakenId' data-accept-change-qty-userName='$userName' data-accept-change-qty-orderId='$orderId' data-accept-change-qty-qtyLeft='$qtyLeft'>改并批</button>\" . \"</td><td>\" .","\t\t\t\t\t    \t\"<button class='reject-qty-btn' data-reject-orderTakenId='$orderTakenId' data-reject-userName='$userName'>拒</button>\" . \"</td></tr>\";","\t\t\t\t\t    \t//echo \"不一样前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    \t$oldOrderId = $orderId;","\t\t\t\t\t    \t//echo \"不一样后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    //$oldOrderId == $orderId","\t\t\t\t\t    } else {","\t\t\t\t\t    \t//echo \"SAME\";","\t\t\t\t\t    \t//若一样则继续print","\t\t\t\t\t    \t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t\t    \t$stmt3->execute();","\t\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \t//echo \"SAME YEA\";","\t\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td></tr>\" .","\t\t\t\t\t    \t\"<button class='accept-qty-btn' data-accept-orderTakenId='$orderTakenId' data-accept-qtyRequested='$qtyRequested' data-accept-qty-orderId='$orderId'>批</button>\" . \"</td><td>\" .","\t\t\t\t\t    \t\"<button class='accept-change-qty-btn' data-accept-change-qty-orderTakenId='$orderTakenId' data-accept-change-qty-userName='$userName' data-accept-change-qty-orderId='$orderId' data-accept-change-qty-qtyLeft='$qtyLeft'>改并批</button>\" . \"</td><td>\" .","\t\t\t\t\t    \t\"<button class='reject-qty-btn' data-reject-orderTakenId='$orderTakenId' data-reject-userName='$userName'>拒</button>\" . \"</td></tr>\";","\t\t\t\t\t    \t//echo \"一样前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    \t$oldOrderId = $orderId;","\t\t\t\t\t    \t//echo \"一样后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    }","\t\t\t\t\t} else {","\t\t\t\t\t\t//echo \"XIN\";","\t\t\t\t\t\t//全新","\t\t\t\t\t\t// 检查应该是无误了 041917 101920am 3E","\t\t\t\t\t\t$orderIdChangeSequence = 0;","\t\t\t\t\t\t$totalQtyRequested = 0;","\t\t\t\t\t\t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t\t$orderIdChangeSequence++;","\t\t\t\t\t\techo \"<div orderSequenceNum='$orderIdChangeSequence'>单子：\" . $orderIdChangeSequence . \"<br>\";","\t\t\t\t\t\t$sql2 = \"SELECT * FROM orders WHERE orderId='$orderId'\";","\t\t\t\t\t\t$stmt2 = $pdo->prepare($sql2);","\t\t\t\t    \t$stmt2->execute();","\t\t\t\t    \tif($row2 = $stmt2->fetch()){","\t\t\t\t    \t\t$itemName = $row2[\"itemName\"];","\t\t\t\t    \t\t$itemLink = makeLink($row2[\"itemLink\"]);","\t\t\t\t    \t\t$itemCost = $row2[\"itemCost\"];","\t\t\t\t    \t\t$itemReceivingPrice = $row2[\"itemReceivingPrice\"];","\t\t\t\t    \t\t$totalQty = $row2[\"totalQty\"];","\t\t\t\t    \t\t$totalQtyTaken = $row2[\"totalQtyTaken\"];","\t\t\t\t    \t\t$qtyLeft = $row2[\"qtyLeft\"];","\t\t\t\t    \t\t$creationTime = $row2[\"creationTime\"];","\t\t\t\t    \t}","\t\t\t\t    \t$orderInfoGeneral = \"货名: \" . $itemName . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"链接: \" . $itemLink . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"单价: \" . $itemCost . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\"收价: \" . $itemReceivingPrice . \"<br>\" . ","\t\t\t\t\t\t\t\t\t\t\t\"订单建立时间\" . $creationTime . \"<br>\" .","\t\t\t\t\t\t\t\t\t\t\t\"目标收货数量\" . $totalQty . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"护士已下数量\" . $totalQtyTaken . \"<br>\";","\t\t\t\t    \t//if ((int)($totalQtyTaken) >= (int)($totalQty)) {","\t\t\t\t    \tif ($qtyLeft <= 0) {","\t\t\t\t    \t\t$isFull = true;","\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>注意，此单已收满！</span><br>\";","\t\t\t\t    \t} else {","\t\t\t\t    \t\t$isFull = false;","\t\t\t\t    \t\t//$qtyLeftNeeded = (int)($totalQty) - (int)($totalQtyTaken);","\t\t\t\t    \t\techo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeft . \"</span>单。<br>\";","\t\t\t\t    \t}","\t\t\t\t    \t/*echo \"DEBUG2\";","\t\t\t\t    \techo \"oldOrderId第一次：\";","\t\t\t\t    \techo $oldOrderId;","\t\t\t\t    \techo \"CAONIMA0\";*/","\t\t\t\t    \techo \"<table><tr><th>护士</th><th>QQ</th><th>请求数量</th><th>请求时间</th><th>批准</th><th>修改并批数量</th><th>拒绝</th></tr>\";","\t\t\t\t    \t//echo \"CAONIMA\";","\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t    \t$stmt3->execute();","\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t    \t}","\t\t\t\t    \t//echo \"CAONIMA2\";","\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td></tr>\" .","\t\t\t\t    \t\"<button class='accept-qty-btn' data-accept-orderTakenId='$orderTakenId' data-accept-qtyRequested='$qtyRequested' data-accept-qty-orderId='$orderId'>批</button>\" . \"</td><td>\" .","\t\t\t\t    \t\"<button class='accept-change-qty-btn' data-accept-change-qty-orderTakenId='$orderTakenId' data-accept-change-qty-userName='$userName' data-accept-change-qty-orderId='$orderId' data-accept-change-qty-qtyLeft='$qtyLeft'>改并批</button>\" . \"</td><td>\" .","\t\t\t\t    \t\"<button class='reject-qty-btn' data-reject-orderTakenId='$orderTakenId' data-reject-userName='$userName'>拒</button>\" . \"</td></tr>\";","\t\t\t\t    \t//echo \"CAONIMA3\";","\t\t\t\t    \t//echo \"前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t    \t$oldOrderId = $orderId;","\t\t\t\t    \t//echo \"后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t}","\t\t\t\t}","\t\t\t\t//echo \"i是\" . $i . \"count是\" . $count . \"<br>\";","\t\t\t\t// 没显示","\t\t\t\tif ($i == $count){","\t\t\t\t\t//echo \"进来哦？？\";","\t\t\t\t\tif (isset($totalQtyRequested)){","\t\t\t\t\t\t//echo \"进来呀？\";","\t\t\t\t\t\techo \"</table><br>\";","\t\t\t\t\t\t//echo \"LAST共请求数量：\" . $totalQtyRequested . \"<br>\";","\t\t\t\t\t\techo \"共请求数量：\" . $totalQtyRequested . \"<br>\";","\t\t\t\t\t\tif ($isFull == false){","\t\t\t\t\t\t\t/*","\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)($totalQty) - ((int)($totalQtyRequested) + (int)($totalQtyTaken));","\t\t\t\t\t\t\tif ($qtyLeftNeededNew > 0){","\t\t\t\t\t\t\t\techo \"若全部批准，此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeededNew . \"</span>单。<br></div>\";","\t\t\t\t\t\t\t} else if ($qtyLeftNeededNew == 0){","\t\t\t\t\t\t\t\techo \"若全部批准，此单正好收全。<br></div>\";","\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)$qtyLeftNeededNew * (-1);","\t\t\t\t\t\t\t\techo \"注意！若全部批准，此单将<span style='color: red; font-size:20px'>超量\" . $qtyLeftNeededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t\t}*/","\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)$qtyLeft - (int)($totalQtyRequested);","\t\t\t\t\t\t\tif ($qtyLeftNeededNew > 0){","\t\t\t\t\t\t\t\techo \"若全部批准，此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeededNew . \"</span>单。<br></div>\";","\t\t\t\t\t\t\t} else if ($qtyLeftNeededNew == 0){","\t\t\t\t\t\t\t\techo \"若全部批准，此单正好收全。<br></div>\";","\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)$qtyLeftNeededNew * (-1);","\t\t\t\t\t\t\t\techo \"注意！若全部批准，此单将<span style='color: red; font-size:20px'>超量\" . $qtyLeftNeededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t\t}","","\t\t\t\t\t\t} else {/*","\t\t\t\t\t\t\t$qtyLeftExceeded = (int)($totalQtyTaken) - (int)($totalQty);","\t\t\t\t\t\t\t$qtyLeftExceededNew = (int)($totalQtyRequested) + (int)($qtyLeftExceeded);","\t\t\t\t\t\t\techo \"此单已超量<span style='color: red; font-size:20px'>\". $qtyLeftExceeded . \"</span>单！<br>\";","\t\t\t\t\t\t\techo \"若全部批准，此单将<span style='color: red; font-size:20px'>总超量\" . $qtyLeftExceededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t\t*/","\t\t\t\t\t\t\t$qtyLeftExceeded = (int)$qtyLeft * (-1);","\t\t\t\t\t\t\t$qtyLeftExceededNew = (int)($totalQtyRequested) + (int)($qtyLeftExceeded);","\t\t\t\t\t\t\tif ((int)$qtyLeftExceeded != 0){","\t\t\t\t\t\t\t\techo \"此单已超量<span style='color: red; font-size:20px'>\". $qtyLeftExceeded . \"</span>单！<br>\";","\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\techo \"注意！此单已<span style='color: red; font-size:20px'>正好收满了！</span><br>\";","\t\t\t\t\t\t\t}","\t\t\t\t\t\t\techo \"若全部批准，此单将<span style='color: red; font-size:20px'>总超量\" . $qtyLeftExceededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t}","\t\t\t\t\t} else {","\t\t\t\t\t\t","\t\t\t\t\t}","\t\t\t\t}","\t\t\t}","\t    } else {","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='nurse-requested' class='nav-link'>目前没有被护士报数的单子</a></h3>\";","\t    }","\t\t","\t\t","\t\t/* PART II */","\t\t","\t\t$sql = \"SELECT * FROM orderTaken WHERE orderStatus='1' ORDER BY orderId DESC, orderTakenTime DESC\";","\t\t$stmt = $pdo->prepare($sql);","\t    $stmt->execute();","\t    $count = $stmt->rowCount();","\t    if ($count > 0){","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='nurse-taken' class='nav-link'>以下为护士已确认申领的单子</a></h3>\";","\t    \techo \"<table><tr><th>护士</th><th>QQ</th><th>数量</th><th>货名</th><th>链接</th><th>单价</th><th>收价</th><th>领单时间</th></tr>\";","\t\t    while ($row = $stmt->fetch()){","\t\t    \t$userId = $row[\"userId\"];","\t\t    \t$sql2 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t    \t$stmt2 = $pdo->prepare($sql2);","\t\t    \t$stmt2->execute();","\t\t    \tif($row2 = $stmt2->fetch()){","\t\t    \t\t$userName = $row2[\"userName\"];","\t\t    \t\t$userQQ = $row2[\"userQQ\"];","\t\t    \t}","","\t\t    \t$orderId = $row[\"orderId\"];","\t\t    \t$sql3 = \"SELECT * FROM orders WHERE orderId='$orderId'\";","\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t    \t$stmt3->execute();","\t\t    \tif($row3 = $stmt3->fetch()){","\t\t    \t\t$itemName = $row3[\"itemName\"];","\t\t    \t\t$itemLink = makeLink($row3[\"itemLink\"]);","\t\t    \t\t$itemCost = $row3[\"itemCost\"];","\t\t    \t\t$itemReceivingPrice = $row3[\"itemReceivingPrice\"];","\t\t    \t}","","\t\t    \t$qtyTaken = $row[\"qtyTaken\"];","\t\t    \t$orderTakenTime = $row[\"orderTakenTime\"];","\t\t    \t","\t\t    \t$tableRow = \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyTaken . \"</td><td>\" . $itemName . \"</td><td>\" . $itemLink . \"</td><td>\" . $itemCost . \"</td><td>\" . $itemReceivingPrice . \"</td><td>\" . $orderTakenTime .  \"</td></tr>\";","\t\t    \techo $tableRow;","\t\t    }","\t\t    echo \"</table><br>\";","\t    } else {","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='nurse-taken' class='nav-link'>目前没有护士申领新单子</a></h3>\";","\t    }","\t    ","\t    ","\t    ","\t    /* Part III */\t    ","\t\t//http://stackoverflow.com/questions/43478069/best-way-to-identify-a-mysql-changed-group-by-field-value-in-a-statement-fetch","\t\t// My question","\t\t$sql = \"SELECT * FROM orderTaken WHERE orderStatus='11' ORDER BY orderId DESC, orderTakenTime DESC\";","\t\t$stmt = $pdo->prepare($sql);","\t    $stmt->execute();","\t    $count = $stmt->rowCount();","\t    if ($count > 0){","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='already-accepted' class='nav-link'>以下为已批准的单子，正等待护士确认。</a></h3>\";","\t    \tfor ($i = 0; $i < $count + 1; $i++){","\t\t\t\tif ($row = $stmt->fetch()){","\t\t\t\t\t$orderId = $row[\"orderId\"];","\t\t\t\t\t$qtyRequested = $row[\"qtyTaken\"];","\t\t\t\t\t$requestedTime = $row[\"lastModifiedTime\"];","\t\t\t\t\t$orderTakenId = $row[\"orderTakenId\"];","\t\t\t\t\t//$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\tif (isset($newOldOrderId)){","\t\t\t\t\t\tif ($newOldOrderId != $orderId){","\t\t\t\t\t\t\t/*","\t\t\t\t\t\t\techo \"看看\" . $oldOrderId;","\t\t\t\t\t\t\techo \"NEWNEW\";*/","\t\t\t\t\t\t\techo \"</table><br>\";","\t\t\t\t\t\t\t//echo \"NEWNEW2\";","\t\t\t\t\t\t\techo \"等待下单总数：\" . $totalQtyRequested . \"<br></div>\";","\t\t\t\t\t\t\t$totalQtyRequested = 0;","\t\t\t\t\t\t\t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t\t\t//echo \"前Sequence\" . $orderIdChangeSequence;","\t\t\t\t\t\t\t$orderIdChangeSequence++;","\t\t\t\t\t\t\t//echo \"后Sequence\" . $orderIdChangeSequence;","\t\t\t\t\t\t\techo \"<div orderSequenceNum='$orderIdChangeSequence'>单子：\" . $orderIdChangeSequence . \"<br>\";","\t\t\t\t\t\t\t$sql2 = \"SELECT * FROM orders WHERE orderId='$orderId'\";","\t\t\t\t\t\t\t$stmt2 = $pdo->prepare($sql2);","\t\t\t\t\t    \t$stmt2->execute();","\t\t\t\t\t    \tif($row2 = $stmt2->fetch()){","\t\t\t\t\t    \t\t$itemName = $row2[\"itemName\"];","\t\t\t\t\t    \t\t$itemLink = makeLink($row2[\"itemLink\"]);","\t\t\t\t\t    \t\t$itemCost = $row2[\"itemCost\"];","\t\t\t\t\t    \t\t$itemReceivingPrice = $row2[\"itemReceivingPrice\"];","\t\t\t\t\t    \t\t$totalQty = $row2[\"totalQty\"];","\t\t\t\t\t    \t\t$totalQtyTaken = $row2[\"totalQtyTaken\"];","\t\t\t\t\t    \t\t$qtyLeft = $row2[\"qtyLeft\"];","\t\t\t\t\t    \t\t$creationTime = $row2[\"creationTime\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \t$orderInfoGeneral = \"货名: \" . $itemName . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"链接: \" . $itemLink . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"单价: \" . $itemCost . \"<br>\" .","\t\t\t\t\t\t    \t\t\t\t\t\"收价: \" . $itemReceivingPrice . \"<br>\" . ","\t\t\t\t\t\t\t\t\t\t\t\t\"订单建立时间\" . $creationTime . \"<br>\" .","\t\t\t\t\t\t\t\t\t\t\t\t\"目标收货数量\" . $totalQty . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"护士已下数量\" . $totalQtyTaken . \"<br>\";","\t\t\t\t\t    \t//if ((int)($totalQtyTaken) >= (int)($totalQty)) {","\t\t\t\t\t    \tif ($qtyLeft == 0) {","\t\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>此单已收满！</span><br>\";","\t\t\t\t\t    \t} else if ($qtyLeft < 0){","\t\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>此单已超收\" . (int)$qtyLeft * (-1) . \"单！</span><br>\";","\t\t\t\t\t    \t} else {","\t\t\t\t\t    \t\t//$qtyLeftNeeded = (int)($totalQty) - (int)($totalQtyTaken);","\t\t\t\t\t    \t\t//echo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeeded . \"</span>单。<br>\";","\t\t\t\t\t    \t\techo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeft . \"</span>单。<br>\";","\t\t\t\t\t    \t}","\t\t\t\t\t    \t//echo \"DEBUG 1\";","\t\t\t\t\t    \techo \"<table><tr><th>护士</th><th>QQ</th><th>等待下单数量</th><th>请求时间</th></tr>\";","\t\t\t\t\t    \t//echo \"FUCK\";","\t\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t\t    \t$stmt3->execute();","\t\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td></tr>\" .","\t\t\t\t\t    \t//echo \"不一样前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    \t$newOldOrderId = $orderId;","\t\t\t\t\t    \t//echo \"不一样后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    //$oldOrderId == $orderId","\t\t\t\t\t    } else {","\t\t\t\t\t    \t//echo \"SAME\";","\t\t\t\t\t    \t//若一样则继续print","\t\t\t\t\t    \t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t\t    \t$stmt3->execute();","\t\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \t//echo \"SAME YEA\";","\t\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td></tr>\";","\t\t\t\t\t    \t//echo \"一样前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    \t$newOldOrderId = $orderId;","\t\t\t\t\t    \t//echo \"一样后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    }","\t\t\t\t\t} else {","\t\t\t\t\t\t//echo \"XIN\";","\t\t\t\t\t\t//全新","\t\t\t\t\t\t$orderIdChangeSequence = 0;","\t\t\t\t\t\t$totalQtyRequested = 0;","\t\t\t\t\t\t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t\t$orderIdChangeSequence++;","\t\t\t\t\t\techo \"<div orderSequenceNum='$orderIdChangeSequence'>单子：\" . $orderIdChangeSequence . \"<br>\";","\t\t\t\t\t\t$sql2 = \"SELECT * FROM orders WHERE orderId='$orderId'\";","\t\t\t\t\t\t$stmt2 = $pdo->prepare($sql2);","\t\t\t\t    \t$stmt2->execute();","\t\t\t\t    \tif($row2 = $stmt2->fetch()){","\t\t\t\t    \t\t$itemName = $row2[\"itemName\"];","\t\t\t\t    \t\t$itemLink = makeLink($row2[\"itemLink\"]);","\t\t\t\t    \t\t$itemCost = $row2[\"itemCost\"];","\t\t\t\t    \t\t$itemReceivingPrice = $row2[\"itemReceivingPrice\"];","\t\t\t\t    \t\t$totalQty = $row2[\"totalQty\"];","\t\t\t\t    \t\t$totalQtyTaken = $row2[\"totalQtyTaken\"];","\t\t\t\t    \t\t$qtyLeft = $row2[\"qtyLeft\"];","\t\t\t\t    \t\t$creationTime = $row2[\"creationTime\"];","\t\t\t\t    \t}","\t\t\t\t    \t$orderInfoGeneral = \"货名: \" . $itemName . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"链接: \" . $itemLink . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"单价: \" . $itemCost . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\"收价: \" . $itemReceivingPrice . \"<br>\" . ","\t\t\t\t\t\t\t\t\t\t\t\"订单建立时间\" . $creationTime . \"<br>\" .","\t\t\t\t\t\t\t\t\t\t\t\"目标收货数量\" . $totalQty . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"护士已下数量\" . $totalQtyTaken . \"<br>\";","\t\t\t\t    \t//if ((int)($totalQtyTaken) >= (int)($totalQty)) {","\t\t\t    \t\tif ($qtyLeft == 0) {","\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>此单已收满！</span><br>\";","\t\t\t\t    \t} else if ($qtyLeft < 0){","\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>此单已超收\" . (int)$qtyLeft * (-1) . \"单！</span><br>\";","\t\t\t\t    \t} else {","\t\t\t\t    \t\t//$qtyLeftNeeded = (int)($totalQty) - (int)($totalQtyTaken);","\t\t\t\t    \t\t//echo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeeded . \"</span>单。<br>\";","\t\t\t\t    \t\techo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeft . \"</span>单。<br>\";","\t\t\t\t    \t}","\t\t\t\t    \t/*echo \"DEBUG2\";","\t\t\t\t    \techo \"oldOrderId第一次：\";","\t\t\t\t    \techo $oldOrderId;","\t\t\t\t    \techo \"CAONIMA0\";*/","\t\t\t\t    \techo \"<table><tr><th>护士</th><th>QQ</th><th>等待下单数量</th><th>请求时间</th></tr>\";","\t\t\t\t    \t//echo \"CAONIMA\";","\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t    \t$stmt3->execute();","\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t    \t}","\t\t\t\t    \t//echo \"CAONIMA2\";","\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td></tr>\";","\t\t\t\t    \t//echo \"CAONIMA3\";","\t\t\t\t    \t//echo \"前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t    \t$newOldOrderId = $orderId;","\t\t\t\t    \t//echo \"后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t}","\t\t\t\t}","\t\t\t\t//echo \"i是\" . $i . \"count是\" . $count . \"<br>\";","\t\t\t\t// 没显示","\t\t\t\tif ($i == $count){","\t\t\t\t\t//echo \"进来哦？？\";","\t\t\t\t\tif (isset($totalQtyRequested)){","\t\t\t\t\t\t//echo \"进来呀？\";","\t\t\t\t\t\techo \"</table><br>\";","\t\t\t\t\t\t//echo \"LAST共请求数量：\" . $totalQtyRequested . \"<br>\";","\t\t\t\t\t\techo \"等待下单总数：\" . $totalQtyRequested . \"<br></div>\";","\t\t\t\t\t} else {","\t\t\t\t\t\t","\t\t\t\t\t}","\t\t\t\t}","\t\t\t}","\t\t    echo \"</table>\";","\t    } else {","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='already-accepted' class='nav-link'>没有新批准的单子</a></h3>\";","\t    }","\t\t","\t    $pdo->commit();","","\t} ","\tcatch(Exception $e){","\t    echo $e->getMessage();","\t    $pdo->rollBack();","\t}","","","?>"],"id":761},{"start":{"row":0,"column":0},"end":{"row":482,"column":2},"action":"insert","lines":["<?php","","\tsession_start();","","\tfunction makeLink($url)","\t{","\t\treturn (\"<a href=\" . $url . \" target='_blank'>\" . $url . \"</a>\");","\t}","","\t$pdo = new PDO('mysql:host=localhost;dbname=chenh057_realPro', 'chenh057_hang01', 'bhgoszPg7iBcYD8WLAjeWrjEcH3LUcE96vHqCdGKnpNWZetxe', array(","\t    PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,","\t    PDO::ATTR_EMULATE_PREPARES => false","\t));","","\t$pdo->beginTransaction();","\t","\ttry{","\t\t","\t\t//http://stackoverflow.com/questions/43478069/best-way-to-identify-a-mysql-changed-group-by-field-value-in-a-statement-fetch","\t\t// My question","\t\t$sql = \"SELECT * FROM orderTaken WHERE orderStatus='10' ORDER BY orderId DESC, orderTakenTime DESC\";","\t\t$stmt = $pdo->prepare($sql);","\t    $stmt->execute();","\t    $count = $stmt->rowCount();","\t    if ($count > 0){","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='nurse-requested' class='nav-link'>以下为护士报数的单子，请依情况执行操作。</a></h3>\";","\t    \tfor ($i = 0; $i < $count + 1; $i++){","\t\t\t\tif ($row = $stmt->fetch()){","\t\t\t\t\t$orderId = $row[\"orderId\"];","\t\t\t\t\t$qtyRequested = $row[\"qtyTaken\"];","\t\t\t\t\t$requestedTime = $row[\"lastModifiedTime\"];","\t\t\t\t\t$orderTakenId = $row[\"orderTakenId\"];","\t\t\t\t\t//$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\tif (isset($oldOrderId)){","\t\t\t\t\t\tif ($oldOrderId != $orderId){","\t\t\t\t\t\t\t/*","\t\t\t\t\t\t\techo \"看看\" . $oldOrderId;","\t\t\t\t\t\t\techo \"NEWNEW\";*/","\t\t\t\t\t\t\techo \"</table><br>\";","\t\t\t\t\t\t\t//echo \"NEWNEW2\";","\t\t\t\t\t\t\techo \"共请求数量：\" . $totalQtyRequested . \"<br>\";","\t\t\t\t\t\t\tif ($isFull == false){","\t\t\t\t\t\t\t\t//$qtyLeftNeededNew = (int)($totalQty) - ((int)($totalQtyRequested) + (int)($totalQtyTaken));","\t\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)$qtyLeft - (int)($totalQtyRequested);","\t\t\t\t\t\t\t\tif ($qtyLeftNeededNew > 0){","\t\t\t\t\t\t\t\t\techo \"若全部批准，此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeededNew . \"</span>单。<br></div>\";","\t\t\t\t\t\t\t\t} else if ($qtyLeftNeededNew == 0){","\t\t\t\t\t\t\t\t\techo \"若全部批准，此单正好收全。<br></div>\";","\t\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)$qtyLeftNeededNew * (-1);","\t\t\t\t\t\t\t\t\techo \"注意！若全部批准，此单将<span style='color: red; font-size:20px'>超量\" . $qtyLeftNeededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t\t\t}","\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\t//$qtyLeftExceeded = (int)($totalQtyTaken) - (int)($totalQty);","\t\t\t\t\t\t\t\t$qtyLeftExceeded = (int)$qtyLeft * (-1);","\t\t\t\t\t\t\t\t$qtyLeftExceededNew = (int)($totalQtyRequested) + (int)($qtyLeftExceeded);","\t\t\t\t\t\t\t\tif ((int)$qtyLeftExceeded != 0){","\t\t\t\t\t\t\t\t\techo \"此单已超量<span style='color: red; font-size:20px'>\". $qtyLeftExceeded . \"</span>单！<br>\";","\t\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\t\techo \"注意！此单已<span style='color: red; font-size:20px'>正好收满了！</span><br>\";","\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t","\t\t\t\t\t\t\t\techo \"若全部批准，此单将<span style='color: red; font-size:20px'>总超量\" . $qtyLeftExceededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t\t}","\t\t\t\t\t\t\t$totalQtyRequested = 0;","\t\t\t\t\t\t\t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t\t\t//echo \"前Sequence\" . $orderIdChangeSequence;","\t\t\t\t\t\t\t$orderIdChangeSequence++;","\t\t\t\t\t\t\t//echo \"后Sequence\" . $orderIdChangeSequence;","\t\t\t\t\t\t\techo \"<div orderSequenceNum='$orderIdChangeSequence'>单子：\" . $orderIdChangeSequence . \"<br>\";","\t\t\t\t\t\t\t$sql2 = \"SELECT * FROM orders WHERE orderId='$orderId'\";","\t\t\t\t\t\t\t$stmt2 = $pdo->prepare($sql2);","\t\t\t\t\t    \t$stmt2->execute();","\t\t\t\t\t    \tif($row2 = $stmt2->fetch()){","\t\t\t\t\t    \t\t$itemName = $row2[\"itemName\"];","\t\t\t\t\t    \t\t$itemLink = makeLink($row2[\"itemLink\"]);","\t\t\t\t\t    \t\t$itemCost = $row2[\"itemCost\"];","\t\t\t\t\t    \t\t$itemReceivingPrice = $row2[\"itemReceivingPrice\"];","\t\t\t\t\t    \t\t$totalQty = $row2[\"totalQty\"];","\t\t\t\t\t    \t\t$totalQtyTaken = $row2[\"totalQtyTaken\"];","\t\t\t\t\t    \t\t$qtyLeft = $row2[\"qtyLeft\"];","\t\t\t\t\t    \t\t$creationTime = $row2[\"creationTime\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \t$orderInfoGeneral = \"货名: \" . $itemName . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"链接: \" . $itemLink . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"单价: \" . $itemCost . \"<br>\" .","\t\t\t\t\t\t    \t\t\t\t\t\"收价: \" . $itemReceivingPrice . \"<br>\" . ","\t\t\t\t\t\t\t\t\t\t\t\t\"订单建立时间\" . $creationTime . \"<br>\" .","\t\t\t\t\t\t\t\t\t\t\t\t\"目标收货数量\" . $totalQty . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"护士已下数量\" . $totalQtyTaken . \"<br>\";","\t\t\t\t\t    \t//if ((int)($totalQtyTaken) >= (int)($totalQty)) {","\t\t\t\t\t    \tif ($qtyLeft <= 0) {","\t\t\t\t\t    \t\t$isFull = true;","\t\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>注意，此单已收满！</span><br>\";","\t\t\t\t\t    \t} else {","\t\t\t\t\t    \t\t$isFull = false;","\t\t\t\t\t    \t\t//$qtyLeftNeeded = (int)($totalQty) - (int)($totalQtyTaken);","\t\t\t\t\t    \t\t//echo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeeded . \"</span>单。<br>\";","\t\t\t\t\t    \t\techo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeft . \"</span>单。<br>\";","\t\t\t\t\t    \t}","\t\t\t\t\t    \t//echo \"DEBUG 1\";","\t\t\t\t\t    \techo \"<table><tr><th>护士</th><th>QQ</th><th>请求数量</th><th>请求时间</th><th>批准</th><th>修改并批数量</th><th>拒绝</th></tr>\";","\t\t\t\t\t    \t//echo \"FUCK\";","\t\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t\t    \t$stmt3->execute();","\t\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td><td>\" .","\t\t\t\t\t    \t\"<button class='accept-qty-btn' data-accept-orderTakenId='$orderTakenId' data-accept-qtyRequested='$qtyRequested' data-accept-qty-orderId='$orderId'>批</button>\" . \"</td><td>\" .","\t\t\t\t\t    \t\"<button class='accept-change-qty-btn' data-accept-change-qty-orderTakenId='$orderTakenId' data-accept-change-qty-userName='$userName' data-accept-change-qty-orderId='$orderId' data-accept-change-qty-qtyLeft='$qtyLeft'>改并批</button>\" . \"</td><td>\" .","\t\t\t\t\t    \t\"<button class='reject-qty-btn' data-reject-orderTakenId='$orderTakenId' data-reject-userName='$userName'>拒</button>\" . \"</td></tr>\";","\t\t\t\t\t    \t//echo \"不一样前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    \t$oldOrderId = $orderId;","\t\t\t\t\t    \t//echo \"不一样后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    //$oldOrderId == $orderId","\t\t\t\t\t    } else {","\t\t\t\t\t    \t//echo \"SAME\";","\t\t\t\t\t    \t//若一样则继续print","\t\t\t\t\t    \t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t\t    \t$stmt3->execute();","\t\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \t//echo \"SAME YEA\";","\t\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td><td>\" .","\t\t\t\t\t    \t\"<button class='accept-qty-btn' data-accept-orderTakenId='$orderTakenId' data-accept-qtyRequested='$qtyRequested' data-accept-qty-orderId='$orderId'>批</button>\" . \"</td><td>\" .","\t\t\t\t\t    \t\"<button class='accept-change-qty-btn' data-accept-change-qty-orderTakenId='$orderTakenId' data-accept-change-qty-userName='$userName' data-accept-change-qty-orderId='$orderId' data-accept-change-qty-qtyLeft='$qtyLeft'>改并批</button>\" . \"</td><td>\" .","\t\t\t\t\t    \t\"<button class='reject-qty-btn' data-reject-orderTakenId='$orderTakenId' data-reject-userName='$userName'>拒</button>\" . \"</td></tr>\";","\t\t\t\t\t    \t//echo \"一样前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    \t$oldOrderId = $orderId;","\t\t\t\t\t    \t//echo \"一样后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    }","\t\t\t\t\t} else {","\t\t\t\t\t\t//echo \"XIN\";","\t\t\t\t\t\t//全新","\t\t\t\t\t\t// 检查应该是无误了 041917 101920am 3E","\t\t\t\t\t\t$orderIdChangeSequence = 0;","\t\t\t\t\t\t$totalQtyRequested = 0;","\t\t\t\t\t\t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t\t$orderIdChangeSequence++;","\t\t\t\t\t\techo \"<div orderSequenceNum='$orderIdChangeSequence'>单子：\" . $orderIdChangeSequence . \"<br>\";","\t\t\t\t\t\t$sql2 = \"SELECT * FROM orders WHERE orderId='$orderId'\";","\t\t\t\t\t\t$stmt2 = $pdo->prepare($sql2);","\t\t\t\t    \t$stmt2->execute();","\t\t\t\t    \tif($row2 = $stmt2->fetch()){","\t\t\t\t    \t\t$itemName = $row2[\"itemName\"];","\t\t\t\t    \t\t$itemLink = makeLink($row2[\"itemLink\"]);","\t\t\t\t    \t\t$itemCost = $row2[\"itemCost\"];","\t\t\t\t    \t\t$itemReceivingPrice = $row2[\"itemReceivingPrice\"];","\t\t\t\t    \t\t$totalQty = $row2[\"totalQty\"];","\t\t\t\t    \t\t$totalQtyTaken = $row2[\"totalQtyTaken\"];","\t\t\t\t    \t\t$qtyLeft = $row2[\"qtyLeft\"];","\t\t\t\t    \t\t$creationTime = $row2[\"creationTime\"];","\t\t\t\t    \t}","\t\t\t\t    \t$orderInfoGeneral = \"货名: \" . $itemName . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"链接: \" . $itemLink . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"单价: \" . $itemCost . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\"收价: \" . $itemReceivingPrice . \"<br>\" . ","\t\t\t\t\t\t\t\t\t\t\t\"订单建立时间\" . $creationTime . \"<br>\" .","\t\t\t\t\t\t\t\t\t\t\t\"目标收货数量\" . $totalQty . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"护士已下数量\" . $totalQtyTaken . \"<br>\";","\t\t\t\t    \t//if ((int)($totalQtyTaken) >= (int)($totalQty)) {","\t\t\t\t    \tif ($qtyLeft <= 0) {","\t\t\t\t    \t\t$isFull = true;","\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>注意，此单已收满！</span><br>\";","\t\t\t\t    \t} else {","\t\t\t\t    \t\t$isFull = false;","\t\t\t\t    \t\t//$qtyLeftNeeded = (int)($totalQty) - (int)($totalQtyTaken);","\t\t\t\t    \t\techo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeft . \"</span>单。<br>\";","\t\t\t\t    \t}","\t\t\t\t    \t/*echo \"DEBUG2\";","\t\t\t\t    \techo \"oldOrderId第一次：\";","\t\t\t\t    \techo $oldOrderId;","\t\t\t\t    \techo \"CAONIMA0\";*/","\t\t\t\t    \techo \"<table><tr><th>护士</th><th>QQ</th><th>请求数量</th><th>请求时间</th><th>批准</th><th>修改并批数量</th><th>拒绝</th></tr>\";","\t\t\t\t    \t//echo \"CAONIMA\";","\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t    \t$stmt3->execute();","\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t    \t}","\t\t\t\t    \t//echo \"CAONIMA2\";","\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td><td>\" .","\t\t\t\t    \t\"<button class='accept-qty-btn' data-accept-orderTakenId='$orderTakenId' data-accept-qtyRequested='$qtyRequested' data-accept-qty-orderId='$orderId'>批</button>\" . \"</td><td>\" .","\t\t\t\t    \t\"<button class='accept-change-qty-btn' data-accept-change-qty-orderTakenId='$orderTakenId' data-accept-change-qty-userName='$userName' data-accept-change-qty-orderId='$orderId' data-accept-change-qty-qtyLeft='$qtyLeft'>改并批</button>\" . \"</td><td>\" .","\t\t\t\t    \t\"<button class='reject-qty-btn' data-reject-orderTakenId='$orderTakenId' data-reject-userName='$userName'>拒</button>\" . \"</td></tr>\";","\t\t\t\t    \t//echo \"CAONIMA3\";","\t\t\t\t    \t//echo \"前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t    \t$oldOrderId = $orderId;","\t\t\t\t    \t//echo \"后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t}","\t\t\t\t}","\t\t\t\t//echo \"i是\" . $i . \"count是\" . $count . \"<br>\";","\t\t\t\t// 没显示","\t\t\t\tif ($i == $count){","\t\t\t\t\t//echo \"进来哦？？\";","\t\t\t\t\tif (isset($totalQtyRequested)){","\t\t\t\t\t\t//echo \"进来呀？\";","\t\t\t\t\t\techo \"</table><br>\";","\t\t\t\t\t\t//echo \"LAST共请求数量：\" . $totalQtyRequested . \"<br>\";","\t\t\t\t\t\techo \"共请求数量：\" . $totalQtyRequested . \"<br>\";","\t\t\t\t\t\tif ($isFull == false){","\t\t\t\t\t\t\t/*","\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)($totalQty) - ((int)($totalQtyRequested) + (int)($totalQtyTaken));","\t\t\t\t\t\t\tif ($qtyLeftNeededNew > 0){","\t\t\t\t\t\t\t\techo \"若全部批准，此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeededNew . \"</span>单。<br></div>\";","\t\t\t\t\t\t\t} else if ($qtyLeftNeededNew == 0){","\t\t\t\t\t\t\t\techo \"若全部批准，此单正好收全。<br></div>\";","\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)$qtyLeftNeededNew * (-1);","\t\t\t\t\t\t\t\techo \"注意！若全部批准，此单将<span style='color: red; font-size:20px'>超量\" . $qtyLeftNeededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t\t}*/","\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)$qtyLeft - (int)($totalQtyRequested);","\t\t\t\t\t\t\tif ($qtyLeftNeededNew > 0){","\t\t\t\t\t\t\t\techo \"若全部批准，此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeededNew . \"</span>单。<br></div>\";","\t\t\t\t\t\t\t} else if ($qtyLeftNeededNew == 0){","\t\t\t\t\t\t\t\techo \"若全部批准，此单正好收全。<br></div>\";","\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\t$qtyLeftNeededNew = (int)$qtyLeftNeededNew * (-1);","\t\t\t\t\t\t\t\techo \"注意！若全部批准，此单将<span style='color: red; font-size:20px'>超量\" . $qtyLeftNeededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t\t}","","\t\t\t\t\t\t} else {/*","\t\t\t\t\t\t\t$qtyLeftExceeded = (int)($totalQtyTaken) - (int)($totalQty);","\t\t\t\t\t\t\t$qtyLeftExceededNew = (int)($totalQtyRequested) + (int)($qtyLeftExceeded);","\t\t\t\t\t\t\techo \"此单已超量<span style='color: red; font-size:20px'>\". $qtyLeftExceeded . \"</span>单！<br>\";","\t\t\t\t\t\t\techo \"若全部批准，此单将<span style='color: red; font-size:20px'>总超量\" . $qtyLeftExceededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t\t*/","\t\t\t\t\t\t\t$qtyLeftExceeded = (int)$qtyLeft * (-1);","\t\t\t\t\t\t\t$qtyLeftExceededNew = (int)($totalQtyRequested) + (int)($qtyLeftExceeded);","\t\t\t\t\t\t\tif ((int)$qtyLeftExceeded != 0){","\t\t\t\t\t\t\t\techo \"此单已超量<span style='color: red; font-size:20px'>\". $qtyLeftExceeded . \"</span>单！<br>\";","\t\t\t\t\t\t\t} else {","\t\t\t\t\t\t\t\techo \"注意！此单已<span style='color: red; font-size:20px'>正好收满了！</span><br>\";","\t\t\t\t\t\t\t}","\t\t\t\t\t\t\techo \"若全部批准，此单将<span style='color: red; font-size:20px'>总超量\" . $qtyLeftExceededNew . \"</span>单！<br></div>\";","\t\t\t\t\t\t}","\t\t\t\t\t} else {","\t\t\t\t\t\t","\t\t\t\t\t}","\t\t\t\t}","\t\t\t}","\t    } else {","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='nurse-requested' class='nav-link'>目前没有被护士报数的单子</a></h3>\";","\t    }","\t\t","\t\t","\t\t/* PART II */","\t\t","\t\t$sql = \"SELECT * FROM orderTaken WHERE orderStatus='1' ORDER BY orderId DESC, orderTakenTime DESC\";","\t\t$stmt = $pdo->prepare($sql);","\t    $stmt->execute();","\t    $count = $stmt->rowCount();","\t    if ($count > 0){","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='nurse-taken' class='nav-link'>以下为护士已确认申领的单子</a></h3>\";","\t    \techo \"<table><tr><th>护士</th><th>QQ</th><th>数量</th><th>货名</th><th>链接</th><th>单价</th><th>收价</th><th>领单时间</th></tr>\";","\t\t    while ($row = $stmt->fetch()){","\t\t    \t$userId = $row[\"userId\"];","\t\t    \t$sql2 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t    \t$stmt2 = $pdo->prepare($sql2);","\t\t    \t$stmt2->execute();","\t\t    \tif($row2 = $stmt2->fetch()){","\t\t    \t\t$userName = $row2[\"userName\"];","\t\t    \t\t$userQQ = $row2[\"userQQ\"];","\t\t    \t}","","\t\t    \t$orderId = $row[\"orderId\"];","\t\t    \t$sql3 = \"SELECT * FROM orders WHERE orderId='$orderId'\";","\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t    \t$stmt3->execute();","\t\t    \tif($row3 = $stmt3->fetch()){","\t\t    \t\t$itemName = $row3[\"itemName\"];","\t\t    \t\t$itemLink = makeLink($row3[\"itemLink\"]);","\t\t    \t\t$itemCost = $row3[\"itemCost\"];","\t\t    \t\t$itemReceivingPrice = $row3[\"itemReceivingPrice\"];","\t\t    \t}","","\t\t    \t$qtyTaken = $row[\"qtyTaken\"];","\t\t    \t$orderTakenTime = $row[\"orderTakenTime\"];","\t\t    \t","\t\t    \t$tableRow = \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyTaken . \"</td><td>\" . $itemName . \"</td><td>\" . $itemLink . \"</td><td>\" . $itemCost . \"</td><td>\" . $itemReceivingPrice . \"</td><td>\" . $orderTakenTime .  \"</td></tr>\";","\t\t    \techo $tableRow;","\t\t    }","\t\t    echo \"</table><br>\";","\t    } else {","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='nurse-taken' class='nav-link'>目前没有护士申领新单子</a></h3>\";","\t    }","\t    ","\t    ","\t    ","\t    /* Part III */\t    ","\t\t//http://stackoverflow.com/questions/43478069/best-way-to-identify-a-mysql-changed-group-by-field-value-in-a-statement-fetch","\t\t// My question","\t\t$sql = \"SELECT * FROM orderTaken WHERE orderStatus='11' ORDER BY orderId DESC, orderTakenTime DESC\";","\t\t$stmt = $pdo->prepare($sql);","\t    $stmt->execute();","\t    $count = $stmt->rowCount();","\t    if ($count > 0){","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='already-accepted' class='nav-link'>以下为已批准的单子，正等待护士确认。</a></h3>\";","\t    \tfor ($i = 0; $i < $count + 1; $i++){","\t\t\t\tif ($row = $stmt->fetch()){","\t\t\t\t\t$orderId = $row[\"orderId\"];","\t\t\t\t\t$qtyRequested = $row[\"qtyTaken\"];","\t\t\t\t\t$requestedTime = $row[\"lastModifiedTime\"];","\t\t\t\t\t$orderTakenId = $row[\"orderTakenId\"];","\t\t\t\t\t//$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\tif (isset($newOldOrderId)){","\t\t\t\t\t\tif ($newOldOrderId != $orderId){","\t\t\t\t\t\t\t/*","\t\t\t\t\t\t\techo \"看看\" . $oldOrderId;","\t\t\t\t\t\t\techo \"NEWNEW\";*/","\t\t\t\t\t\t\techo \"</table><br>\";","\t\t\t\t\t\t\t//echo \"NEWNEW2\";","\t\t\t\t\t\t\techo \"等待下单总数：\" . $totalQtyRequested . \"<br></div>\";","\t\t\t\t\t\t\t$totalQtyRequested = 0;","\t\t\t\t\t\t\t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t\t\t//echo \"前Sequence\" . $orderIdChangeSequence;","\t\t\t\t\t\t\t$orderIdChangeSequence++;","\t\t\t\t\t\t\t//echo \"后Sequence\" . $orderIdChangeSequence;","\t\t\t\t\t\t\techo \"<div orderSequenceNum='$orderIdChangeSequence'>单子：\" . $orderIdChangeSequence . \"<br>\";","\t\t\t\t\t\t\t$sql2 = \"SELECT * FROM orders WHERE orderId='$orderId'\";","\t\t\t\t\t\t\t$stmt2 = $pdo->prepare($sql2);","\t\t\t\t\t    \t$stmt2->execute();","\t\t\t\t\t    \tif($row2 = $stmt2->fetch()){","\t\t\t\t\t    \t\t$itemName = $row2[\"itemName\"];","\t\t\t\t\t    \t\t$itemLink = makeLink($row2[\"itemLink\"]);","\t\t\t\t\t    \t\t$itemCost = $row2[\"itemCost\"];","\t\t\t\t\t    \t\t$itemReceivingPrice = $row2[\"itemReceivingPrice\"];","\t\t\t\t\t    \t\t$totalQty = $row2[\"totalQty\"];","\t\t\t\t\t    \t\t$totalQtyTaken = $row2[\"totalQtyTaken\"];","\t\t\t\t\t    \t\t$qtyLeft = $row2[\"qtyLeft\"];","\t\t\t\t\t    \t\t$creationTime = $row2[\"creationTime\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \t$orderInfoGeneral = \"货名: \" . $itemName . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"链接: \" . $itemLink . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"单价: \" . $itemCost . \"<br>\" .","\t\t\t\t\t\t    \t\t\t\t\t\"收价: \" . $itemReceivingPrice . \"<br>\" . ","\t\t\t\t\t\t\t\t\t\t\t\t\"订单建立时间\" . $creationTime . \"<br>\" .","\t\t\t\t\t\t\t\t\t\t\t\t\"目标收货数量\" . $totalQty . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\t\"护士已下数量\" . $totalQtyTaken . \"<br>\";","\t\t\t\t\t    \t//if ((int)($totalQtyTaken) >= (int)($totalQty)) {","\t\t\t\t\t    \tif ($qtyLeft == 0) {","\t\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>此单已收满！</span><br>\";","\t\t\t\t\t    \t} else if ($qtyLeft < 0){","\t\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>此单已超收\" . (int)$qtyLeft * (-1) . \"单！</span><br>\";","\t\t\t\t\t    \t} else {","\t\t\t\t\t    \t\t//$qtyLeftNeeded = (int)($totalQty) - (int)($totalQtyTaken);","\t\t\t\t\t    \t\t//echo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeeded . \"</span>单。<br>\";","\t\t\t\t\t    \t\techo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeft . \"</span>单。<br>\";","\t\t\t\t\t    \t}","\t\t\t\t\t    \t//echo \"DEBUG 1\";","\t\t\t\t\t    \techo \"<table><tr><th>护士</th><th>QQ</th><th>等待下单数量</th><th>请求时间</th></tr>\";","\t\t\t\t\t    \t//echo \"FUCK\";","\t\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t\t    \t$stmt3->execute();","\t\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td></tr>\" .","\t\t\t\t\t    \t//echo \"不一样前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    \t$newOldOrderId = $orderId;","\t\t\t\t\t    \t//echo \"不一样后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    //$oldOrderId == $orderId","\t\t\t\t\t    } else {","\t\t\t\t\t    \t//echo \"SAME\";","\t\t\t\t\t    \t//若一样则继续print","\t\t\t\t\t    \t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t\t    \t$stmt3->execute();","\t\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t\t    \t}","\t\t\t\t\t    \t//echo \"SAME YEA\";","\t\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td></tr>\";","\t\t\t\t\t    \t//echo \"一样前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    \t$newOldOrderId = $orderId;","\t\t\t\t\t    \t//echo \"一样后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t    }","\t\t\t\t\t} else {","\t\t\t\t\t\t//echo \"XIN\";","\t\t\t\t\t\t//全新","\t\t\t\t\t\t$orderIdChangeSequence = 0;","\t\t\t\t\t\t$totalQtyRequested = 0;","\t\t\t\t\t\t$totalQtyRequested += (int)($qtyRequested);","\t\t\t\t\t\t$orderIdChangeSequence++;","\t\t\t\t\t\techo \"<div orderSequenceNum='$orderIdChangeSequence'>单子：\" . $orderIdChangeSequence . \"<br>\";","\t\t\t\t\t\t$sql2 = \"SELECT * FROM orders WHERE orderId='$orderId'\";","\t\t\t\t\t\t$stmt2 = $pdo->prepare($sql2);","\t\t\t\t    \t$stmt2->execute();","\t\t\t\t    \tif($row2 = $stmt2->fetch()){","\t\t\t\t    \t\t$itemName = $row2[\"itemName\"];","\t\t\t\t    \t\t$itemLink = makeLink($row2[\"itemLink\"]);","\t\t\t\t    \t\t$itemCost = $row2[\"itemCost\"];","\t\t\t\t    \t\t$itemReceivingPrice = $row2[\"itemReceivingPrice\"];","\t\t\t\t    \t\t$totalQty = $row2[\"totalQty\"];","\t\t\t\t    \t\t$totalQtyTaken = $row2[\"totalQtyTaken\"];","\t\t\t\t    \t\t$qtyLeft = $row2[\"qtyLeft\"];","\t\t\t\t    \t\t$creationTime = $row2[\"creationTime\"];","\t\t\t\t    \t}","\t\t\t\t    \t$orderInfoGeneral = \"货名: \" . $itemName . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"链接: \" . $itemLink . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"单价: \" . $itemCost . \"<br>\" .","\t\t\t\t\t    \t\t\t\t\t\"收价: \" . $itemReceivingPrice . \"<br>\" . ","\t\t\t\t\t\t\t\t\t\t\t\"订单建立时间\" . $creationTime . \"<br>\" .","\t\t\t\t\t\t\t\t\t\t\t\"目标收货数量\" . $totalQty . \"<br>\" .","\t\t\t\t    \t\t\t\t\t\t\"护士已下数量\" . $totalQtyTaken . \"<br>\";","\t\t\t\t    \t//if ((int)($totalQtyTaken) >= (int)($totalQty)) {","\t\t\t    \t\tif ($qtyLeft == 0) {","\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>此单已收满！</span><br>\";","\t\t\t\t    \t} else if ($qtyLeft < 0){","\t\t\t\t    \t\techo $orderInfoGeneral . \"<span style='color: red; font-size:20px'>此单已超收\" . (int)$qtyLeft * (-1) . \"单！</span><br>\";","\t\t\t\t    \t} else {","\t\t\t\t    \t\t//$qtyLeftNeeded = (int)($totalQty) - (int)($totalQtyTaken);","\t\t\t\t    \t\t//echo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeftNeeded . \"</span>单。<br>\";","\t\t\t\t    \t\techo $orderInfoGeneral . \"此单还可收<span style='color: red; font-size:20px'>\" . $qtyLeft . \"</span>单。<br>\";","\t\t\t\t    \t}","\t\t\t\t    \t/*echo \"DEBUG2\";","\t\t\t\t    \techo \"oldOrderId第一次：\";","\t\t\t\t    \techo $oldOrderId;","\t\t\t\t    \techo \"CAONIMA0\";*/","\t\t\t\t    \techo \"<table><tr><th>护士</th><th>QQ</th><th>等待下单数量</th><th>请求时间</th></tr>\";","\t\t\t\t    \t//echo \"CAONIMA\";","\t\t\t\t    \t$userId = $row[\"userId\"];","\t\t\t\t    \t$sql3 = \"SELECT * FROM users WHERE userId='$userId'\";","\t\t\t\t    \t$stmt3 = $pdo->prepare($sql3);","\t\t\t\t    \t$stmt3->execute();","\t\t\t\t    \tif($row3 = $stmt3->fetch()){","\t\t\t\t    \t\t$userName = $row3[\"userName\"];","\t\t\t\t    \t\t$userQQ = $row3[\"userQQ\"];","\t\t\t\t    \t}","\t\t\t\t    \t//echo \"CAONIMA2\";","\t\t\t\t    \techo \"<tr><td>\" . $userName . \"</td><td>\" . $userQQ . \"</td><td>\" . $qtyRequested . \"</td><td>\" . $requestedTime . \"</td></tr>\";","\t\t\t\t    \t//echo \"CAONIMA3\";","\t\t\t\t    \t//echo \"前最新setoldOrderId为\". $oldOrderId;","\t\t\t\t    \t$newOldOrderId = $orderId;","\t\t\t\t    \t//echo \"后最新setoldOrderId为\". $oldOrderId;","\t\t\t\t\t}","\t\t\t\t}","\t\t\t\t//echo \"i是\" . $i . \"count是\" . $count . \"<br>\";","\t\t\t\t// 没显示","\t\t\t\tif ($i == $count){","\t\t\t\t\t//echo \"进来哦？？\";","\t\t\t\t\tif (isset($totalQtyRequested)){","\t\t\t\t\t\t//echo \"进来呀？\";","\t\t\t\t\t\techo \"</table><br>\";","\t\t\t\t\t\t//echo \"LAST共请求数量：\" . $totalQtyRequested . \"<br>\";","\t\t\t\t\t\techo \"等待下单总数：\" . $totalQtyRequested . \"<br></div>\";","\t\t\t\t\t} else {","\t\t\t\t\t\t","\t\t\t\t\t}","\t\t\t\t}","\t\t\t}","\t\t    echo \"</table>\";","\t    } else {","\t    \techo \"<h3 style='color: black; font-size:20px; text-align: center'><a id='already-accepted' class='nav-link'>没有新批准的单子</a></h3>\";","\t    }","\t\t","\t    $pdo->commit();","","\t} ","\tcatch(Exception $e){","\t    echo $e->getMessage();","\t    $pdo->rollBack();","\t}","","","?>"]}]]},"ace":{"folds":[],"scrolltop":5501.5,"scrollleft":0,"selection":{"start":{"row":298,"column":5},"end":{"row":298,"column":5},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1492870346357,"hash":"69962b580c5c11f91cf2e9938a330f3b926db8dc"}
