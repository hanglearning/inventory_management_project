<DOCTYPE! html>
<html>
<head>
	<title>æ–°çš„è®¢å•</title>
	<script src="../js/jquery.js" type="text/javascript"></script>
	<script src="../js/moment.js"></script>	
</head>
<body>

	<h1>è¿™é‡Œæœ‰æ–°çš„ğŸ³å¯ä»¥åƒ</h1>
	<h4 class='help-text'>âš ï¸æ³¨æ„ï¼Œè‹¥æ­¤å•é™åˆ¶æ•°é‡ï¼Œè¯·å…ˆè¯·æ±‚ä¸‹å•æ•°é‡ï¼Œå¾…ç¥åŒ»æ‰¹å‡†ã€‚è·å‡†åçš„è®¢å•æŒ‰é’®ä¼šå˜ä¸ºã€æœ•çŸ¥é“äº†ã€‘ï¼Œæ­¤æ—¶æ–¹å¯å®‰å…¨ç¡®è®¤ä¸‹å•ã€‚<br>è¢«æ‹’ç»çš„è®¢å•å°†ä¼šè¢«æ ‡è®°ä¸ºé¾Ÿé€Ÿè®¢å•æ˜¾ç¤ºåœ¨æ‰€æœ‰è®¢å•ä¸­ï¼Œä¸‹æ¬¡âœ‹è¦å¿«å“¦ï¼ï¼ˆä¸‹æ¬¡ç³»ç»Ÿæ›´æ–°äº‰å–åŠ å…¥å®æ—¶Liveæ›´æ–°å‰©ä½™å¯ä¸‹å•æ•°é‡ï¼‰</h4>
	<h4 class='help-text'>âš ï¸æ˜¾ç¤ºä¸ºALL INçš„è®¢å•å¯ä»¥éšä¾¿ä¸‹ã€‚</h4>
	<h4 class='help-text'>âš ï¸è‹¥æœ‰å•ä¸æ˜¾ç¤ºä¸‹å•æŒ‰é’®ï¼Œåˆ™æ­¤å•ä¸ºé™åˆ¶æ•°é‡ä¹‹å•åªä¸è¿‡ç¥åŒ»è¿˜å¹¶æœªæˆªå•ï¼Œæ­¤æ—¶æ­¤è®¢å•åœ¨æœ‰äº›æŠ¤å£«è¢«ç å•å¹¶è¿”å›è®¢å•åè¿˜å¯ä»¥ä¸‹ï¼Œè‹¥è¿˜æƒ³ä¸‹æ­¤å•é‚£å°±è¯·ä½ ç­‰å¾…ç€å¹¶å®‰é™åœ°åšä¸€ä¸ªç¾ç”·/å¥³å­ï¼Œè‹¥ä¸æƒ³ä¸‹äº†å«Œç¢çœ¼å¯ä»¥åˆ é™¤æ­¤è®¢å•ã€‚</h4>
	<div id="echoBackData" style="color: red"></div>
	<div id="totalOrdersNum"></div>
	<div id="ordersTable"><h2 style='text-align:center'>æ­£åœ¨åŠ è½½ã€‚ã€‚ã€‚</h2></div>

</body>
<script type="text/javascript">
	
	$(document).ready(function(){
		//https://jsfiddle.net/chenhang91/Lsemz2xp/
		// So number can be implicitly converted to string if was added to string
		// 041617 73125am 3E Ver 1.1
		function submitQtyForALLIN(_qty, _orderId, _userId){
			if (confirm("è¯·ç¡®è®¤æ•°é‡: " + _qty)){
				$("button[data-qtySubmit-orderId=" + _orderId + "]").replaceWith("<div class='loader'></div>");
				var orderTakenTime = moment().format('YYYY-MM-DD hh:mm:ss');
				var sendData = "orderId=" + _orderId + "&userId=" + _userId + "&qtyTaken=" + _qty + "&orderStatus=1" + "&orderTakenTime=" + orderTakenTime;
				$.ajax({
					method: "post",
					url: "../nursePages/new_orders/orderTaken-for-ALLIN.php?",
					data: sendData,
					success: function(backData){
						$("div[data-take-order-div-orderId=" + _orderId + "]").remove();
						var totalOrders = $("div[class='ongoingOrdersTableList']").length;
						$("#totalOrdersNum").html("æ€»å…±å•æ•°ï¼š" + totalOrders + "ã€‚");
						$("#echoBackData").html(backData);
					}
				});
			} else {
				// Back to the order submit page
			}
		}
		// For limited qty order request
		function requestQty(_qty, _orderId, _userId){
			if (confirm("è¯·ç¡®è®¤æ‰€æŠ¥æ•°é‡: " + _qty)){
				$("button[data-qtyRequest-orderId=" + _orderId + "]").replaceWith("<div class='loader'></div>");
				//The above line is to avoid the repeated submit by customer due to delayed back echo
				var orderRequestedTime = moment().format('YYYY-MM-DD hh:mm:ss');
				var sendData = "orderId=" + _orderId + "&userId=" + _userId + "&qtyRequested=" + _qty + "&orderStatus=10" + "&orderRequestedTime=" + orderRequestedTime;
				$.ajax({
					method: "post",
					url: "../nursePages/new_orders/order-request.php?",
					data: sendData,
					success: function(backData){
						alert(backData);
						$("#page-switch").load("../nursePages/new-orders.html");
					}
				});
			} else {
				// Back to the order submit page
			}
		}
		// For limited qty confirm order
		function confirmQty(_qty, _orderId, _orderTakenId, _qtyCanBeTaken){
			if (confirm("è¯·ç¡®è®¤æ•°é‡: " + _qty)){
				$("button[data-qtyConfirm-orderId=" + _orderId + "]").replaceWith("<div class='loader'></div>");
				var orderTakenTime = moment().format('YYYY-MM-DD hh:mm:ss');
				var sendData = "orderId=" + _orderId + "&orderTakenId=" + _orderTakenId + "&qtyTaken=" + _qty + "&orderStatus=1" + "&orderTakenTime=" + orderTakenTime + "&originalAcceptedQty=" + _qtyCanBeTaken;
				$.ajax({
					method: "post",
					url: "../nursePages/new_orders/orderTaken-confirm-limited.php?",
					data: sendData,
					success: function(backData){
						$("div[data-confirm-order-div-orderId=" + _orderId + "]").remove();
						var totalOrders = $("div[class='ongoingOrdersTableList']").length;
						$("#totalOrdersNum").html("æ€»å…±å•æ•°ï¼š" + totalOrders + "ã€‚");
						$("#echoBackData").html(backData);
					}
				});
			} else {
				// Back to the order submit page
			}
		}
		// Get new orders list
		$.ajax({
			method: "post",
			url: "../nursePages/new_orders/new-orders.php",
			success: function(backData){
				if (backData != ''){
					$("#ordersTable").html(backData);
					$(".confirm-order-div").hide();
				} else {
					$("#ordersTable").html("<h3 style='text-align:center'>æœ¨æœ‰ä»»ä½•è®¢å•</h3><br><img src='../images/poor.jpeg' alt='http://www.u148.net/article/138000.html' style='display: block; margin: 0 auto'>");
				}
				//alert(backData);
				var totalOrders = $("div[class='ongoingOrdersTableList']").length;
				$("#totalOrdersNum").html("æ€»å…±å•æ•°ï¼š" + totalOrders);
				// For ALLIN take-order-button
				$(".take-order-btn").on("click", function(){
					var userId = $(this).attr("data-submit-order-userId");
					var orderId = $(this).attr("data-take-orderId");
					//var qtyLeftNeeded = $(this).attr("data-qtyLeftNeeded");
					/*if (qtyLeftNeeded != "ALL IN"){

						var takeOrderDivHtml = "æˆ‘æƒ³ä¸‹è¿™ä¹ˆå¤š: <input type=text data-qtyInput-orderId='" + orderId + "' required>" +
											" ä¸èƒ½è¶…è¿‡" + qtyLeftNeeded + "å“¦ï¼<br/>" +
											"<button class='qty-submit-btn' data-qtySubmit-orderId='" + orderId + "' type='submit'>è¯·æ±‚æ•°é‡ï¼</button>";
						$("div[data-take-orderId-div=" + orderId + "]").html(takeOrderDivHtml);
					} else {*/
						var takeOrderDivHtml = "æ•°é‡ï¼ˆæ³¨æ„ç»†æ°´é•¿æµï¼Œåˆ«è¢«é»‘åœ°å€ï¼ï¼‰ <input type=text data-qtyInput-orderId='" + orderId + "' required>" + ".<br/>" +
											"<button class='qty-submit-btn' data-qtySubmit-orderId='" + orderId + "' type='submit'>ä¸‹å•ï¼</button>";
						$("div[data-take-orderId-div=" + orderId + "]").html(takeOrderDivHtml);
					//}
					$("button[data-qtySubmit-orderId=" + orderId + "]").on("click", function(){
						var qtySubmit = parseInt($("input[data-qtyInput-orderId=" + orderId + "]").val());
						//if (qtySubmit == NaN)
						//http://stackoverflow.com/questions/30314447/how-do-you-test-for-nan-in-javascript
						//http://stackoverflow.com/questions/2652319/how-do-you-check-that-a-number-is-nan-in-javascript
						if (isNaN(parseInt(qtySubmit))){
							alert("è«æ£ä¹±ï¼Œä½ æ˜¯ğŸ’è¯·æ¥é€—æ¯”çš„å—ï¼Ÿ");
						} else {
							if (qtySubmit == 0) {
								alert("å°±ä¸‹0ä¸ªğŸ¥šï¼Œä½•ä¸ç›´æ¥åˆ é™¤è®¢å•ï¼Ÿä½ è€æˆ‘ï¼ŸğŸ˜’");
							} else if (qtySubmit < 0) {
								alert("ğŸ˜ˆåˆ«ä»¥ä¸ºç¼–ç½‘ç«™çš„äººæ˜¯ä¸ªé€—é€¼å°±å…è®¸ä½ è¿™ä¹ˆèƒ¡æ¥ï¼");
							} else {
								/*if (qtyLeftNeeded != "ALL IN"){
									if (qtySubmit == parseInt(qtyLeftNeeded)){
										alert("WOW!ğŸ˜®ä½ è¦åŒ…åœ†å„¿å•Šï¼");
										submitQtyForALLIN(qtySubmit, orderId, userId);
									} else if (qtySubmit > parseInt(qtyLeftNeeded)){
										alert("ğŸ˜±ä½ èƒƒå£å¤ªå¤§ï¼Œæˆ‘ä¼¤ä¸èµ·ï¼");
									} else {
										submitQtyForALLIN(qtySubmit, orderId, userId);
									}
								} else { //All In */
									submitQtyForALLIN(qtySubmit, orderId, userId);
								//}
							}	
						}
					});
				});
				// request order btn for limited order(non-ALLIN)
				$(".request-order-btn").on("click", function(){
					//alert("debug");
					var userId = $(this).attr("data-request-order-userId");
					var orderId = $(this).attr("data-request-orderId");
					//alert(orderId);
					var qtyLeftNeeded = $(this).attr("data-qtyLeftNeeded");
					var requestOrderDivHtml = "æˆ‘æƒ³ä¸‹è¿™ä¹ˆå¤š: <input type=text data-qtyInput-orderId='" + orderId + "' required>" +
											" ä¸èƒ½è¶…è¿‡" + qtyLeftNeeded + "å“¦ï¼<br/>" +
											"<button class='qty-request-btn' data-qtyRequest-orderId='" + orderId + "' type='submit'>æŠ¥æ•°ï¼</button>";
					$("div[data-request-orderId-div=" + orderId + "]").html(requestOrderDivHtml);
					$("button[data-qtyRequest-orderId=" + orderId + "]").on("click", function(){
						var qtyRequest = parseInt($("input[data-qtyInput-orderId=" + orderId + "]").val());
						if (isNaN(parseInt(qtyRequest))){
							alert("åˆ«é—¹äº†ï¼Œé™åˆ¶æ•°é‡çš„å•è¦çœ‹æ‰‹é€Ÿçš„èµ¶ç´§éº»åˆ©çš„ï¼ğŸ");
						} else {
							if (qtyRequest == 0) {
								alert("æŠ¥æ•°0ä¸ªğŸ¥šï¼Œä½ æ˜¯æƒ³ä¸‹ä¸æƒ³ä¸‹ï¼ŸğŸ˜’");
							} else if (qtyRequest < 0) {
								alert("ä¸æƒ³ä¸‹æ‹‰è’œã€‚ã€‚ã€‚ğŸ˜");
							} else {
								if (qtyRequest == parseInt(qtyLeftNeeded)){
									alert("WOW!ğŸ˜®ä½ è¦åŒ…åœ†å„¿å•Šï¼");
									requestQty(qtyRequest, orderId, userId);
								} else if (qtyRequest > parseInt(qtyLeftNeeded)){
									alert("ğŸ˜±ä½ èƒƒå£å¤ªå¤§ï¼Œæˆ‘ä¼¤ä¸èµ·ï¼");
								} else {
									requestQty(qtyRequest, orderId, userId);
								}
								
							}	
						}
					});
				});
				// For limited take order confirm-order-button
				$(".confirm-order-btn").on("click", function(){
					var userId = $(this).attr("data-confirm-order-userId");
					var orderId = $(this).attr("data-confirm-orderId");//å…¶å®ä¹Ÿä¸éœ€è¦äº†ã€‚ä¸‹æ¬¡æ”¹codeç»Ÿä¸€æ”¹æˆorderTakenIdï¼ŒåŒ…æ‹¬ä¸€äº›Divçš„attrï¼Œæ¯”å¦‚ä¸‹é¢çš„confirmOrderDivHtml // ç­‰ç­‰ï¼Œå…¶å®è¿˜æ˜¯æœ‰ç”¨ï¼Œè¦æ›´æ–°åŸorderçš„totalQtyTaken okã€‚see OBS for time and thinking process
					var orderTakenId = $(this).attr("data-confirm-orderTakenId");
					var qtyCanBeTaken = $(this).attr("data-qty-can-be-taken");
					var confirmOrderDivHtml = "è¯·æœ€ç»ˆç¡®è®¤æ•°é‡: <input type=text data-qtyInput-orderId='" + orderId + "' required>" +
											" ä¸èƒ½è¶…è¿‡" + qtyCanBeTaken + "å“¦ï¼<br/>" +
											"<button class='qty-confirm-btn' data-qtyConfirm-orderId='" + orderId + "' type='submit'>ä¸‹å•ï¼</button>";
					$("div[data-confirm-orderId-div=" + orderId + "]").html(confirmOrderDivHtml);
					$("div[data-confirm-orderId-div=" + orderId + "]").show();
					$("button[data-qtyConfirm-orderId=" + orderId + "]").on("click", function(){
						var qtyConfirm = parseInt($("input[data-qtyInput-orderId=" + orderId + "]").val());
						//if (qtySubmit == NaN)
						//http://stackoverflow.com/questions/30314447/how-do-you-test-for-nan-in-javascript
						//http://stackoverflow.com/questions/2652319/how-do-you-check-that-a-number-is-nan-in-javascript
						if (isNaN(parseInt(qtyConfirm))){
							alert("å¥½ä¸å®¹æ˜“æŠ¢åˆ°çš„å•ï¼Œä½ è¿™æ˜¯ä¸æƒ³ä¸‹äº†å—ï¼ŸğŸ’");
						} else {
							if (qtyConfirm == 0) {
								alert("å¥½ä¸å®¹æ˜“æŠ¢åˆ°çš„å•ï¼Œç«Ÿç„¶å°±ä¸‹0ä¸ªğŸ¥šï¼Œä½•ä¸ç›´æ¥åˆ é™¤è®¢å•ï¼ŸğŸ˜’");
							} else if (qtyConfirm < 0) {
								alert("ğŸ˜ˆåˆ«ä»¥ä¸ºç¼–ç½‘ç«™çš„äººæ˜¯ä¸ªé€—é€¼å°±å…è®¸ä½ è¿™ä¹ˆèƒ¡æ¥ï¼");
							} else if (qtyConfirm > parseInt(qtyCanBeTaken)){
								alert("ğŸ˜±ä½ èƒƒå£å¤ªå¤§ï¼Œæˆ‘ä¼¤ä¸èµ·ï¼");
							} else {
								confirmQty(qtyConfirm, orderId, orderTakenId, qtyCanBeTaken);
							}	
						}
					});
				});
				
				//Give up confirmed order btn
				$(".giveup-confirmed-order-btn").on("click", function(){
					var userId = $(this).attr("data-giveup-confirmed-userId");
					var givedUpOrderId = $(this).attr("data-giveup-confirmed-orderId");
					var profitPerItem = $(this).attr("data-give-up-profit");
					var givedUpQty = $(this).attr("data-giveup-qty");
					if(confirm("çš‡ï¼Œå¥½ä¸å®¹æ˜“æŠ¢åˆ°çš„èµš$" + profitPerItem + "çš„æœºä¼šï¼Œå’‹å°±ä¸è¦äº†å‘¢ï¼Ÿç¡®å®šå—ï¼Ÿ\n (è¯·æ³¨æ„ç›®å‰çš„ç³»ç»Ÿå•Šçš‡ä½ æ— æ³•é‡æ–°é¢†ä»»åŠ¡ï¼Œæ”¾å¼ƒå³ä¸ºæ”¾å¼ƒï¼Œä»¥åå‡çº§ä¸­ä½ ä¾¿å¯é‡æ–°ç”³é¢†ä»»åŠ¡ã€‚)")){
						$(this).replaceWith("<div class='loader'></div>");
						//$("div[data-take-order-div-orderId=" + deleteOrderId + "]").remove();
						var sendData = "orderId=" + givedUpOrderId + "&userId=" + userId + "&givedUpQty=" + givedUpQty +
							"&orderStatus=13";
							$.ajax({
								method: "post",
								url: "../nursePages/new_orders/orderGivedUp.php?",
								data: sendData,
								success: function(backData){
									alert(backData);
									$("#page-switch").load("../nursePages/new-orders.html");
									/*
									//041017 61152am 3E ç´§æ¥ç€æ”¹å®Œä¸Šä¸€ä¸ªbtnæµ‹è¯•å‘ç°è¿™ä¸€ä¸ªä¹Ÿå¾—æ”¹
									//041617 75908am 3E ??æ”¹äº†æ²¡æœ‰å•Šï¼Ÿ
									$("div[data-take-order-div-orderId=" + deleteOrderId + "]").remove();
									var totalOrders = $("div[class='ongoingOrdersTableList']").length;
									$("#totalOrdersNum").html("æ€»å…±å•æ•°ï¼š" + totalOrders + "ã€‚");
									$("#echoBackData").html(backData);*/
								}
							});
					} else {
						// Do nothing
					}
				});
				
				$(".delete-order-btn").on("click", function(){
					var userId = $(this).attr("data-delete-order-userId");
					var deleteOrderId = $(this).attr("data-delete-orderId");
					var profitPerItem = $(this).attr("data-give-up-profit")
					if(confirm("ä½ ç¡®å®šè¦æ”¾å¼ƒèµš$" + profitPerItem + "çš„æœºä¼š?\n (è¯·æ³¨æ„ç›®å‰çš„ç³»ç»Ÿä¸­ä½ æ— æ³•é‡æ–°é¢†ä»»åŠ¡ï¼Œæ”¾å¼ƒå³ä¸ºæ”¾å¼ƒï¼Œä»¥åå‡çº§ä¸­ä½ ä¾¿å¯é‡æ–°ç”³é¢†ä»»åŠ¡ã€‚)")){
						$(this).replaceWith("<div class='loader'></div>");
						//$("div[data-take-order-div-orderId=" + deleteOrderId + "]").remove();
						var sendData = "orderId=" + deleteOrderId + "&userId=" + userId + "&qtyTaken=0" +
							"&orderStatus=13";
							$.ajax({
								method: "post",
								url: "../nursePages/new_orders/orderDeleted.php?",
								data: sendData,
								success: function(backData){
									//041017 61152am 3E ç´§æ¥ç€æ”¹å®Œä¸Šä¸€ä¸ªbtnæµ‹è¯•å‘ç°è¿™ä¸€ä¸ªä¹Ÿå¾—æ”¹
									//041617 75908am 3E ??æ”¹äº†æ²¡æœ‰å•Šï¼Ÿ
									$("div[data-take-order-div-orderId=" + deleteOrderId + "]").remove();
									var totalOrders = $("div[class='ongoingOrdersTableList']").length;
									$("#totalOrdersNum").html("æ€»å…±å•æ•°ï¼š" + totalOrders + "ã€‚");
									$("#echoBackData").html(backData);
								}
							});
					} else {
						// Do nothing
					}
				});
			}
		});
	});
</script>
</html>