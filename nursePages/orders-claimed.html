<DOCTYPE! html>
<html>
<head>
	<Title>æˆ‘é¢†åˆ°çš„è®¢å•</Title>
	<script src="../js/jquery.js" type="text/javascript"></script>
</head>
	<body>
		<h1>ğŸ˜è¿™é‡Œçš„è®¢å•éƒ½æ˜¯æˆ‘æŠ¢åˆ°çš„ğŸ‘</h1>
		<h4>âš ï¸æ³¨æ„ï¼šå¦‚æœä½ å·²ç»æˆåŠŸçš„ä¸‹å‡ºæ¥äº†ä½ çš„è›‹é‚£ä¹ˆè¯·ä½ æ”¶åˆ°çš„è´§çš„æ—¶å€™ç‚¹å‡»[ç¡®è®¤æ”¶è´§]ã€‚</h4>
		<h4>âš ï¸ç‚¹å‡» [ä¿®æ”¹æ•°é‡] å¦‚æœä½ å‘ç°ä½ å…¶å®ä¸‹ä¸å‡ºæ¥è¿™ä¹ˆå¤šè›‹ï¼Œæ¯”å¦‚ä¿¡ç”¨å¡æˆ–è€…åœ°å€é™åˆ¶çš„åŸå› ã€‚ç›®å‰åªèƒ½å¾€å°‘é‡Œæ”¹ã€‚</h4>
		<h4>âš ï¸ç‚¹å‡» [æ”¾å¼ƒè®¢å•] å¦‚æœä½ å‘ç°ä½ æ— æ³•ä¸‹å‡ºè¿™äº›è´§æ¥ã€‚æ²¡å…³ç³»ï¼Œå¸¸åœ¨æ²³è¾¹èµ°å“ªæœ‰ä¸æ¹¿é‹ï¼Œè¿™ä¸ªè®¢å•å°†ä¼šè¢«æ ‡è®°ä¸ºExceptionè€Œä¸”æ•°é‡ä¼šåŠ å›åŸæ¥çš„æ”¶è´§æ•°é‡ï¼Œç»™å¹´è½»äººä¸€ä¸ªæœºä¼šå§ï¼</h4>
		<h4>âš ï¸ç‚¹å‡» [å…³é—­è®¢å•] å¦‚æœä»»ä½•æ—¶å€™ä½ å‘ç°ä½ è¢«ç å•ï¼Œä¸¢å•æˆ–ä»»ä½•éä½ æœ¬äººåŸå› å¯¼è‡´çš„ä¸‹å•åè´§ç‰©æ²¡æœ‰æ”¶åˆ°ã€‚è¯·ä¸€å®šæ³¨æ„ç”³è¯·é€€æ¬¾ï¼ï¼ï¼</h4>
		<div id="totalOrdersNum"></div>
		<div id=claimed-orders-div></div>
	</body>
	<script>
		$(document).ready(function(){
			$.ajax({
				method: "post",
				url: "../nursePages/orders_claimed/orders-claimed.php",
				success: function(backData){
					$("#claimed-orders-div").html(backData);
					var totalOrders = $("div[class='claimedOrdersTableList']").length;
					$("#totalOrdersNum").html("æ€»å…±å•æ•°ï¼š" + totalOrders + "ã€‚");
					$(".order-change-qty-div").hide();
					// PHP back order-confirm-btn
					$(".order-confirm-btn").on("click", function(){
						var orderId = $(this).attr("data-confirm-orderId");
						var userId = $(this).attr("data-confirm-order-userId");
						var qtyTaken = $(this).attr("data-qty-taken-confirm");
						var orderTakenId = $(this).parent().attr("data-confirm-order-div-orderTakenId");
						if (confirm("è¯·ç¡®è®¤ä½ æ”¶åˆ°äº†å…¨éƒ¨æ•°é‡ " + qtyTaken + " ä¸ªè´§ç‰©äº†ï¼")){
							$("div[data-confirm-order-div-orderId=" + orderId + "]").remove();
							var sendData = "orderId=" + orderId + "&userId=" + userId + "&orderTakenId=" + orderTakenId + "&orderStatus=2";
							$.ajax({
								// Cannot directly write php here since:
								//http://stackoverflow.com/questions/21651701/writing-php-inside-javascript-function
								//php is executed before the page is sent to the client. you have to make a second php script containing the function. 
								method: "post",
								url: "../nursePages/orders_claimed/arrival-confirmed.php?",
								data: sendData,
								success: function(backData){
									alert(backData);
								}
							});
						}
					});
					// PHP back order-change-qty-btn
					$(".order-change-qty-btn").on("click", function(){
						var orderId = $(this).attr("data-change-qty-orderId");
						var userId = $(this).attr("data-change-qty-userId");
						var originalQtyTaken = $(this).attr("data-qty-taken");
						var orderTakenId = $(this).parent().attr("data-confirm-order-div-orderTakenId");
						var orderChangeDivHtml = "æ›´æ”¹æ•°é‡ä¸º<input data-change-qty-orderId-input=" + orderId + " type='text'><br/>" + "<span>ä¸èƒ½è¶…è¿‡ " + originalQtyTaken + "ã€‚</span>" +
							"<button data-change-qty-orderId-btn=" + orderId + " type='submit'>æäº¤</button>" +
							"<button data-change-qty-cancel-orderId-btn=" + orderId + ">ä¿ºä¸æ”¹äº†</button>";
						$("div[data-order-change-qty-div-orderId=" + orderId + "]").html(orderChangeDivHtml);
						$("div[data-order-change-qty-div-orderId=" + orderId + "]").show();
						$("button[data-change-qty-orderId-btn=" + orderId + "]").on("click", function(){
							var qtyChangeTo = $("input[data-change-qty-orderId-input=" + orderId + "]").val();
							if(parseInt(qtyChangeTo) < 1){
								alert("ğŸ˜ˆåˆ«ä»¥ä¸ºç¼–ç½‘ç«™çš„äººæ˜¯ä¸ªé€—é€¼å°±å…è®¸ä½ è¿™ä¹ˆèƒ¡æ¥ï¼");
							} else if(parseInt(qtyChangeTo) <  parseInt(originalQtyTaken)){
								var cutOrdersNum = parseInt(originalQtyTaken) - parseInt(qtyChangeTo);
								if(confirm("è¯·ç¡®è®¤æ›´æ”¹æ•°é‡ä¸º" + qtyChangeTo + "ã€‚\næ„å‘³ç€ä½ å°†å°‘ä¸‹" + cutOrdersNum + "å•ã€‚")){
									var sendData = "orderId=" + orderId + "&userId=" + userId + "&qtyTaken=" + qtyChangeTo + "&cutOrdersNum=" + cutOrdersNum + "&orderTakenId=" + orderTakenId;
									$.ajax({
										method: "post",
										url: "../nursePages/orders_claimed/claimed-qty-change.php?",
										data: sendData,
										success: function(backData){
											alert(backData);
										}
									});
								} else {
									// Do nothing
								}
							} else {
								alert("å¦®è¨çš®ï¼ä½ çœ‹çœ‹ " + originalQtyTaken + " æ¯” " + qtyChangeTo + " å¤§ï¼Ÿä½ æ•°å­¦æ˜¯ä½“è‚²è€å¸ˆæ•™çš„å§å“ˆå“ˆå“ˆå“ˆå“ˆï¼");
							}
						});
						$("button[data-change-qty-cancel-orderId-btn=" + orderId + "]").on("click", function(){
							$("div[data-order-change-qty-div-orderId=" + orderId + "]").hide();
						});
						
					});
					// PHP back revert-order-btn
					$(".revert-order-btn").on("click", function(){
						var userId = $(this).attr("data-revert-order-userId");
						var orderId =$(this).attr("data-revert-orderId");
						var qtyAddedBack = $(this).attr("data-revert-qty");
						var sentData = "userId=" + userId + "&orderId=" + orderId + "&qtyAddedBack=" + qtyAddedBack;
						if(confirm("ç¡®è®¤æ”¾å¼ƒè®¢å•å—ï¼Ÿ\nè¯·æ³¨æ„ï¼Œä½ æ— æ³•é‡æ–°ç”³é¢†è¿™ä¸ªè›‹è›‹äº†ï¼")){
								$.ajax({
									method: "post",
									url: "../nursePages/orders_claimed/order-revert.php?",
									data: sentData,
									success: function(backData){
										alert(backData);
									}
								});
								$("div[data-confirm-order-div-orderId=" + orderId + "]").remove();
						} else {

						}
					});
					// PHP back close-order-btn
					$(".close-order-btn").on("click", function(){
						var userId = $(this).attr("data-close-order-userId");
						var orderId =$(this).attr("data-close-orderId");
						var qtyAddedBack = $(this).attr("data-close-order-back-qty");
						var closeReason = prompt("è¯·è¾“å…¥å…³é—­è®¢å•çš„åŸå› å¦‚æœä½ ç¡®å®šè¦å…³é—­æ­¤è®¢å•ï¼Œè¿™æ˜¯ä¸Šå®¶çš„éœ€è¦ã€‚\nè¯·æ³¨æ„ä½ æ— æ³•å†é‡æ–°å¼€å¯è¿™ä¸ªè®¢å•ã€‚");
						if(closeReason != null){
							var sentData = "userId=" + userId + "&orderId=" + orderId + "&qtyAddedBack=" + qtyAddedBack + "&orderStatus=8" + "&exceptionNote=" + closeReason;
							$.ajax({
								method: "post",
								url: "../nursePages/orders_claimed/order-close.php?",
								data: sentData,
								success: function(backData){
									alert(backData);
								}
							});
							$("div[data-confirm-order-div-orderId=" + orderId + "]").remove();	
						} else {

						}
					});
				}
			});
		});
	</script>
</html>