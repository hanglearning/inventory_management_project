<DOCTYPE! html>
<html>
<head>
	<Title>Orders Claimed</Title>
	<script src="../js/jquery.js" type="text/javascript"></script>
</head>
	<body>
		<h1>Here are the orders you have claimed.</h1>
		<h4>Note: If you have successfully ordered the items then leave those items there and click 'Confirm' once they arrive. </h4>
		<h4>Click 'Change Qty' if you cannot manage to order the qty you took. Must be less than the original qty you took.</h4>
		<h4>Click 'Revert' if you find yourself have difficulties completing the orders, then this order will be an exception for you and the qty you have taken will be added back to the total qty.</h4>
		<h4>Click 'Close' if at any time you find your order is canceled by manufacture or by any other exception and you will NOT receive the items. Remember to keep an eye on your refund.</h4>
		<div id=claimed-orders-div></div>
	</body>
	<script>
		$(document).ready(function(){
			$.ajax({
				method: "post",
				url: "../nursePages/orders-claimed.php",
				success: function(backData){
					$("#claimed-orders-div").html(backData);
					// PHP back order-confirm-btn
					$(".order-confirm-btn").on("click", function(){
						var orderId = $(this).attr("data-confirm-orderId");
						var userId = $(this).attr("data-confirm-order-userId");
						var qtyTaken = $(this).attr("data-qty-taken-confirm");
						if (confirm("Please confirm that you have received ALL " + qtyTaken + " in this order.")){
							$("div[data-confirm-order-div-orderId=" + orderId + "]").remove();
							var sendData = "orderId=" + orderId + "&userId=" + userId + "&orderStatus=2";
							$.ajax({
								// Cannot directly write php here since:
								//http://stackoverflow.com/questions/21651701/writing-php-inside-javascript-function
								//php is executed before the page is sent to the client. you have to make a second php script containing the function. 
								method: "post",
								url: "../nursePages/arrival-confirmed.php?",
								data: sendData,
								success: function(backData){
									alert(backData);
								}
							});
						}
					});
					// PHP back order-change-qty-btn
					$(".order-change-qty-btn").on("click", function(){
						var orderId = $(this).attr("data-change-qty-orderId");
						var userId = $(this).attr("data-change-qty-userId");
						var originalQtyTaken = $(this).attr("data-qty-taken");
						var orderChangeDivHtml = "Change to<input data-change-qty-orderId-input=" + orderId + " type='text'><br/>" + "<span>Cannot exceed " + originalQtyTaken + ". If you want to order more the function will be added to the future system.</span>" +
							"<button data-change-qty-orderId-btn=" + orderId + " type='submit'>Submit</button>" +
							"<button data-change-qty-cancel-orderId-btn=" + orderId + ">Do not change.</button>";
						$("div[data-order-change-qty-div-orderId=" + orderId + "]").html(orderChangeDivHtml);
						$("div[data-order-change-qty-div-orderId=" + orderId + "]").show();
						$("button[data-change-qty-orderId-btn=" + orderId + "]").on("click", function(){
							var qtyChangeTo = $("input[data-change-qty-orderId-input=" + orderId + "]").val();
							if(parseInt(qtyChangeTo) <  parseInt(originalQtyTaken)){
								var sendData = "orderId=" + orderId + "&userId=" + userId + "&qtyTaken=" + qtyChangeTo;
								$.ajax({
									method: "post",
									url: "../nursePages/claimed-qty-change.php?",
									data: sendData,
									success: function(backData){
										alert(backData);
									}
								});
							} else {
								alert("Do the calculation. Is " + originalQtyTaken + " larger than " + qtyChangeTo + "? LOL!!!")
							}
						});
						$("button[data-change-qty-cancel-orderId-btn=" + orderId + "]").on("click", function(){
							$("div[data-order-change-qty-div-orderId=" + orderId + "]").hide();
						});
						
					});
					// PHP back revert-order-btn
					$(".revert-order-btn").on("click", function(){
						var userId = $(this).attr("data-revert-order-userId");
						var orderId =$(this).attr("data-revert-orderId");
						var qtyAddedBack = $(this).attr("data-revert-qty");
						var sentData = "userId=" + userId + "&orderId=" + orderId + "&qtyAddedBack=" + qtyAddedBack;
						if(confirm("Are you sure you want to give up this order?\nThis order will be marked as closed and you can never take this order again!")){
								$.ajax({
									method: "post",
									url: "../nursePages/order-revert.php?",
									data: sentData,
									success: function(backData){
										alert(backData);
									}
								});
								$("div[data-confirm-order-div-orderId=" + orderId + "]").remove();
						} else {

						}
					});
					// PHP back close-order-btn
					$(".close-order-btn").on("click", function(){
						var userId = $(this).attr("data-close-order-userId");
						var orderId =$(this).attr("data-close-orderId");
						var qtyAddedBack = $(this).attr("data-close-order-back-qty");
						var closeReason = prompt("Please input the exception reason if you are sure to close this order.\nThis order will be marked as closed and you can never take this order again!");
						if(closeReason != null){
							var sentData = "userId=" + userId + "&orderId=" + orderId + "&qtyAddedBack=" + qtyAddedBack + "&orderStatus=8" + "&exceptionNote=" + closeReason;
							$.ajax({
								method: "post",
								url: "../nursePages/order-close.php?",
								data: sentData,
								success: function(backData){
									alert(backData);
								}
							});
							$("div[data-confirm-order-div-orderId=" + orderId + "]").remove();	
						} else {

						}
					});
				}
			});
		});
	</script>
</html>