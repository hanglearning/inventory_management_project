<?php

	session_start();
	$userId			= $_SESSION['userId'];
	$userEmail 		= $_SESSION['userEmail'];
	$userName 		= $_SESSION['userName'];
	$userPhone 		= $_SESSION['userPhone'];
	$userQQ 		= $_SESSION['userQQ'];
	$userWeChat 	= $_SESSION['userWeChat'];
	$userReferred 	= $_SESSION['userReferred'];

	function makeLink($url)
	{
		return ("<a href=" . $url . " target='_blank'>" . $url . "</a>");
	}

	$pdo = new PDO('mysql:host=localhost;dbname=chenh057_realPro', 'chenh057_hang01', 'mindfreak', array(
	    PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
	    PDO::ATTR_EMULATE_PREPARES => false
	));

	$pdo->beginTransaction();

	try{

		$sql = "SELECT * FROM sentrequestbynurse WHERE userId = '$userId' AND confirmPaidByNurseAndComplete = '1' ORDER BY requestDateAndTime DESC";
	    //$sql = "SELECT * FROM orders WHERE closed = :closed";
	    $stmt = $pdo->prepare($sql);
	    $stmt->execute();
	    
	    $requestSequence = 1;

	    $totalTotalProfit = 0;

	    while ($row = $stmt->fetch()){
	    	$sentReqId = $row["sentReqId"];
	    	$bankNote = $row["bankNote"];
	    	$lastModifiedTime = $row["lastModifiedTime"];
	    	echo "<div sent-payment-requested-div-for-sentReqId='$sentReqId'>";
	    	echo "<p class='flex'><span>å®Œæˆåºå·:" . $requestSequence . "</span><span>ç¡®è®¤å®Œæˆæ—¶é—´: " . $lastModifiedTime . "</span></p>";
	    	echo "<table><tr><th>è´§å“åç§°</th><th>é“¾æ¥</th><th>æ•°é‡</th><th>å•ä¸ªåˆ©æ¶¦</th><th>å•ä¸ªæ”¶ä»·</th><th>æ€»åˆ©æ¶¦</th><th>æ€»æ”¶ä»·</th><th>ä¸ªäººå¤‡æ³¨</th></tr>";
	    	$orderTakenArray = $row["orderTakenArray"];
	    	$paymentRequestedOrdersTakenIdContained = explode(",", $orderTakenArray);
	    	$numOfOrdersOfPaymentRequested = count($paymentRequestedOrdersTakenIdContained);
	    	//è¦ç”¨for loopï¼Œè¿™ä¸ªfor loopå¯ä»¥ä»sent-delivery-request.phpå€Ÿæ¥ï¼Œæ¯•ç«Ÿè¿™ä¹Ÿæ˜¯ä¸Šä¸€ä¸ªè¿‡ç¨‹è¿‡æ¥çš„ï¼Œæ‰€ä»¥è¿ç€éƒ½éœ€è¦å·®ä¸å¤šçš„codeåŠŸèƒ½æ¶æ„
	    	$bigTotalProfit = 0;
	    	$bigTotalReceivingPrice = 0;
	    	for($i = 0; $i < $numOfOrdersOfPaymentRequested; $i++) {
	    		$orderTakenId = $paymentRequestedOrdersTakenIdContained[$i];
			    $sql2 = "SELECT * FROM orderTaken WHERE orderTakenId='$orderTakenId'";
			   	$stmt2 = $pdo->prepare($sql2);
		    	$stmt2->execute();
		    	//Using if since there is only one row for a specific orderTakenId
		    	if ($row2 = $stmt2->fetch()){
		    		$orderId  = $row2["orderId"];
		    		$qtyTaken = $row2["qtyTaken"];
		    		$selfNote = $row2["selfNote"];
		    		$sql3 = "SELECT * FROM orders WHERE orderId='$orderId'";
			   		$stmt3 = $pdo->prepare($sql3);
		    		$stmt3->execute();
		    		if ($row3 = $stmt3->fetch()){
		    			$itemName 			= $row3["itemName"];
		    			$itemLink 			= makeLink($row3["itemLink"]);
		    			$itemCost 			= $row3["itemCost"];		
		    			$profitPerItem 		= $row3["profitPerItem"];
		    			$itemReceivingPrice = $row3["itemReceivingPrice"];
		    			$orderNote 			= $row3["orderNote"];
		    		}
		    	}
		    	$smallTotalProfit 			= (int)$qtyTaken * (float)$profitPerItem;
		    	$smallTotalReceivingPrice 	= (int)$qtyTaken * (float)$itemReceivingPrice;
		    	$bigTotalProfit 		+= $smallTotalProfit;
		    	$bigTotalReceivingPrice += $smallTotalReceivingPrice;
		    	$tableRow = "<tr><td>" . $itemName . "</td><td>" . $itemLink . "</td><td>" . $qtyTaken . "</td><td>" . $profitPerItem . "</td><td>" . $itemReceivingPrice . "</td><td>" . $smallTotalProfit . "</td><td>" . $smallTotalReceivingPrice .  "</td><td>" . $selfNote .  "</td></tr>";
		    	echo $tableRow;
			}
			echo "</table>";
			echo "å¤§æ€»åˆ©æ¶¦ï¼š<span style='font-size:40px; color:red'>$" . $bigTotalProfit . "</span> æ€»è¯·æ¬¾é¢ï¼š<span style='font-size:40px; color:red'>$" . $bigTotalReceivingPrice ."</span><br>";
			echo "å›æ¬¾ä¿¡æ¯ï¼š<br>";
			echo $bankNote;
			echo "</div>";
			$totalTotalProfit += $bigTotalProfit;
			$requestSequence++;
	    }
	    echo "<p style='text-align: right'>ğŸ’°æˆ‘èµšäº†é’±äº†èµšé’±äº†æˆ‘éƒ½ä¸çŸ¥é“æ€ä¹ˆå»èŠ± <span style='font-size:40px; color:red'>$" . $totalTotalProfit . "</span></p>";

	    $pdo->commit();

	} 
	//Our catch block will handle any exceptions that are thrown.
	catch(Exception $e){
	    //An exception has occured, which means that one of our database queries
	    //failed.
	    //Print out the error message.
	    echo $e->getMessage();
	    //Rollback the transaction.
	    $pdo->rollBack();
	}


?>
